include:
  - project: infra/common/ci-templates
    ref: master
    file: pipelines/frontend.yml

variables:
  SENTRYCLI_CDNURL: $GITHUB_RELEASES_URL/getsentry/sentry-cli/releases/download
  # pipeline parameters
  VKCS_DOCKERFILE_PATH: Dockerfile
  VKCS_BRANCH_PREVIEW_ENABLED: "true"
  VKCS_DEPLOY_PROD_ENABLED: "false"
  VKCS_DEPLOY_STAGE_ENABLED: "false"
  VKCS_DEPLOY_AMS_ENABLED: "false"

Healthcheck links for branch:
  stage: deploy_stage
  needs:
    - "Build image"
    - "Deploy Branch"
  image: ${DOCKER_REGISTRY_STAGE}/$CI_PROJECT_PATH:$IMAGE_TAG
  script:
    - cd /home/node/app
    - npm run fullHealthyLinks
  variables:
    base404CheckUrl: "https://$CI_COMMIT_REF_SLUG.ingress.infra.devmail.ru"
    NODE_TLS_REJECT_UNAUTHORIZED: 0
  rules:
    - if: $CI_MERGE_REQUEST_ID

Push submodule update:
  stage: .post
  image: ${DOCKER_REGISTRY_EXTERNAL}/nodejs-14
  variables:
    GIT_STRATEGY: none
    HELP_REPOSITORY: infra/front/new-help
  before_script:
    - git config --global user.email "$CI_PROJECT_NAME-bot@corp.mail.ru"
    - git config --global user.name "$CI_PROJECT_NAME-bot"
    - git config --global push.default current
  script:
    - git clone --single-branch --recurse-submodules https://gitlab-ci-token:$CI_JOB_TOKEN@$CI_SERVER_HOST/$HELP_REPOSITORY.git update
    - cd update
    - if [ ! -d "node_modules" ]; then npm i --no-audit --prefer-offline; fi;
    - git submodule update --remote
    - git remote set-url origin "https://$CI_PROJECT_NAME-bot:$NEW_HELP_ACCESS_TOKEN@$CI_SERVER_HOST/infra/front/new-help.git"
    - git add -A
    - git diff-index --quiet HEAD || git commit -m "Submodule update $CI_PROJECT_PATH@$CI_COMMIT_SHORT_SHA"
    - git push -o ci.skip
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  cache:
    key:
      files:
        - update/package-lock.json
        - update/package.json
    paths:
      - update/node_modules/

Deploy to Stage and Prod:
  stage: .post
  needs:
    - "Push submodule update"
  inherit:
    variables: false
  trigger:
    project: infra/front/new-help
    strategy: depend
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
