Развертывание zabbix агента
---------------------------

Zabbix — это ПО для мониторинга приложений, серверов и сетевых устройств. 

Многочисленные предустановленные шаблоны позволяют получать информацию о состоянии множества сервисов. Здесь описаны дополнительно устанавливаемые плагины, которые расширяют возможности сервера мониторинга. Решения совместимы с версиями Zabbix 3.4 и выше.

Установка расширения Zabbix производится на вкладке «Расширения» карточки инстанса базы данных:

![](./assets/helpjuice_production-2fuploads-2fupload-2fimage-2f7055-2fdirect-2f1621916935129-1621916935129.png)

Пользовательские параметры
--------------------------

*   **server** (обязательный параметр) — ip адрес или имя  сервера мониторинга Zabbix.
*   **listen\_port** (default: 10050) — порт Zabbix агента для пассивных проверок.
*   **server\_port** (default: 10051) — порт Zabbix сервера для активных проверок.
*   **b64\_pkcs12\_container** (default: none) — файл в формате PKS#12 без пароля конвертированный в base4 содержащий сертификат удостоверяющего центра,  приватный ключ и сертификат Zabbix агента.
*   **psk** (default: none) — секретный ключ (Pre Shared Key).
*   **zabbix\_agent\_version** (default: 3.4) — версия Zabbix агента (возможные значения 3.4 или 5.0). Параметр доступен для «PostgreSQL» и «PostgreSQL Pro».

Добавить свои параметры и их значения можно на карточке добавления расширения Zabbix:

![](./assets/helpjuice_production-2fuploads-2fupload-2fimage-2f7055-2fdirect-2f1621916984681-1621916984681.png)

Мониторинг PostgreSQL
---------------------

Для мониторинга «PostgreSQL» и «PostgreSQL Pro» вместе с Zabbix агентом версии 3.4 устанавливаются компоненты темплейта  pg\_monz, а версия 5.0 конфигурируется для использования темплейта «PostgreSQL» предустановленного на сервере Zabbix версии 5.0 и выше. 

### Важно

Установка расширения на реплику возможно только в случае если оно установлено на мастере.

### Темплейт pg\_monz

Использование темплейта позволяет получать следующие метрики:

<table style="border:none;border-collapse:collapse;"><tbody><tr style="height:36.75pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.transactions</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p dir="ltr" id="isPasted" style="line-height:1.38;margin-top:13pt;margin-bottom:13pt;">Количество подключений, состояние PostgreSQL, количество коммитов и откатов транзакций.</p></td></tr><tr style="height:22.5pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.log</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p dir="ltr" style="line-height:1.38;margin-top:13pt;margin-bottom:13pt;">Мониторинг лога PostgreSQL.</p></td></tr><tr style="height:22.5pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.size</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p id="isPasted">Коэффициент “мусора”, размер баз данных.</p></td></tr><tr style="height:22.5pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.slow_query</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p dir="ltr" style="line-height:1.38;margin-top:13pt;margin-bottom:13pt;">Счетчик медленных запросов, которые превышают пороговое значение.</p></td></tr><tr style="height:51pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.sr.status</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p dir="ltr" style="line-height:1.38;margin-top:13pt;margin-bottom:13pt;">Количество конфликтов, наличие или отсутствие блокировок записи, количество процессов используемых потоковой репликацией.</p></td></tr><tr style="height:22.5pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.status</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p id="isPasted">Рабочее состояние PostgreSQL.</p></td></tr><tr style="height:22.5pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.stat_replication</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p id="isPasted">Задержка &nbsp;при использовании потоковой репликации.</p></td></tr><tr style="height:22.5pt;"><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 29.3779%;"><p id="isPasted">pg.cluster.status</p></td><td style="border-width: 0.75pt; border-style: solid; border-color: rgb(221, 221, 221); vertical-align: bottom; padding: 4pt; overflow: hidden; overflow-wrap: break-word; width: 70.4873%;"><p id="isPasted">PostgreSQL количественные показатели кластера PostgreSQL.</p></td></tr></tbody></table>

### Для pgpool-II

<table style="width: 100%;"><tbody><tr><td style="width: 30.0539%;"><p id="isPasted">pgpool.cache</p></td><td style="width: 69.8113%;">Информация о кэше запросов pgpool-II в оперативной памяти &nbsp;информация о кэше запросов pgpool-II в оперативной памяти.</td></tr><tr><td style="width: 30.0539%;"><p id="isPasted">pgpool.connections</p><br></td><td style="width: 69.8113%;">Количество внешних и внутренних подключений pgpool-II.</td></tr><tr><td style="width: 30.0539%;"><p id="isPasted">pgpool.log</p></td><td style="width: 69.8113%;">Мониторинг логов pgpool-II.</td></tr><tr><td style="width: 30.0539%;"><p id="isPasted">pgpool.nodes</p></td><td style="width: 69.8113%;">Состояние нод, коэффициент балансировки нагрузки, задержки репликации доступные pgpool-II.</td></tr><tr><td style="width: 30.0539%;"><p id="isPasted">pgpool.status</p></td><td style="width: 69.8113%;">Рабочее состояние pgpool-II, наличие или отсутствие виртуального ip-адреса.</td></tr><tr><td style="width: 30.0539%;"><p id="isPasted">pgpool.watchdog</p></td><td style="width: 69.8113%;">Рабочее состояние pgpool-II, наличие или отсутствие виртуального ip-адреса кластера.</td></tr></tbody></table>

 Для начала использования необходимо [распаковать архив](https://github.com/pg-monz/pg_monz/archive/refs/tags/2.2.tar.gz) и импортировать темплейты из директории /pg\_monz-2.2/pg\_monz/template/ на Zabbix сервере.

### Темплейт PostgreSQL

Использование темплейта позволяет получать следующие метрики:

<table style="width: 100%;"><tbody><tr><td style="width: 30.7278%;"><p id="isPasted">bgwriter&nbsp;</p></td><td style="width: 69.1374%;"><span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Состояние процесса теневой записи: метрики обработки буфферов и чекпойнтов.</span><br></td></tr><tr><td style="width: 30.7278%;"><p id="isPasted">connections&nbsp;</p></td><td style="width: 69.1374%;"><span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Информация о состоянии подключений.</span><br></td></tr><tr><td style="width: 30.7278%;"><p id="isPasted">replications&nbsp;</p></td><td style="width: 69.1374%;"><span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Статус репликации.</span><br></td></tr><tr><td style="width: 30.7278%;"><p id="isPasted">transactions&nbsp;</p></td><td style="width: 69.1374%;"><span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Сведения о времени выполнения транзакций.</span><br></td></tr><tr><td style="width: 30.7278%;"><p id="isPasted">WAL&nbsp;</p></td><td style="width: 69.1374%;">З<span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">аписано байт, количество сегментов.</span></td></tr><tr><td style="width: 30.7278%;"><p id="isPasted">status&nbsp;</p></td><td style="width: 69.1374%;"><span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Общие сведения о сервере.</span><br></td></tr><tr><td style="width: 30.7278%;">db<br></td><td style="width: 69.1374%;"><span id="isPasted" style="color: rgb(56, 76, 96); font-family: sans-serif; font-size: 16px; font-style: normal; font-variant-ligatures: normal; font-variant-caps: normal; font-weight: 400; letter-spacing: normal; orphans: 2; text-align: left; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); text-decoration-thickness: initial; text-decoration-style: initial; text-decoration-color: initial; display: inline !important; float: none;">Метрики по каждой базе данных: запросы, кортежы, deadlocks, rollbacks, размер.</span><br></td></tr></tbody></table>

В версии 5.0 и выше темплейт предустановлен на сервере.

### Важно

Макросы {$PG.HOST}, {$PG.PORT}, {$PG.USER} переопределяются на стороне агента и их изменение на сервере zabbix не будет иметь эффекта.

### Мониторинг MySQL

Для мониторинга MySQL вместе с агентом Zabbix устанавливаются компоненты темплейта [mysbix](https://github.com/sergiotocalini/mysbix), который позволяет собирать перечисленные ниже метрики:

<table border="1" cellpadding="0" cellspacing="0" width="468"><tbody><tr><td valign="bottom" width="35.8974358974359%"><p>mysql status</p></td><td valign="bottom" width="64.1025641025641%"><p>версия БД, идентификатор, состояние, непрерывное время работы</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>connections status</p></td><td valign="bottom" width="64.1025641025641%"><p>ошибки связи и прерванные соединения</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>traffic</p></td><td valign="bottom" width="64.1025641025641%"><p>получено/отправлено, байт в секунду&nbsp;</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>temporary objects usage</p></td><td valign="bottom" width="64.1025641025641%"><p>использование временных файлов, таблиц и таблиц на дисках&nbsp;</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>keys usage</p></td><td valign="bottom" width="64.1025641025641%"><p>количество записей, чтений, использование блоков и кэша&nbsp;MyISAM</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>operations count</p></td><td valign="bottom" width="64.1025641025641%"><p>Операций в секунду &nbsp;для begin,commit,delete,insert,rollback,select,update</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>queries</p></td><td valign="bottom" width="64.1025641025641%"><p>Количество запросов в секунду и медленных запросов</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>table locks</p></td><td valign="bottom" width="64.1025641025641%"><p>Количество немедленных и ожидаемых блокировок таблиц</p></td></tr><tr><td valign="bottom" width="35.8974358974359%"><p>threads count</p></td><td valign="bottom" width="64.1025641025641%"><p>Количество работающих, созданных подключенных и кэшированных потоков</p></td></tr></tbody></table>

Для начала использования [импортируйте](https://www.zabbix.com/documentation/current/ru/manual/xml_export_import/templates#%D0%B8%D0%BC%D0%BF%D0%BE%D1%80%D1%82) темплейт [https://raw.githubusercontent.com/sergiotocalini/mysbix/master/zbx3.4\_template\_db\_mysql.xml](https://raw.githubusercontent.com/sergiotocalini/mysbix/master/zbx3.4_template_db_mysql.xml).

### Важно

В некоторых версиях Zabbix server может быть уже установлен темплейт с таким же именем. Рекомендуется перед импортом изменить имя темплейта в xml файле на уникальное, чтобы избежать коллизий.

Мониторинг Galera
-----------------

Для мониторинга Galera вместе с агентом Zabbix устанавливаются компоненты темплейта [zabbix-galera-template](https://github.com/MogiePete/zabbix-galera-template), который позволяет собирать перечисленные ниже метрики:

<table border="1" cellpadding="0" cellspacing="0" width="523"><tbody><tr><td valign="bottom" width="34.41682600382409%"><p>cluster information</p></td><td valign="bottom" width="65.5831739961759%"><p>идентификатор кластера, количество членов</p></td></tr><tr><td valign="bottom" width="34.41682600382409%"><p>cluster member status</p></td><td valign="bottom" width="65.5831739961759%"><p>готовность, состояние подключения к кластеру, состояние протокола EVS, идентификатор групповой связи, номер последней транзакции</p></td></tr><tr><td valign="bottom" width="34.41682600382409%"><p>cluster member performance</p></td><td valign="bottom" width="65.5831739961759%"><p>события потока управления и состояние очередей запросов</p></td></tr><tr><td valign="bottom" width="34.41682600382409%"><p>replication counters</p></td><td valign="bottom" width="65.5831739961759%"><p>количественные показатели реплицированных данных и ключей</p></td></tr></tbody></table>

Для начала использования [импортируйте](https://www.zabbix.com/documentation/current/ru/manual/xml_export_import/templates#%D0%B8%D0%BC%D0%BF%D0%BE%D1%80%D1%82) темплейт: [https://raw.githubusercontent.com/MogiePete/zabbix-galera-template/master/App-Galera\_Cluster.xml](https://raw.githubusercontent.com/MogiePete/zabbix-galera-template/master/App-Galera_Cluster.xml).

Пример сценария подключения инстансов к серверу мониторинга
-----------------------------------------------------------

1.  Обеспечьте сетевую связность инстанса и сервера мониторинга по портам для активных и пассивных проверок ([подробнее тут](https://www.zabbix.com/documentation/current/ru/manual/appendix/items/activepassive)). 
2.  Определитесь с методом шифрования передаваемых данных (без шифрования, TLS или PSK). При установке Zabbix агента вы можете выбрать оба метода защиты соединения, в таком случае в процессе эксплуатации способ шифрования можно будет изменять меняя конфигурацию подключения только на сервере ([подробнее тут](https://www.zabbix.com/documentation/current/ru/manual/encryption)).
3.  Установите Zabbix агент на инстанс или все экземпляры кластера с желаемыми пользовательскими параметрами. 
4.  Подключите инстансы к Zabbix серверу в разделе Configuration -> Hosts -> Create Hosts ([подробнее тут](https://www.zabbix.com/documentation/5.4/ru/manual/config/hosts/host))

### Важно

Используйте короткое имя инстанса (hostname -s) для значения полей Host name, PSK identity (если используется PSK).

5.  Назначьте темплейт(ы) мониторинга для инстанса или для группы в которую входит инстанс ([подробнее тут](https://www.zabbix.com/documentation/5.4/ru/manual/config/templates/linking))
6.  Через 10 минут убедитесь, что данные от агента поступают на сервер в разделе Monitoring -> Latest Data, отфильтровав содержимое по имени инстанса. Исторические сведения по метрикам вы можете просмотреть там же - в последней колонке.