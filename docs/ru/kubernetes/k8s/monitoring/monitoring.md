Для отслеживания состояния кластера Kubernetes доступны следующие инструменты:

- Встроенные в Kubernetes Dashboard инструменты.

  Они обеспечивают базовые возможности мониторинга, позволяя посмотреть информацию о ресурсах Kubernetes.

- [Аддон мониторинга](../concepts/addons-and-settings/addons#kube_prometheus_stack_2926e986).

  Аддон расширяет возможности мониторинга кластера:

  - Позволяет посмотреть метрики по множеству ресурсов Kubernetes, вплоть до индивидуальных подов.
  - Поддерживает алерты, которые отправляют оповещения при превышении заданных порогов для метрик. Например, можно отследить недоступность ресурсов кластера или нехватку вычислительных мощностей worker-узлов.
  - Позволяет [прогнозировать](#forecast_consumption) потребление ресурсов кластера, просматривать графики прогнозов и заблаговременно получать оповещения о скором исчерпании ресурсов. Прогнозирование доступно только в [версиях аддона](../concepts/versions/components#addony) с доработками от VK Tech (имеют `vk` в номере).

  Чтобы узнать, установлен ли аддон мониторинга в кластере, [посмотрите список установленных аддонов](../instructions/addons/manage-addons#prosmotr_addonov).

## {heading(Использование Kubernetes Dashboard)[id=use_kubernetes_dashboard]}

1. [Подключитесь к кластеру с помощью Kubernetes Dashboard](../connect/k8s-dashboard).
1. Получите данные о ресурсах кластера:

   1. Выберите нужное пространство имен из выпадающего списка вверху интерфейса Kubernetes Dashboard. По умолчанию выбрано пространство имен `default`.
   1. В боковом меню выберите нужный ресурс Kubernetes.

## {heading(Подключение к Grafana для просмотра метрик кластера)[id=connect_grafana]}

1. [Убедитесь](../instructions/addons/manage-addons#prosmotr_addonov), что аддон мониторинга (`kube-prometheus-stack`) [установлен](../instructions/addons/advanced-installation/install-advanced-monitoring) в кластере.

1. [Убедитесь](../connect/kubectl#proverka_podklyucheniya_k_klasteru), что вы можете подключиться к кластеру с помощью `kubectl`.

1. Получите доступ к веб-интерфейсу Grafana:

   1. В отдельной сессии терминала выполните команду:

      ```console
      kubectl -n prometheus-monitoring port-forward service/kube-prometheus-stack-grafana 8001:80
      ```

      {note:warn}

      Не закрывайте эту сессию, иначе доступ к веб-интерфейсу Grafana пропадет.

      {/note}

   1. По выводу команды определите порт, открытый `kubectl` для доступа к Grafana.

      Номер порта указан до символа `→`. Например, из этого вывода следует, что для подключения используется порт `6637`:

      ```text
      Forwarding from 127.0.0.1:6637 -> 3000
      Forwarding from [::1]:6637 -> 3000
      ```

   1. Откройте в браузере URL для доступа к веб-интерфейсу Grafana:

      ```http
      http://localhost:<ПОРТ>/
      ```

      Появится страница входа в Grafana.

1. Выполните вход в Grafana. В зависимости от того, с какими параметрами был [установлен](../instructions/addons/advanced-installation/install-advanced-monitoring) аддон, используйте:

   - Логин `admin` и временный пароль. Пароль необходимо будет сменить после первого входа.
   - Логин `admin` и постоянный пароль из секрета Kubernetes.

Теперь вы можете работать с Grafana. Например, создавать и просматривать дашборды. Преднастроенные дашборды с информацией о различных ресурсах Kubernetes доступны в боковом меню **Dashboards → Browse**.

Подробнее о работе с Grafana в [официальной документации](https://grafana.com/docs/grafana/latest/).

## {heading(Прогнозирование потребления ресурсов кластера)[id=forecast_consumption]}

В аддон мониторинга `kube-prometheus-stack` с доработками от VK Tech встроены алерты для отправки оповещений, если через заданное время прогнозируется исчерпание определенных ресурсов кластера. Этот аддон также предоставляет дашборды в Grafana, на которых отображаются текущие прогнозы потребления ресурсов.

Аддон строит прогнозы [методом линейной регрессии](https://prometheus.io/docs/prometheus/latest/querying/functions/#predict_linear): по значениям метрики, собранным с заданным интервалом в пределах заданного периода, строится линейная функция; прогноз вычисляется как ее значение в будущем через заданное время. Полученное значение выражается в процентах от максимальной емкости ресурса на объекте Kubernetes.

{note:warn}
Прогнозирование не выполняется для объектов master-узлов.
{/note}

1. [Убедитесь](../instructions/addons/manage-addons#prosmotr_addonov), что в кластере [установлена](../instructions/addons/advanced-installation/install-advanced-monitoring) версия аддона мониторинга `kube-prometheus-stack` с доработками от VK Tech (с суффиксом `vk` в номере версии).
1. [Перейдите](../instructions/addons/manage-addons#edit) на страницу редактирования кода аддона `kube-prometheus-stack` и убедитесь, что параметр `grafana.alerts.enabled` в коде равен `true`. Это значение присваивается параметру при установке аддона.
1. Если этот параметр был изменен на `false`, исправьте на `true` и сохраните обновленные настройки.

   {note:warn}
   При отключенном параметре `grafana.alerts.enabled` или других изменениях в коде аддона, несовместимых с настройками по умолчанию, отправка оповещений об исчерпании ресурсов не гарантируется.
   {/note}

1. [Войдите](#connect_grafana) в Grafana.
1. В боковом меню перейдите в раздел **Dashboards**.
1. В списке дашбордов в разделе **VK Cloud** откройте дашборд **K8s Resources Prediction**.
1. Просмотрите доступные прогнозы потребления ресурсов:

   - **CPU Leaders**: прогноз потребления CPU worker-узлами.
   - **Memory Leaders**: прогноз потребления RAM worker-узлами.
   - **Persistent Volume Leaders**: прогноз потребления места на постоянном томе ([PV](../reference/pvs-and-pvcs)).
   - **Inode Leaders**: прогноз потребления индексных дескрипторов (inode) на постоянном томе.

1. (Опционально) Настройте удобное для вас отображение прогнозов с помощью управляющих элементов Grafana.
1. (Опционально) Измените параметры, по которым рассчитываются прогнозы:

   - **Analysis period**: интервал времени до текущего момента, данные которого используются для построения функции прогноза.
   - **Forecast horizon**: интервал между моментом в будущем, для которого рассчитывается прогноз, и текущим моментом.

1. В боковом меню перейдите в раздел **Alerting** → **Alert rules**.
1. В блоке **Grafana** раскройте папку **VK Cloud > K8s Resources Prediction** и просмотрите встроенные алерты исчерпания ресурсов:

   - **K8sNodeCpuPrediction**: на worker-узле нет свободных CPU.
   - **K8sNodeMemoryPrediction**: на worker-узле нет свободной памяти RAM.
   - **K8sPersistentVolumeCapacityPrediction**: на постоянном томе нет свободного места.
   - **K8sPersistentVolumeInodePrediction**: на постоянном томе нет свободных индексных дескрипторов.

   Эти алерты имеют следующие параметры:

   - Глубина анализа данных: `1 неделя`.
   - Интервал, с которым выбираются данные из метрики: `10 минут`.
   - Глубина предсказания: `1 день`.
   - Порог срабатывания алерта: `100%`.

   Изменить параметры встроенных алертов нельзя, но можно создать собственный алерт на основе встроенного.

1. (Опционально) Создайте собственный алерт на основе встроенного:

   1. В списке алертов нажмите кнопку копирования для нужного встроенного алерта, например `K8sNodeCpuPrediction`.
   1. Прочтите предупреждение и нажмите кнопку **Copy**.

      Откроется страница **Add rule**. В разделе **2 Define query and alert condition** под меткой **A** отобразится строка запроса. Для алерта `K8sNodeCpuPrediction` она будет иметь следующий вид:

      ```txt

      predict_linear(avg(instance:node_cpu_utilisation:rate5m * 100  * on(instance) group_left(nodename) node_uname_info{nodename!~".*master.*"}) by (nodename) [1w:10m],86400)

      ```

      Этот запрос содержит значения:

      - `100` — порог срабатывания алерта в процентах;
      - `1w` — глубина анализа данных;
      - `10m` — интервал выбора данных;
      - `86400` — глубина предсказания в секундах.

   1. Измените значения на нужные. Глубина предсказания задается только в секундах, а для глубины анализа и интервала выбора данных возможны [другие единицы измерения](https://prometheus.io/docs/prometheus/latest/querying/basics/#float-literals-and-time-durations).
   1. Настройте другие параметры алерта, как описано в [официальной документации Grafana](https://grafana.com/docs/grafana/latest/alerting/alerting-rules/).
   1. Сохраните изменения.

1. [Настройте](https://grafana.com/docs/grafana/latest/alerting/configure-notifications) доставку оповещений о срабатывании встроенных и собственных алертов.

Настройка прогнозирования завершена.

Теперь вы можете:

- получать оповещения об исчерпании ресурсов;
- при получении оповещения просматривать прогнозы и по другим объектам, чтобы заблаговременно решать потенциальные проблемы;
- просматривать текущие прогнозы и сравнивать их с динамикой потребления, представленной на стандартных дашбордах Grafana;
- по результатам сравнения уточнять параметры прогнозирования и создавать собственные алерты.
