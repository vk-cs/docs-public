## Подготовительные шаги

Подключите в проект сервис [Cloud Logging](/ru/manage/logging), если это еще не сделано. Для этого [обратитесь в техническую поддержку](/ru/contacts).

## Установка аддона

Для аддона доступно [несколько вариантов установки](../../../../concepts/addons-and-settings/addons#osobennosti_ustanovki_addonov):

- стандартная установка;
- быстрая установка.

Вне зависимости от выбранного варианта установки аддон будет установлен в виде [DaemonSet](https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/) на все узлы кластера, включая master-узлы.

Примите во внимание суммарные [максимальные системные требования](../../../../concepts/addons-and-settings/addons) аддонов, которые будут размещены на группах worker-узлов. При необходимости [выполните ручное масштабирование](../../../scale#masshtabirovanie_grupp_worker_uzlov_3e7a5fdf) групп worker-узлов или [настройте автоматическое масштабирование](../../../scale#nastroyka_avtomaticheskogo_masshtabirovaniya_grupp_worker_uzlov_1f8b2c54) перед установкой.

<tabs>
<tablist>
<tab>Стандартная установка</tab>
<tab>Быстрая установка</tab>
</tablist>
<tabpanel>

1. Установите аддон:

   <tabs>
   <tablist>
   <tab>Личный кабинет</tab>
   <tab>Terraform</tab>
   </tablist>
   <tabpanel>

   1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
   1. Выберите проект, где находится нужный кластер.
   1. Перейдите в раздел **Контейнеры → Кластеры Kubernetes**.
   1. Нажмите на имя нужного кластера.
   1. Перейдите на вкладку **Аддоны**.
   1. Если в кластере уже есть установленные аддоны, нажмите на кнопку **Добавить аддон**.
   1. Нажмите кнопку **Установить** на карточке аддона `logaas-integration`.
   1. Выберите нужную версию аддона из выпадающего списка.
   1. При необходимости отредактируйте:

      - выбранную версию;
      - название приложения;
      - название пространства имен, куда будет установлен аддон;
      - [код настройки аддона](#redaktirovanie_koda_nastroyki_addona_pri_ustanovke).

        <warn>

        Некорректно заданный код настройки может привести к ошибкам при установке или неработоспособности аддона.

        </warn>

   1. Нажмите кнопку **Установить аддон**.

      Начнется установка аддона в кластер. Этот процесс может занять длительное время.

   </tabpanel>
   <tabpanel>

   1. [Подготовьтесь к работе с Terraform](/ru/manage/tools-for-using-services/terraform/quick-start), если это еще не сделано.
   1. Добавьте в ваши конфигурационные файлы Terraform, которые описывают кластер:

      - ресурс [vkcs_kubernetes_addon](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/resources/kubernetes_addon.md);
      - источник данных [vkcs_kubernetes_addon](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/data-sources/kubernetes_addon.md);
      - источник данных [vkcs_kubernetes_addons](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/data-sources/kubernetes_addons.md).

      При необходимости адаптируйте приведенные по ссылкам примеры использования ресурсов и источников под свою задачу и конфигурацию Terraform. Например, вы можете отредактировать код настройки аддона, изменив ресурс `vkcs_kubernetes_addon`.

      <warn>
      Некорректно заданный код настройки может привести к ошибкам при установке или неработоспособности аддона.
      </warn>

   1. Убедитесь, что конфигурационные файлы корректны и содержат нужные изменения:

      ```bash
      terraform validate && terraform plan
      ```

   1. Примените изменения:

      ```bash
      terraform apply
      ```

   </tabpanel>
   </tabs>

1. (Опционально) [Просмотрите логи](/ru/manage/logging/service-management/view-logs) в сервисе Cloud Logging, чтобы убедиться в работоспособности аддона.

</tabpanel>
<tabpanel>

<info>

При быстрой установке код настройки аддона не редактируется.

Если это вам не подходит, выполните **стандартную установку**.

</info>

1. Установите аддон:

   <tabs>
   <tablist>
   <tab>Личный кабинет</tab>
   <tab>Terraform</tab>
   </tablist>
   <tabpanel>

   1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
   1. Выберите проект, где находится нужный кластер.
   1. Перейдите в раздел **Контейнеры → Кластеры Kubernetes**.
   1. Нажмите на имя нужного кластера.
   1. Перейдите на вкладку **Аддоны**.
   1. Если в кластере уже есть установленные аддоны, нажмите на кнопку **Добавить аддон**.
   1. Нажмите кнопку **Установить** на карточке аддона `logaas-integration`.
   1. Выберите нужную версию аддона из выпадающего списка.
   1. Нажмите кнопку **Установить аддон**.
   1. При необходимости отредактируйте:

      - выбранную версию;
      - название приложения;
      - название пространства имен, куда будет установлен аддон.

   1. Нажмите кнопку **Установить аддон**.

      Начнется установка аддона в кластер. Этот процесс может занять длительное время.

   </tabpanel>
   <tabpanel>

   1. [Подготовьтесь к работе с Terraform](/ru/manage/tools-for-using-services/terraform/quick-start), если это еще не сделано.
   1. Добавьте в ваши конфигурационные файлы Terraform, которые описывают кластер:

      - ресурс [vkcs_kubernetes_addon](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/resources/kubernetes_addon.md);
      - источник данных [vkcs_kubernetes_addon](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/data-sources/kubernetes_addon.md);
      - источник данных [vkcs_kubernetes_addons](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/data-sources/kubernetes_addons.md).

      При необходимости адаптируйте приведенные по ссылкам примеры использования ресурсов и источников под свою задачу и конфигурацию Terraform.

   1. Убедитесь, что конфигурационные файлы корректны и содержат нужные изменения:

      ```bash
      terraform validate && terraform plan
      ```

   1. Примените изменения:

      ```bash
      terraform apply
      ```

   </tabpanel>
   </tabs>

1. (Опционально) [Просмотрите логи](/ru/manage/logging/service-management/view-logs) в сервисе Cloud Logging, чтобы убедиться в работоспособности аддона.

</tabpanel>
</tabs>

## Редактирование кода настройки аддона при установке

Редактирование кода аддона применимо для стандартной установки.

Полный код настройки аддона вместе с описанием полей доступен:

- в личном кабинете;
- в атрибуте `configuration_values` из источника данных [vkcs_kubernetes_addon](https://github.com/vk-cs/terraform-provider-vkcs/blob/master/docs/data-sources/kubernetes_addon.md), если используется Terraform.

Также на [GitHub](https://github.com/fluent/helm-charts/blob/main/charts/fluent-bit/values.yaml) доступен код настройки Fluent Bit, который служит основой для этого аддона.

<warn>

Не удаляйте поля, которые требуются для корректной установки и работы аддона, или заданные в этих полях значения.

В коде настройки аддона есть комментарии, позволяющие найти такие поля.

</warn>

Подробнее о [пайплайне](https://docs.fluentbit.io/manual/pipeline) (pipeline) и [настройках конфигурационного файла](https://docs.fluentbit.io/manual/administration/configuring-fluent-bit/classic-mode/configuration-file) читайте в официальной документации Fluent Bit.

### Тонкая настройка поведения аддона при работе с разными уровнями критичности

Перед отправкой логов в сервис Cloud Logging аддон выполняет следующие действия:

1. Определяет уровень критичности (severity level) отдельных записей в логах. Это делается с помощью парсеров Fluent Bit ([parsers](https://docs.fluentbit.io/manual/pipeline/filters/parser)).

   <details>
   <summary>Таблица поддерживаемых уровней</summary>

   Уровни отсортированы в порядке возрастания критичности.

   <!-- prettier-ignore -->
   | Уровень | Числовой эквивалент | Расшифровка                     |
   | ------- | ------------------- | ------------------------------- |
   | `DEBUG` | 4                   | Отладочные сообщения            |
   | `INFO`  | 3                   | Информационные сообщения        |
   | `WARN`  | 2                   | Предупреждающие сообщения       |
   | `ERROR` | 1                   | Сообщения об ошибках            |
   | `FATAL` | 0                   | Сообщения о критических ошибках |

   </details>

1. Добавляет в логи дополнительные метаданные, что облегчает работу с логами кластеров Cloud Containers (например, поиск нужных логов в Cloud Logging). Для этого применяются специальные фильтры Fluent Bit (filters), [написанные на языке Lua](https://docs.fluentbit.io/manual/pipeline/filters/lua). Эти метаданные содержат, в том числе, уровень критичности логируемых событий.

   <details>
   <summary>Подробнее про метаданные для определения источника логов</summary>

   Для каждой записи в логах задаются идентификаторы, позволяющие определить источник логов при использовании Cloud Logging:

   - Идентификатор группы ресурсов (`group-id`): имя кластера.
   - Идентификатор ресурса (`stream-id`) в одном из форматов:

     - Для [службы kubelet](https://kubernetes.io/docs/concepts/overview/components/#kubelet): `<имя узла кластера (node)>.<полное имя службы>`.

       **Пример:**

       ```text
       my-cluster-node-0.kubelet.service
       ```

     - Для [пода](../../../../k8s-reference/pods) (pod): `<имя пространства имен (namespace)>.<имя>`.

       Сначала имя ищется в следующих метках (labels):

       - `app.kubernetes.io/instance` ([подробнее о метке](https://kubernetes.io/docs/reference/labels-annotations-taints/#app-kubernetes-io-instance));
       - `app.kubernetes.io/name` ([подробнее о метке](https://kubernetes.io/docs/reference/labels-annotations-taints/#app-kubernetes-io-name));
       - `app`;
       - `k8s-app`.

       Если таких меток нет, то используется имя пода.

       **Пример:**

       Пусть:

       - В пространстве имен `kube-system` есть под с именем `kube-controller-manager-my-cluster-master-0`.
       - Для этого пода задана метка `k8s-app=kube-controller-manager`.

       Тогда идентификатор ресурса будет иметь вид:

       ```text
       kube-system.kube-controller-manager
       ```

   </details>

   <details>
   <summary>Подробнее про другие метаданные с дополнительной информацией о логах</summary>

   Для записей в логах добавляются поля метаданных с дополнительной информацией о логируемом событии, что позволяет выполнять поиск в Cloud Logging в том числе по метаданным логов:

   - `node_name`: имя узла кластера, на котором располагается под или служба kubelet.
   - `severity`: уровень критичности логируемого события (severity level) в текстовом виде.
   - `severity_num`: уровень критичности логируемого события (severity level) в числовом виде.
   - Все поля JSON-сообщения: если логи пишутся в формате JSON, то все поля JSON-сообщения, кроме `msg`, добавляются в виде метаданных.

   </details>

Вы можете выполнить тонкую настройку поведения аддона при работе с уровнями критичности, используя:

<tabs>
<tablist>
<tab>Пользовательские фильтры</tab>
<tab>Пользовательские шаблоны</tab>
</tablist>
<tabpanel>

Задайте в коде аддона одно или несколько правил для пользовательских фильтров `customFilter`, чтобы в Cloud Logging попадали только логи с заданным минимальным уровнем критичности. Эти правила можно настроить на уровне определенного пространства имен и на уровне определенных подов в пространстве имен:

<!-- prettier-ignore -->
```yaml
customFilter:
  - namespace: <имя пространства имен>
    rules: # Одно правило для пространства имен
      - min_level: <буквенное обозначение минимального уровня критичности>
  - namespace: <имя другого пространства имен>
    rules: # Несколько правил для подов в пространстве имен
      - podprefix: <префикс имени пода>
        min_level: <буквенное обозначение минимального уровня критичности>
      - podprefix: <префикс имени другого пода>
        min_level: <буквенное обозначение минимального уровня критичности>
  - namespace: <имя другого пространства имен>
    rules: # Комбинация правила для пространства имен и правил для подов
      - min_level: <буквенное обозначение минимального уровня критичности>
      - podprefix: <префикс имени пода>
        min_level: <буквенное обозначение минимального уровня критичности>
      - podprefix: <префикс имени пода>
        min_level: <буквенное обозначение минимального уровня критичности>
```

Для подов настраивается именно префикс, чтобы можно было получать логи из нескольких подов-реплик, которые относятся к одной рабочей нагрузке ([workload](https://kubernetes.io/docs/concepts/workloads/controllers/)).

<details>
<summary>Примеры</summary>

1. Единственное правило действует на уровне пространства имен `kube-system`.

   В Cloud Logging попадут только те логи из этого пространства имен, которые имеют уровень критичности `WARN` или выше (`ERROR`, `FATAL`).

1. Единственное правило действует на уровне подов, которые находятся в пространстве имен `default`, и чьи имена начинаются с префикса `test-pod`.

   В Cloud Logging попадут только те логи из этих подов, которые имеют уровень критичности `ERROR` или выше (`FATAL`). Фильтрация логов на уровне пространства имен `default` не производится.

1. Несколько правил действуют на уровне пространства имен `my-namespace` и на уровне подов с префиксом `example-pod`, которые находятся в этом пространстве имен.

   В Cloud Logging попадут только перечисленные логи:

   - Логи из пространства имен, которые не относятся к подам с префиксом `example-pod` и имеют уровень критичности `ERROR` или выше (`FATAL`).
   - Логи из подов с префиксом `example-pod`, которые имеют уровень критичности `WARN` или выше (`ERROR`, `FATAL`).

<!-- prettier-ignore -->
```yaml
customFilter:
  - namespace: kube-system
    rules:
      - min_level: WARN
  - namespace: default
    rules:
      - podprefix: test-pod
        min_level: ERROR
  - namespace: my-namespace
    rules:
      - min_level: ERROR
      - podprefix: example-pod
        min_level: WARN
```

</details>

</tabpanel>
<tabpanel>

Задайте в коде аддона одно или несколько правил для пользовательских шаблонов `customRegexp`, чтобы выставлять желаемый уровень критичности для логов в обход стандартных механизмов аддона. Если часть записи в логе совпадает с заданным шаблоном Lua ([pattern](https://www.lua.org/manual/5.4/manual.html#6.4.1)), то этой записи присваивается заданный в правиле уровень критичности. Если совпадений нет, то записи присваивается уровень критичности, определенный с помощью парсеров Fluent Bit. Это может быть полезно, если механизм автоматического определения уровня, который применяется в аддоне, некорректно определяет уровень логов конкретного приложения.

Эти правила действуют на уровне определенного пространства имен и на уровне определенных подов в пространстве имен:

<!-- prettier-ignore -->
```yaml
customRegexp:
  - namespace: <имя пространства имен>
    rules:
    - levels: # Одно правило для пространства имен: настройка нескольких уровней
      - level: <буквенное обозначение желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
      - level: <буквенное обозначение другого желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
  - namespace: <имя другого пространства имен>
    rules: # Несколько правил для подов в пространстве имен: настройка нескольких уровней
    - podprefix: <префикс имени пода> # Первое правило для подов
      levels:
      - level: <буквенное обозначение желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
      - level: <буквенное обозначение другого желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
    - podprefix: <префикс имени другого пода> # Второе правило для подов
      levels:
      - level: <буквенное обозначение желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
  - namespace: <имя другого пространства имен>
    rules:
    - levels: # Первое правило для пространства имен: настройка нескольких уровней
      - level: <буквенное обозначение желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
      - level: <буквенное обозначение другого желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
    - podprefix: <префикс имени пода> # Второе правило для подов: настройка нескольких уровней
      levels:
      - level: <буквенное обозначение желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
      - level: <буквенное обозначение другого желаемого уровня критичности>
        reg_exp: "<шаблон Lua>"
```

Для подов настраивается именно префикс, чтобы можно было получать логи из нескольких подов-реплик, которые относятся к одной рабочей нагрузке ([workload](https://kubernetes.io/docs/concepts/workloads/controllers/)).

<details>
<summary>Примеры</summary>

1. Единственное правило действует на уровне пространства имен `kube-system`.

   Если часть записи лога из этого пространства имен совпадет с заданным шаблоном `[Ww]%d%d%d%d%s+`, то этой записи будет присвоен уровень критичности `ERROR`.

1. Единственное правило действует на уровне подов, которые находятся в пространстве имен `default`, и чьи имена начинаются с префикса `test-pod`.

   Если часть записи лога из этих подов совпадет с заданным шаблоном `this is a plain text message`, то этой записи будет присвоен уровень критичности `WARN`.

1. Несколько правил действуют на уровне пространства имен `my-namespace` и на уровне подов с префиксом `example-pod`, которые находятся в этом пространстве имен.

   Уровни критичности будут присвоены по следующим правилам:

   - Если часть записи лога из этого пространства имен (которая не относится к подам с префиксом `example-pod`) совпадет с заданным шаблоном `[Ww]%s+`, то этой записи будет присвоен уровень критичности `ERROR`.
   - Если часть записи лога из подов с префиксом `example-pod` совпадет с заданным шаблоном `Debug trace`, то этой записи будет присвоен уровень критичности `DEBUG`.

Если никакая часть записи лога не совпадает с указанными шаблонами, то такой записи присваивается уровень критичности, определенный с помощью парсеров Fluent Bit.

<!-- prettier-ignore -->
```yaml
customRegexp:
  - namespace: kube-system
    rules:
    - levels:
      - level: ERROR
        reg_exp: "[Ww]%d%d%d%d%s+"
  - namespace: default
    rules:
    - podprefix: test-pod
      levels:
      - level: WARN
        reg_exp: "this is a plain text message"
  - namespace: my-namespace
    rules:
    - levels:
      - level: ERROR
        reg_exp: "[Ww]%s+"
    - podprefix: example-pod
      levels:
      - level: DEBUG
        reg_exp: "Debug trace"
```

</details>

</tabpanel>
</tabs>
