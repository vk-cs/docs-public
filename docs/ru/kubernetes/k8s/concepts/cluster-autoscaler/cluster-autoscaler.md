В Cloud Containers [автоматическое масштабирование групп worker-узлов](/ru/kubernetes/k8s/concepts/architecture#vozmozhnosti_masshtabirovaniya_klastera) кластеров Kubernetes происходит с помощью инструмента [Cluster Autoscaler](https://github.com/kubernetes/autoscaler/tree/master/cluster-autoscaler#readme). Он постоянно отслеживает нагрузку на worker-узлы кластера и регулирует их количество в заданных пределах в зависимости от потребностей рабочих нагрузок. Основная задача инструмента — обеспечить, чтобы для всех подов в кластере было достаточно [вычислительных ресурсов](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/), и в то же время избежать избыточного выделения мощностей и их простоя. Это помогает обеспечить высокую доступность и производительность приложений, при этом оптимизируя использование ресурсов и затрат на них.

Задачи Cluster Autoscaler в группах worker-узлов:

- создание новых узлов, когда этого требует рабочая нагрузка;
- удаление недозагруженных узлов.

Cluster Autoscaler предустановлен во всех кластерах Kubernetes, которые вы создаете в сервисе Cloud Containers, но по умолчанию не включен. Автоматическое масштабирование worker-узлов нужно включать для каждой группы worker-узлов вручную при [определении ее настроек](/ru/kubernetes/k8s/instructions/helpers/node-group-settings).

## Увеличение количества worker-узлов

Cluster Autoscaler увеличивает количество worker-узлов в группе, когда на существующих узлах не хватает ресурсов для размещения на них подов.

При создании нового пода запрашиваются [ресурсы](/ru/kubernetes/k8s/reference/resource-limiting) — CPU и RAM. Размещая под, планировщик Kubernetes ищет для него узел, который удовлетворяет его ресурсным запросам `resources.requests`, а не лимитам `resources.limits`. То есть планировщик анализирует, хватит ли на узле ресурсов для размещения этого пода. Например, если под запрашивает 100m CPU и 64 МБ RAM, планировщик будет искать для него узел, где осталось хотя бы 100m CPU и 64 МБ RAM. Если ни на одном из существующих узлов кластера нет ресурсов для размещения этого пода по его запросам, Cluster Autoscaler запускает добавление нового узла в группу. 

Добавление узлов возможно только до максимального значения, которое вы задали в настройках группы. Если автоматическое масштабирование включено, но worker-узлы не добавляются, попробуйте решения из раздела [Не добавляются новые узлы при автоматическом масштабировании](/ru/kubernetes/k8s/troubleshooting/cluster-does-not-scale-up).

## Уменьшение количества worker-узлов 

Cluster Autoscaler проверяет нагрузку узлов в кластере и уменьшает их количество, если нагрузка низкая и узлы недозагружены, то есть все поды можно разместить на меньшем количестве узлов. Чтобы недозагруженный worker-узел был удален, Cluster Autoscaler:

1. Запускает процесс вытеснения подов с этого узла.
1. Дожидается, пока эти поды переместятся на другие узлы с достаточными ресурсами.
1. По прошествии установленного времени простоя помечает этот узел [ограничением (taint)](/ru/kubernetes/k8s/reference/labels-and-taints), которое запрещает размещать на нем новые поды и рабочую нагрузку, и запускает его удаление.

   За время простоя узла отвечает параметр `--scale-down-unneeded-time`. Он указывает, как долго узел должен оставаться без подов, прежде чем его можно будет удалить при автоматическом масштабировании.

   Время простоя обеспечивает защиту от случайного удаления узла, если по какой-либо причине поды будут временно отсутствовать (например, из-за кратковременных всплесков нагрузки). В то же время оно позволяет освободить ресурсы, когда узел становится действительно ненужным. 
   
   В Cloud Containers установленное время простоя — 5 минут. Если узел пуст в течение 5 минут (все поды с него вытеснены), и за это время ни один под на этом узле не появляется, Cluster Autoscaler запускает его удаление.

Удаление узлов возможно только до минимального значения, которое вы задали в настройках группы. Если автоматическое масштабирование включено, но worker-узлы не удаляются, попробуйте решения из раздела [Недозагруженные узлы не удаляются при автоматическом масштабировании](/ru/kubernetes/k8s/troubleshooting/cluster-does-not-scale-down).