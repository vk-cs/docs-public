Сервис Cloud Containers обеспечивает среду для работы с кластерами Kubernetes на платформе VK Cloud. Архитектура сервиса, опираясь на [OpenStack](https://www.openstack.org/), дает пользователям широкие возможности для работы, обеспечивает отказоустойчивость, масштабируемость и интеграцию с другими сервисами платформы.

{cut(Схема взаимодействия Cloud Containers с другими компонентами VK Cloud)}

Cloud Containers следит за корректной работой кластеров, в то время как:

- [Cloud Servers](/ru/computing/iaas) управляет ВМ на узлах кластера.
- [Cloud Networks](/ru/networks/vnet) управляет сетями кластера.

![Архитектура сервиса](/ru/kubernetes/k8s/assets/k8s_arch.png){params[noBorder=true; width=50%]}

{/cut}

## Топологии кластера

Кластер Cloud Containers состоит из двух типов узлов (nodes) — master-узлов и worker-узлов:

- Master-узлы хранят информацию о состоянии всего кластера и управляют распределением рабочей нагрузки по worker-узлам. Управление master-узлами пользователям не доступно, оно происходит на стороне платформы VK Cloud.

- Worker-узлы выполняют рабочую нагрузку ([workload](https://kubernetes.io/docs/concepts/workloads/)). Они могут быть организованы в группы worker-узлов. Для повышения отказоустойчивости разместите группы в разных [зонах доступности](/ru/start/concepts/architecture#az). Управление worker-узлами также происходит на стороне платформы VK Cloud, но при этом они имеют сетевую связанность с проектами пользователей. 

Отказоустойчивость кластера зависит от количества master-узлов и их распределения по зонам доступности. Возможные конфигурации:

- Кластер Cloud Containers с одним master-узлом.

  Такой кластер не отказоустойчив: даже если worker-узлов несколько и они организованы в группы, при потере единственного master-узла кластер станет неработоспособен.

   {cut(Схема взаимодействия узлов для кластера с одним master-узлом)}
   ![Кластер с одним master-узлом](/ru/kubernetes/k8s/assets/cluster_types_1.png){params[noBorder=true; width=80%]}
   {/cut}

- Стандартный кластер Cloud Containers из 3 или 5 master-узлов.

  Такой кластер отказоустойчив на уровне зоны доступности: при стабильной работе зоны доступности и потере нескольких master-узлов он сохранит свою работоспособность, пока работает более половины master-узлов. Когда остается один master-узел, кластер перестает работать. 

  {cut(Схема взаимодействия узлов для стандартного кластера)}  
  ![Стандартный кластер](/ru/kubernetes/k8s/assets/cluster_types_2.png){params[noBorder=true; width=80%]}
  {/cut}

- Региональный кластер Cloud Containers из 3 или 5 master-узлов.

  Master-узлы регионального кластера распределяются по всем зонам доступности региона. Такой кластер максимально отказоустойчив: при отказе одной зоны доступности нагрузка будет распределена между master-узлами, которые расположены в других зонах доступности. Однако, как и в стандартных кластерах, региональный кластер сохраняет работоспособность, пока работает более половины master-узлов, и перестает работать, когда остается один master-узел.

  {cut(Схема взаимодействия узлов для регионального кластера)}
  ![Региональный кластер](/ru/kubernetes/k8s/assets/cluster_types_3.png){params[noBorder=true; width=80%]}
  {/cut}

Вне зависимости от выбранной топологии кластера master-узлы используют распределенное хранилище «ключ-значение» [etcd](https://etcd.io/) для хранения информации о состоянии кластера:

- Кластер с одним master-узлом имеет один экземпляр `etcd`.
- В кластерах с несколькими master-узлами есть несколько экземпляров `etcd`, работающих в кластерном режиме для отказоустойчивости.
- Под каждый экземпляр `etcd` выделен отдельный высокопроизводительный SSD-диск (High-IOPS). Это позволяет организовать максимально быстрое взаимодействие с API-эндпоинтом кластера при минимальных задержках.

Для отказоустойчивости на уровне worker-узлов рекомендуется создать несколько групп worker-узлов в разных зонах доступности и размещать реплики приложения на этих узлах так, чтобы реплики тоже были в разных зонах доступности.

## Окружение кластера

На master- и worker-узлах используется операционная система AlmaLinux (начиная с версии Kubernetes 1.31).

Кластер запускает контейнеры через Kubernetes [Container Runtime Interface](https://kubernetes.io/docs/concepts/architecture/cri/) (CRI) с помощью CRI-O.

Подробнее в разделе [Доступные версии Kubernetes и политика поддержки версий](../versions).

## Интеграция с Kubernetes API

Все взаимодействие с кластером происходит через [Kubernetes API](https://kubernetes.io/ru/docs/concepts/overview/kubernetes-api/).

API-эндпоинт кластеров Cloud Containers размещен за [отдельным балансировщиком нагрузки](../network), поэтому доступ к API кластера можно получить по одному и тому же IP-адресу вне зависимости от количества master-узлов.

## Интеграция с платформой VK Cloud

Интеграция с платформой VK Cloud осуществляется через стандартные интерфейсы Kubernetes:

- [Container Storage Interface](https://kubernetes-csi.github.io/docs/) (CSI) — интеграция с сервисами хранения данных.

  Позволяет использовать в кластерах хранилище VK Cloud в виде постоянных томов ([persistent volumes](https://kubernetes.io/docs/concepts/storage/persistent-volumes/)).
  Доступно использование Persistent Volume Claim (PVC).

  Интеграция достигается с помощью OpenStack Cinder API. Подробнее в разделе [Хранилище в кластере](../storage).

- [Container Network Interface](https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/) (CNI) — интеграция с сетевыми сервисами.

  В каждом кластере Cloud Containers присутствует плагин [Calico](https://projectcalico.docs.tigera.io/about/about-calico), поддерживающий этот интерфейс. Этот плагин обеспечивает:

  - сетевую связность между контейнерами, [подами](../../reference/pods) и узлами кластера;
  - применение и соблюдение [сетевых политик](https://kubernetes.io/docs/concepts/services-networking/network-policies/) (Network Policies) Kubernetes.

  Calico интегрируется с платформой VK Cloud с помощью SDN Sprut. Подробнее в разделе [Сеть в кластере](../network).

## Встроенная поддержка Open Policy Agent

В кластеры Cloud Containers встроен [Open Policy Agent Gatekeeper](../../reference/gatekeeper/). Он позволяет применять [политики безопасности](../security-policies) для ресурсов Kubernetes. Также в таких кластерах действуют [политики безопасности по умолчанию](../addons-and-settings/settings#prednastroennye_shablony_i_ogranicheniya_gatekeeper).

## Возможности масштабирования кластера

Кластер Cloud Containers имеет встроенные [возможности масштабирования master-узлов и worker-узлов](../scale).

В том числе поддерживается [автоматическое масштабирование](/ru/kubernetes/k8s/concepts/scale#autoscaling) узлов кластера, при котором количество узлов регулируется автоматически в зависимости от потребностей рабочей нагрузки. Для master-узлов оно включено по умолчанию и его нельзя выключить. Для worker-узлов оно включается вручную при определении [настроек для каждой группы узлов](/ru/kubernetes/k8s/instructions/helpers/node-group-settings).
