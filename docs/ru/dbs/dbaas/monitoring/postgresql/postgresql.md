## Просмотр данных мониторинга

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный инстанс БД.
1. Перейдите в раздел **Базы данных → Инстансы баз данных**.
1. Нажмите на имя узла инстанса БД.
1. Перейдите на вкладку **Мониторинг**.

Будет выведено несколько [счетчиков и графиков](#monitoring_metrics):

- Счетчики отражают текущее значение метрик.
- Графики отражают динамику изменения значений метрик в рамках определенного временного периода.

На счетчиках и графиках отображаются данные за указанный период. По умолчанию — 12 часов.

## Добавление данных мониторинга БД в свои графики

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный инстанс БД.
1. Перейдите в раздел **Базы данных → Инстансы баз данных**.
1. Нажмите на имя узла инстанса БД.
1. Перейдите на вкладку **Мониторинг**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного счетчика или графика и выберите пункт **Добавить в мои графики**.
1. Выберите раздел, в котором будет отображаться счетчик или график, и нажмите **Добавить**.
1. Убедитесь, что счетчик или график добавлен в раздел:

    1. Перейдите в раздел **Мониторинг → Дашборды**.
    1. Перейдите на вкладку **Мои графики**.
    1. Раскройте раздел, на который добавлен счетчик или график.
    1. Убедитесь, что в разделе есть добавленный счетчик или график.

## {heading(Доступные метрики мониторинга)[id=monitoring_metrics]}

### Счетчики

Метрики CPU

[cols="1,3"]
|===
|**Current IOWait**
|Процент от общего количества ресурсов процессора узла, затраченных на ожидание завершения операций ввода-вывода

|**Current CPU**
|Процент времени, в течение которого процессор узла обеспечивает работу инстанса БД и связанной с ним инфраструктуры

|**RAM Used**
|Процент занятой памяти от общего количества памяти на узле

|**Free connections**
|Процент доступных подключений от общего числа

|**PostgreSQL Uptime**
|Время непрерывной работы БД без перезагрузки или остановки в секундах

|**Replication lag**
|Время отставания реплики от источника репликации в секундах. Эта метрика показывается только при просмотре данных мониторинга узлов-реплик
|===

### Графики

Нагрузка на CPU

[cols="1,3"]
|===
|**Database size**
|Объем данных, хранящихся в БД, включая таблицы, индексы, представления и другие объекты

|**CPU IOWait**
|Процент от общего количества ресурсов процессора узла, затраченных на ожидание завершения операций ввода-вывода

|**CPU User**
|Процент времени, в течение которого процессор узла обеспечивает работу инстанса БД и связанной с ним инфраструктуры

|**RAM Used**
|Процент занятой памяти от общего количества памяти на узле
|===

Нагрузка на базу данных

[cols="1,3"]
|===
|**Fetch Data (Select)**
|Интенсивность чтения из базы данных: количество строк, извлеченных в ходе выполнения запросов, в секунду

|**Returned Data**
|Интенсивность ответов от базы данных: количество строк, возвращенных в результате выполнения запросов, в секунду

|**Update Data**
|Интенсивность обновления данных в базе данных: количество строк, измененное запросами `UPDATE`, в секунду

|**Insert Data**
|Интенсивность вставки данных в базу данных: количество строк, вставленное запросами `INSERT`, в секунду

|**Deleted Data**
|Интенсивность удаления данных из базы данных: количество строк, удаленное запросами `DELETE`, в секунду
|===

Нагрузка на дисковую подсистему

[cols="1,3"]
|===
|**Disk Read Time**
|Время, затраченное на операции чтения с диска, в секундах

|**Disk Write Time**
|Время, затраченное на операции записи на диск, в секундах

|**Disk used**
|Процент использованного дискового пространства от общего объема на узле. Отображаются столбчатые диаграммы заполненности некоторых разделов, например связанных с PostgreSQL и журналом транзакций WAL
|===

## Использование сведений мониторинга

Высокие показатели утилизации CPU и оперативной памяти, нагрузки на дисковую подсистему, а также интенсивная или неравномерная нагрузка на базу данных свидетельствуют о высокой нагрузке на узлы или о неоптимальных индексах и запросах.

Воспользуйтесь встроенными инструментами диагностики производительности PostgreSQL от имени администратора БД, например:

- Выполните запросы к системной таблице [pg_stat_activity](https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW), чтобы собрать статистику по выполняющимся запросам.

   Обратите внимание на запросы, которые выполняются дольше всех остальных.

- Воспользуйтесь командой [EXPLAIN](https://www.postgresql.org/docs/current/sql-explain.html) для поиска узких мест в таких медленных запросах.

   Обратите внимание на запросы, не использующие индексы (большое количество строк в `Seq Scan`). [Создайте](https://www.postgresql.org/docs/current/sql-createindex.html) или [обновите](https://www.postgresql.org/docs/current/sql-reindex.html) необходимые индексы.

Низкий процент свободных подключений (**Free connections**) может свидетельствовать как о большом количестве одновременно подключенных клиентов, так и о том, что есть длинные транзакции, которые используют открытое соединение слишком долго.

Оптимизируйте использование ресурсов:

- [Увеличите значение параметра](/ru/dbs/dbaas/instructions/db-config) `max_connections`.
- Оптимизируйте запросы так, чтобы не было длинных транзакций.
- Используйте [PgBouncer](https://www.pgbouncer.org/) для уменьшения нагрузки на сервер и оптимизации использование ресурсов.

При возникновении проблем, связанных с отставанием реплики, обратитесь к официальной документации [Patroni](https://patroni.readthedocs.io/en/latest/replication_modes.html) и [PostgreSQL](https://www.postgresql.org/docs/current/warm-standby.html#STREAMING-REPLICATION).
