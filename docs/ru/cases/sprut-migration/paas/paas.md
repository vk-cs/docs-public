<!-->
## Миграция PaaS

   - Создание резервных копий данных и конфигураций для обеспечения безопасности.
   - Создать новый инстанс PaaS

Общая схема миграции подразумевает создание копии PaaS в сети neutron и переноса нагрузки при помощи встроенных средств бэкапирования. Для простоты решения рекомендуется остановить кластеры на запись, пока выполняется перенос.

<img src="./images/image-2024-7-2_2-53-22.png" width="600">

<img src="./images/image-2024-7-2_2-54-3.png" width="600">

В данной схеме можно использовать продвинутый роутер в качестве связности neutron и sprut.

### Балансировщики нагрузки

- Сервис одинаков для neutron и sprut, но для миграции его необходимо пересоздать, так как у балансировщика нельзя заменить сеть.
- Можно пересоздать в terraform, указав сеть sprut в описании манифеста и подключить виртуальные машины уже после их миграции.
- Можно создать балансировщик вручную и указать вм в правилах.
- Скрипт по созданию копии балансировщика и сназначение всех виртуальных машин [copy-lb-to-sprut-net.sh](/copy-lb-to-sprut-net.sh)

### Публичный DNS

- В связи со сменой плавающих ip необходимо отредактировать текущие A-записи.
- Если используется внешний сервис dns, изменить записи в нём.

### Файловое хранилище NFS/CIFS

Файловое хранилище поддерживает бэкапы, однако их нельзя поднять в сети другого sdn. Необходимо:

1. Создать аналогичное хранилище в sprut сети.
1. Создать вм 1-2 и подключить её к сетям старого и нового хранилищь.
1. Выполнить подключение на вм к обоим хранилищам и запустить rsync и перелить данные в новое хранилище. 

### Kubernetes

1. Создаём аналогичный кластер в новой сети sprut. В случае если в сети помимо кластера kubernetes есть другие сервисы или виртуалки, адрес сети на sprut, где размещён kubernetes должен отличаться от исходного.
1. Переносим нагрузку при помощи средства бэкапирования velero, в том числе pv. Примеры использования velero находятся в инструкции: <https://github.com/IlyaNyrkov/k8s-velero-vkcloud-workshop>
1. Внешние ip балансировщиков будут другие на новом кластере.
1. Подключаем продвинутый роутер к транзитным сетям с исходным и новым роутером на спруте. Прописываем необходимую статику как на схеме выше.
1. Проверяем функционирование приложения.
1. Удаляем старый кластер.

### Базы данных

1. Останавливаем исходную базу данных на запись и делаем снапшот. Альтернативно можно использовать pgdump и другие встроенные средства бэкапирования баз данных.
1. Из бэкапа поднимаем базу данных в новой сети.
1. Строем перемычку с виртуальными машиными при помощи продвинутого роутера.
1. Правим конфиги вм, чтобы они ходили в бд с новым адресом.
1. Удаляем исходную бд.

### VPN IPsec

- Туннели с одинаковыми селекторами (исходные и целевые диапазоны подсетей) не могут существовать одновременно, даже если они на разных sdn. Это означает, что создать аналогичный neutron туннель на sprut заранее нельзя, так как это приведёт к проблемам в работе с исходного.
- Для миграции можно заранее заготовить манифест terraform, который будет описывать туннель на sprut, также это можно сделать для туннеля на neutron для отката миграции при необходимости. Когда будет выполнятся миграция, исходный туннель на neutron необходимо удалить и применить манифест для туннеля на sprut, либо создать его через графический интерфейс, но это займёт больше времени.
- Необходимо помнить, что туннель создаётся с обоих сторон и клиент на другой стороне должен также быть готов удалить старый и принять новый туннель.
- Для построения ipsec туннелей на sprut необходимо использовать продвинутый маршрутизатор, а не стандартный как для neutron.

  <img src="./images/image-2024-6-28_17-44-5.png" width="800">

  Данную схему можно преобразовать в такую, для сохранение описанного функционала

  <img src="./images/image-2024-6-28_17-44-52.png" width="800">

  Данная схема необходима, так как сети подключенные к продвинутому роутеру не поддерживают плавающие ip адреса. Подключение продвинутого и стандартного роутера через транзитную сеть позволяет передать всю маршрутизацию роутерам. Никакие маршруты по dhcp передавать не нужно.

- В случае, если Ipsec используются для организации сетевой связности между разными проектами vk cloud переключение выполнить проще но

  <img src="./images/image-2024-4-16_21-13-8.png" width="800">

  Рекомендуется заменить её на схему с шаренной сетью, shared network, так как это более производительно и надёжно. Стандартную сеть можно сделать доступной сразу в нескольких проектах, для этого нужно сделать запрос в техподдержку.

  <img src="./images/image-2024-4-16_20-53-18.png" width="1000">

- Для работы SNAT, то есть наличия доступа выхода в интернет, подсеть должна быть подключена к стандартному, а не продвинутому маршрутизатору.
- К одной сети нельзя подключить несколько стандартных роутеров без админских прав, которые есть у техподдержки.
- Мы используем продвинутые роутеры для подключения проектов к шаренной сети.
- Между стандартным и продвинутым маршрутизатором мы строим транзитную сеть. Для каждого стандартного маршрутизатора нужна отдельная транзитная сеть.
- Необходимо прописать соответствующие статические маршруты на стандартных и продвинутых маршрутизаторах.


## 7. Скопируйте балансировщики

У балансировщика нагрузки нельзя изменить сеть. Чтобы перенести балансировщик в SDN Sprut:

1. [Cоздайте новый балансировщик](/ru/networks/balancing/service-management/manage-lb#dobavlenie_balansirovshchika_nagruzki) и укажите параметры:

    - **Название балансировщика**: имя балансировщика, например, `my-load-balancer-sprut`.
    - **Сеть**: `app-subnet-sprut`.
    - Остальные параметры оставьте по умолчанию.

1. Создайте правила балансировки и скопируйте их параметры с балансировщика `my-load-balancer`.

## 8. Обновите A-записи публичного DNS

Так как изменился плавающий IP-адрес и IP-адрес балансировщика, отредактируйте A-записи публичной DNS-зоны:

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **DNS** → **DNS-зоны**.
1. Нажмите на имя `example.com`.
1. Нажмите ![Меню](/ru/assets/more-icon.svg "inline") для A-записи балансировщика `balancer` и выберите пункт **Редактировать**.
1. В параметре **IP-адрес** выберите IP-адрес балансировщика `my-load-balancer-sprut`.
1. Нажмите кнопку **Сохранить измения**.
1. Нажмите ![Меню](/ru/assets/more-icon.svg "inline") для A-записи веб-сервера `floating` и выберите пункт **Редактировать**.
1. В параметре **IP-адрес** выберите плавающий IP-адрес SDN Sprut. В этом примере: `83.166.236.59`.
1. Нажмите кнопку **Сохранить измения**.

<info>
Если в вашем проекте используется внешний сервис DNS, измените А-записи в нем.
</info>

## Удалите неиспользуемые ресурсы

Если созданные ресурсы вам больше не нужны, удалите их:

1. [Удалите](/ru/networks/dns/publicdns#udalenie_dns_zony) DNS-зону.
1. [Удалите](/ru/networks/balancing/service-management/manage-lb#udalenie_balansirovshchika_nagruzki) балансировщики нагрузки.
