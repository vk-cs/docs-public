В сервисе Cloud Desktop вы можете использовать встроенные образы для развертывания рабочих столов, а также загружать собственные. Собственные образы рабочих столов должны удовлетворять [требованиям сервиса Cloud Desktop](/ru/base/cloud-desktops/concepts/desktop-image).

Далее показано, как проверить собственный образ на совместимость с сервисом Cloud Desktop.

## Подготовительные шаги

1. Если на образе установлено ПО для поддержки службы каталогов AD, узнайте у вашего системного администратора:

     - IP-адрес DNS-сервера, на котором зарегистрированы IP-адрес и имя вашего сервера LDAP;
     - IP-адрес или FQDN вашего сервера LDAP;
     - имя и пароль пользователя LDAP с правами заведения ВМ в домен.

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Создайте [сеть](/ru/networks/vnet/operations/manage-net#sozdanie_seti) и [подсеть](/ru/networks/vnet/operations/manage-net#sozdanie_podseti):

     - Включите опцию **Доступ в интернет**.
     - Если на образе установлено ПО для поддержки службы каталогов AD:

         - В настройках сети выберите существующий маршрутизатор с подключением к внешней сети или [создайте](/ru/networks/vnet/operations/manage-router#dobavlenie_marshrutizatora) новый.
         - В настройках подсети отключите опцию **Приватный DNS** и добавьте в поле **DNS-серверы** IP-адрес DNS-сервера, который вы получили у вашего системного администратора.

     - Остальные параметры сети и подсети выберите на свое усмотрение.

1. Если на образе установлено ПО для поддержки службы каталогов AD, [организуйте](ru/base/cloud-desktops/how-to-guides/ipsec) VPN-туннель между сервером LDAP и созданной подсетью.

## 1. Проверьте возможность создания ВМ из подготовленного вами образа

1. Проверьте, что образ виден в мастере создания ВМ:

     1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
     1. Загрузите подготовленный образ в VK Cloud, следуя [инструкции по импорту](/ru/base/iaas/service-management/images/images-manage#import_obraza).
     1. Перейдите в раздел **Облачные вычисления** → **Вычислительные машины** и нажмите кнопку **Добавить**.
     1. Убедитесь, что в списке **Операционная система** отображается загруженный вами образ, и выберите его.

1. Проверьте, что при создании ВМ для нее нельзя указать параметры меньше, чем у загруженного образа:

     1. Если в списке **Тип виртуальной машины** есть вариант, у которого размер RAM меньше, чем у загруженного образа:

         1. Выберите его и нажмите кнопку **Следующий шаг**.
         1. Убедитесь, что переход на следующий шаг мастера заблокирован.

     1. Выберите в списке **Тип виртуальной машины** вариант, у которого размер RAM не меньше, чем у загруженного образа.
     1. Укажите значение **Размер диска** меньше, чем объем диска загруженного образа, и нажмите кнопку **Следующий шаг**.
     1. Убедитесь, что переход на следующий шаг мастера заблокирован.

1. Проверьте возможность создания ВМ из образа:

     1. Укажите значение **Размер диска** не меньше, чем объем диска загруженного образа.
     1. Выберите остальные параметры на этой странице на свое усмотрение и нажмите кнопку **Следующий шаг**.
     1. В списке **Сеть** выберите ранее созданные сеть и подсеть.
     1. Добавьте в параметр **Настройки firewall** группу безопасности, если она еще не добавлена:

        - `rdp` для ВМ Windows,
        - `ssh` для ВМ Astra Linux.

     1. Включите опцию **Назначить внешний IP**.
     1. Нажмите кнопку **Следующий шаг**, а затем кнопку **Создать инстанс**.
     1. Убедитесь, что ВМ создана успешно.

## 2. Проверьте различные способы подключения к ВМ, созданной из образа

<info>

Подключение к ВМ Astra Linux по протоколу RDP и с помощью LDAP проверяется независимо от того, было ли установлено на образ ПО для поддержки этих протоколов. Это ПО используется при эксплуатации рабочего стола и в случае отсутствия на образе будет автоматически установлено на рабочий стол в процессе его развертывания.

</info>

1. Проверьте возможность подключения к созданной ВМ:

     1. На вкладке **Общая информация** свойств ВМ нажмите кнопку **Установить пароль** и задайте пароль администратора.
     1. Подключитесь к ВМ:

         - Для [подключения](/ru/base/iaas/service-management/vm/vm-connect/vm-connect-win) к ВМ Windows используйте протокол RDP.
         - Для [подключения](/ru/base/iaas/service-management/vm/vm-connect/vm-connect-nix) к ВМ Astra Linux используйте протокол SSH.

     1. Убедитесь, что подключение прошло успешно.

1. (Для ВМ Astra Linux) Проверьте возможность подключения к ВМ по протоколу RDP.

     1. Если на образ не было добавлено ПО для поддержки протокола RDP, установите на ВМ пакеты `xorgxrdp` и `xrdp`. Для этого выполните команду:

         ```shell
         sudo apt install xorgxrdp xrdp
         ```

     1. Завершите текущий сеанс подключения к ВМ.
     1. [Добавьте](/ru/networks/vnet/operations/secgroups#naznachenie_gruppy_pravil_na_instans) ВМ в группу безопасности `rdp`.
     1. Подключитесь к ВМ по протоколу RDP, следуя [инструкции по подключению к ВМ Windows](/ru/base/iaas/service-management/vm/vm-connect/vm-connect-win#3_podklyuchites_k_vm).
     1. Убедитесь, что подключение прошло успешно и открылся графический интерфейс пользователя.

1. (Для ВМ Astra Linux) Проверьте возможность подключения к ВМ с помощью LDAP.

     1. Если на образе не было установлено ПО для поддержки службы каталогов AD, установите на ВМ пакет `astra-ad-sssd-client`. Для этого выполните команду:

         ```shell
         sudo apt update && apt install -y astra-ad-sssd-client
         ```

     1. Подключитесь к ВМ по протоколу SSH или RDP.
     1. Выполните в терминале команду:

         ```shell
         sudo astra-ad-sssd-client -d <ldap_id or domain_name> -u <username> -p <password>
         ```

         Здесь:

           - `<ldap_id or domain_name>` — IP-адрес или FQDN вашего сервера LDAP;
           - `<username>` и `<password>` — имя и пароль пользователя LDAP с правами заведения ВМ в домен.

     1. [Перезагрузите](/ru/base/iaas/service-management/vm/vm-manage#zapusk_ostanovka_perezagruzka_vm) ВМ.
     1. [Перейдите](/ru/base/iaas/service-management/vm/vm-console#vnc_konsol) в консоль ВМ.
     1. Авторизуйтесь с помощью логина и пароля пользователя LDAP и убедитесь, что вход прошел успешно.
     1. Подключитесь к ВМ по протоколу RDP, следуя [инструкции по подключению к ВМ Windows](/ru/base/iaas/service-management/vm/vm-connect/vm-connect-win#3_podklyuchites_k_vm).
     1. Авторизуйтесь с помощью логина и пароля пользователя LDAP и убедитесь, что вход прошел успешно.

## 3. Проверьте работоспособность установленного вами ПО и периферийных устройств

1. Убедитесь в наличии и работоспособности дополнительно установленных приложений.
1. (Для ВМ Astra Linux) Подключитесь к ВМ по протоколу RDP и проверьте работу звуковой карты и микрофона виртуальной машины средствами, доступными в ОС.

## Удалите неиспользуемые ресурсы

Работающая ВМ потребляет вычислительные ресурсы. Если она вам больше не нужна:

- [остановите](/ru/base/iaas/service-management/vm/vm-manage#zapusk_ostanovka_perezagruzka_vm) ее, чтобы воспользоваться ею позже;
- [удалите](/ru/base/iaas/service-management/vm/vm-manage#udalenie_vm) ее навсегда.
