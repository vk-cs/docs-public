Балансировщики нагрузки в VK Cloud по умолчанию создаются со стандартным шаблоном конфигурации. Для работы с повышенными объемами трафика используйте балансировщик нагрузки с более производительной конфигурацией.

В VK Cloud можно добавлять к вашей инфраструктуре балансировщики нагрузки с созданным специально для вас шаблоном конфигурации (_flavor_). Это позволяет увеличить производительность инфраструктуры при высокой нагрузке.

Шаблон более производительной конфигурации создается специалистами VK Cloud после согласования технических деталей.

## Подготовительные шаги

1. Обратитесь к менеджеру или пресейл-архитектору VK Cloud с запросом на создание индивидуального шаблона, если это еще не сделано. После согласования вы получите информацию о созданном для вас шаблоне конфигурации.
1. Если вы планируете пользоваться OpenStack CLI для создания или проверки работоспособности балансировщика:

    1. Убедитесь, что клиент OpenStack с пакетами `octavia` и `neutron` [установлены](/ru/tools-for-using-services/cli/openstack-cli#1_ustanovite_klient_openstack).
    1. [Пройдите аутентификацию](/ru/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu) в проекте.
1. Установите утилиту [cURL](https://github.com/curl/curl/blob/master/docs/INSTALL.md), если она еще не установлена.
1. [Получите](/ru/tools-for-using-services/api/rest-api/endpoints) эндпоинт сервиса Octavia. В этом примере: `https://public.infra.mail.ru:9876`.
1. [Получите](/ru/tools-for-using-services/api/rest-api/case-keystone-token) токен доступа к API `X-Auth-Token`.
1. [Узнайте](/ru/networks/vnet/instructions/net#prosmotr_spiska_setey_i_podsetey_a_takzhe_informacii_o_nih) идентификаторы сети и подсети, в которых вы хотите создать балансировщик.

## {heading(1. Получите информацию о шаблонах)[id=get_info]}

{tabs}
{tab(API)}

1. Получите список шаблонов конфигураций:

    ```console
    curl -X GET -H "X-Auth-Token: <ТОКЕН>" https://public.infra.mail.ru:9876/v2.0/lbaas/flavors
    ```

    Здесь `<ТОКЕН>` — токен доступа к API.
1. Запишите значение `flavor_id`. Пример: `8f94060c-8d5b-4472-9cfd-e8a2b909481d`.

{/tab}
{tab(OpenStack CLI)}

1. Получите список шаблонов конфигураций:

    ```console
    openstack loadbalancer flavor list
    ```

1. Запишите имя и идентификатор нужного шаблона конфигурации. Пример: `Avito-2-8`, `8f94060c-8d5b-4472-9cfd-e8a2b909481d`.
{/tab}
{/tabs}

{cut(Подробнее об именах шаблонов)}
Имя шаблона для балансировщика формируется следующим образом:

```plaintext
<НАЗВАНИЕ>-<ЧИСЛО_CPU>-<ОБЪЕМ_RAM>-<ОПЦИИ>
```

Пример: `Octavia-2-2-HA` — 2 vCPU и 2 ГБ оперативной памяти, топология Active-Standby (стандартный шаблон, создается по умолчанию).
{/cut}

## 2. Создайте балансировщик с индивидуальным шаблоном

{tabs}
{tab(API)}

Выполните запрос к API, чтобы создать балансировщик с нужным шаблоном. В запросе передайте необходимые в вашем случае параметры. Пример запроса:

```console
curl -X POST -H "Content-Type: application/json" -H "X-Auth-Token: <ТОКЕН>" -d '{"loadbalancer": {"description": "<ОПИСАНИЕ_БАЛАНСИРОВЩИКА>", "admin_state_up": true, "project_id": "<ИДЕНТИФИКАТОР_ПРОЕКТА>", "flavor_id": "<ИДЕНТИФИКАТОР_ШАБЛОНА>", "vip_subnet_id": "<ИДЕНТИФИКАТОР_ПОДСЕТИ>", "vip_address": "<VIP>", "provider": "octavia", "name": "<НАЗВАНИЕ_БАЛАНСИРОВЩИКА>", "vip_qos_policy_id": "<ИДЕНТИФИКАТОР_QoS-ПОЛИТИКИ>", "availability_zone": "<ЗОНА_ДОСТУПНОСТИ>", "tags": ["<ТЕГ>"]}}' https://public.infra.mail.ru:9876/v2/lbaas/loadbalancers
```
Здесь обязательные для заполнения значения:

- `<ТОКЕН>` — токен доступа к API.
- `<ИДЕНТИФИКАТОР_ШАБЛОНА>` — идентификатор шаблона конфигурации балансировщика, полученный от VK Cloud или {linkto(#get_info)[text=самостоятельно]}.
- `<ИДЕНТИФИКАТОР_ПОДСЕТИ>` — идентификатор подсети, в которой вы хотите разместить балансировщик.
- `<НАЗВАНИЕ_БАЛАНСИРОВЩИКА>` — произвольное название создаваемого балансировщика.

Дополнительные значения, заполняются опционально:

- `<ОПИСАНИЕ_БАЛАНСИРОВЩИКА>` — произвольное описание создаваемого балансировщика.
- `<ИДЕНТИФИКАТОР_ПРОЕКТА>` — [идентификатор проекта](/ru/tools-for-using-services/api/rest-api/endpoints#poluchenie_project_id) OpenStack, в котором вы хотите создать балансировщик.
- `<VIP>` — виртуальный IP-адрес, назначаемый балансировщику.
- `<ИДЕНТИФИКАТОР_QoS-ПОЛИТИКИ>` — идентификатор политики QoS, которую вы хотите назначить балансировщику.
- `<ЗОНА_ДОСТУПНОСТИ>` — имя [зоны доступности](/ru/computing/iaas/concepts/avail-zone), в которой вы хотите разместить балансировщик.
- `<ТЕГ>` — тег, которым вы хотите отметить балансировщик.

{cut(Пример ответа)}

```json
{
    "loadbalancer": {
        "description": "My favorite load balancer",
        "admin_state_up": true,
        "project_id": "e3cd678b11784734bc366148aa37580e",
        "provisioning_status": "PENDING_CREATE",
        "flavor_id": "8f94060c-8d5b-4472-9cfd-e8a2b909481d",
        "vip_subnet_id": "d4af86e1-0051-488c-b7a0-527f97490c9a",
        "vip_address": "203.0.113.50",
        "vip_network_id": "d0d217df-3958-4fbf-a3c2-8dad2908c709",
        "vip_port_id": "b4ca07d1-a31e-43e2-891a-7d14f419f342",
        "provider": "octavia",
        "created_at": "2017-02-28T00:41:44",
        "updated_at": "2017-02-28T00:43:30",
        "id": "607226db-27ef-4d41-ae89-f2a800e9c2db",
        "operating_status": "OFFLINE",
        "name": "best_load_balancer",
        "vip_qos_policy_id": "ec4f78ca-8da8-4e99-8a1a-e3b94595a7a3",
        "availability_zone": "my_az",
        "tags": ["test_tag"],
        "vip_vnic_type": "normal"
    }
}
```
{/cut}

Подробнее об API балансировщиков — в [официальной документации](https://docs.openstack.org/api-ref/load-balancer/v2/) OpenStack.
{/tab}

{tab(OpenStack CLI)}
Выполните команду:

```console
openstack loadbalancer create \
    --flavor <ИМЯ_ИЛИ_ИДЕНТИФИКАТОР_ШАБЛОНА> \
    --vip-network-id <ИДЕНТИФИКАТОР_СЕТИ> \
    --name <НАЗВАНИЕ_БАЛАНСИРОВЩИКА>
```

Здесь:

- `<ИМЯ_ИЛИ_ИДЕНТИФИКАТОР_ШАБЛОНА>` — имя или идентификатор шаблона конфигурации балансировщика, полученное от VK Cloud или {linkto(#get_info)[text=самостоятельно]}.
- `<ИДЕНТИФИКАТОР_СЕТИ>` — идентификатор сети, в которой вы хотите разместить балансировщик.
- `<НАЗВАНИЕ_БАЛАНСИРОВЩИКА>` — произвольное название создаваемого балансировщика.
{/tab}
{/tabs}

## 3. Проверьте создание и параметры балансировщика

{tabs}
{tab(Личный кабинет)}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.

   Будет отображен список балансировщиков.

1. Нажмите на имя нужного балансировщика.

   Откроется страница с подробной информацией о нем. На этой странице можно также [редактировать](/ru/networks/balancing/instructions/manage-lb#redaktirovanie_imeni_balansirovshchika_nagruzki) параметры балансировщика.

{/tab}
{tab(API)}

1. Получите список всех балансировщиков нагрузки с идентификаторами:

    ```console
    curl -X GET -H "X-Auth-Token: <ТОКЕН>" https://public.infra.mail.ru:9876/v2/lbaas/loadbalancers?project_id=<ИДЕНТИФИКАТОР_ПРОЕКТА>
    ```

    Здесь:

    - `<ТОКЕН>` — токен доступа к API.
    - `<ИДЕНТИФИКАТОР_ПРОЕКТА>` — [идентификатор проекта](/ru/tools-for-using-services/api/rest-api/endpoints#poluchenie_project_id) OpenStack, список балансировщиков которого вы хотите посмотреть. Заполняется опционально.

1. Получите детальную информацию о созданном балансировщике нагрузки:

    ```console
    curl -X GET -H "X-Auth-Token: <ТОКЕН>" https://public.infra.mail.ru:9876/v2/lbaas/loadbalancers/<ИДЕНТИФИКАТОР_БАЛАНСИРОВЩИКА>
    ```

    Здесь:

    - `<ТОКЕН>` — токен доступа к API.
    - `<ИДЕНТИФИКАТОР_БАЛАНСИРОВЩИКА>` — идентификатор балансировщика нагрузки, о котором вы хотите узнать детальную информацию.

{/tab}
{tab(OpenStack CLI)}

1. Получите список всех балансировщиков нагрузки с идентификаторами:

   ```console
   openstack loadbalancer list
   ```

1. Получите детальную информацию о созданном балансировщике нагрузки:

   ```console
   openstack loadbalancer show <ИДЕНТИФИКАТОР_БАЛАНСИРОВЩИКА>
   ```

   Ответ будет содержать информацию о балансировщике и идентификаторы:

   - `vip_port_id` — идентификатор порта, который используется в качестве виртуального IP-адреса на балансировщике нагрузки. На этот порт можно назначить Floating IP-адрес.

   - `listeners` — список идентификаторов listener-объектов. Эти объекты слушают входящие соединения к балансировщику нагрузки и служат точкой входа для трафика.

   - `pools` — список идентификаторов пулов (pools). Эти объекты служат для группировки конечных потребителей трафика. Потребители выступают участниками (members) пула. Трафик от listener-объекта балансируется между несколькими участниками, входящими в пул, сконфигурированный для listener-объекта.

{/tab}
{/tabs}

После успешного создания балансировщика вы можете [управлять](/ru/networks/balancing/instructions/manage-lb) им.

## Удалите неиспользуемые ресурсы

Если созданный балансировщик вам больше не нужен, [удалите](/ru/networks/balancing/instructions/manage-lb#udalenie_balansirovshchika_nagruzki) его.
