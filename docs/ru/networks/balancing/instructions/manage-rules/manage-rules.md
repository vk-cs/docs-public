Вы можете управлять правилами балансировки выбранного балансировщика нагрузки: просматривать, добавлять, редактировать и удалять их.

## {heading(Добавление правила)[id=add_balancer_rule]}

{tabs}

{tab(Личный кабинет)}

1. Перейдите в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Нажмите на имя балансировщика.
1. В секции **Правила балансировки** нажмите кнопку **Добавить правило**.
1. Задайте параметры правила:

   - **Протоколы и порты**:

      - Протокол балансировки и порт, который будет использоваться балансировщиком.
      - Протокол и порт назначения.

      При выборе протокола балансировки `TCP` доступны два протокола назначения: `TCP` или `PROXY`. Proxy-протокол можно использовать, если он поддерживается серверами, которые находятся за балансировщиком.

   - **Метод балансировки**:

      - `LEAST_CONNECTIONS`: использовать бэкенд, к которому установлено наименьшее число соединений.
      - `ROUND_ROBIN`: перебирать последовательно все бэкенды.
      - `SOURCE_IP`: закреплять бэкенд для обработки трафика за конкретным IP-адресом клиента.

   - **Разрешенные CIDR**: IP-адреса или адреса подсетей, с которых разрешены подключения к балансировщику. Этот параметр может использоваться для ограничения доступа к балансировщику только с доверенных адресов.

      Если параметр не задан, то разрешено подключение с любых IP-адресов (что эквивалентно CIDR `0.0.0.0/0`).

   - **Timeout параметры**:

      - `Client data`: тайм-аут неактивности клиента.
      - `Member connect`: тайм-аут установки соединения с бэкендом.
      - `Member data`: тайм-аут неактивности бэкенда.
      - `TCP inspect`: тайм-аут ожидания дополнительных TCP-сегментов при инспекции контента.

      Значения тайм-аутов задаются в миллисекундах. Минимальное значение — `0`, максимальное — `2073600000` (576 часов).

   - **Отправлять заголовок X-Forwarded-For** (только для протоколов балансировки HTTP и HTTPS): опция, позволяющая включить отправку на бэкенд соответствующего HTTP-заголовка. По умолчанию опция выключена.

   - **Sticky sessions**: опция обеспечивает длительные сессии соединения с сервером c сохранением данных на протяжении всей сессии.

      Если опция включена, запросы распределяются между серверами по выбранному методу балансировки, но после соединения сессия закрепляется за выбранным сервером. Все последующие запросы этой сессии будут направляться на тот же сервер без учета метода балансировки. Сессия не прекращается, пока пользователь сам не завершит ее или пока сервер не станет недоступным. В таком случае запросы будут отправляться к другому серверу по правилам балансировки.

      Поле **Тип** позволяет настроить определение сессии:

      - **по APP-cookie**: сессия определяется по cookie, заданной в коде приложения. Если выбран этот параметр, в поле **Cookie name** укажите cookie, по которой определяется сессия.
      - **по HTTP-cookie**: сессия определяется по cookie, которую балансировщик нагрузки создает во время соединения с сервером и прикрепляет к сессии.
      - **по Source IP**: для привязки сессии к серверу используется IP-адрес клиента. Используйте этот тип только если IP-адрес клиента не изменяется за время сессии.

   - **Применить для следующих инстансов**: инструменты для выбора инстансов виртуальных машин, которые будут выступать бэкендами для балансировщика. Можно добавить инстанс либо выбрав его из списка, либо выбрав тег, назначенный инстансу.

      {note:info}

      Группы безопасности для выбранных виртуальных машин должны быть настроены так, чтобы разрешать трафик на порт и протокол назначения.

      {/note}

   - **Сертификат** (только для протокола HTTPS): сертификат, который будет использоваться балансировщиком для терминирования SSL-соединения.

      Можно загрузить новый SSL-сертификат или выбрать загруженный ранее.

      {tabs}
      {tab(Загрузить новый сертификат)}

      1. Выберите **Загрузить новый сертификат** из выпадающего списка.
      1. Заполните поля:
      
         * **Название сертификата**: введите имя. Пример: `example-com-2024`.
         * **Сертификат или цепочка сертификатов**: загрузите файл сертификата.
         * **Приватный ключ**: загрузите файл приватного ключа.
         * **Пароль**: загрузите файл с паролем приватного ключа, если он зашифрован.
         
      {/tab}
      {tab(Выбрать из существующих)}

      Если сертификат был загружен ранее, выберите его из выпадающего списка.

      {/tab}
      {/tabs}

1. Нажмите кнопку **Следующий шаг**.
1. Заполните параметры проверки доступности бэкендов (healthcheck):

   - **Тип проверки**: `TCP` или `HTTP`.
   - **Интервал**: интервал проверки в секундах.
   - **Кол-во попыток**: сколько раз попытаться провести проверку, прежде чем признавать бэкенд недоступным.
   - **Таймаут**: тайм-аут в секундах, после истечения которого считается, что бэкенд не отвечает на проверку.

   Следующие параметры доступны только для типа проверки `HTTP`:

   - **HTTP-метод**: метод, который надо использовать для проверки доступности.
   - **Статус ответа**: [HTTP-статус](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status), при получении которого проверка доступности будет считаться успешной.
   - **Путь запроса**: путь, по которому надо обратиться для проверки доступности.

1. Нажмите кнопку **Добавить**.

{/tab}

{tab(OpenStack CLI)}

{note:info}

Здесь приведены только основные аргументы команд. Подробнее о командах и их аргументах читайте в справке OpenStack CLI:

```console
openstack loadbalancer --help
openstack loadbalancer <КОМАНДА> --help
```

{/note}

1. Убедитесь, что:

   1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli#1_ustanovite_klient_openstack) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli#2_opcionalno_ustanovite_dopolnitelnye_pakety) `python-octaviaclient`.
   1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu) в OpenStack CLI.

1. Чтобы создать правило балансировки:

   1. [Получите идентификатор балансировщика нагрузки](/ru/networks/balancing/instructions/manage-lb#prosmotr_spiska_balansirovshchikov_nagruzki_i_informacii_o_nih), для которого нужно создать правило.

   1. Создайте пул, в котором будут размещены потребители трафика:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```console
      openstack loadbalancer pool create \
        --loadbalancer <ID_БАЛАНСИРОВЩИКА> \
        --name <ИМЯ_ПУЛА> \
        --protocol <ПРОТОКОЛ_НАЗНАЧЕНИЯ> \
        --lb-algorithm <АЛГОРИТМ_БАЛАНСИРОВКИ>
      ```

      </tabpanel>
      <tabpanel>

      ```console
      openstack loadbalancer pool create `
        --loadbalancer <ID_БАЛАНСИРОВЩИКА> `
        --name <ИМЯ_ПУЛА> `
        --protocol <ПРОТОКОЛ_НАЗНАЧЕНИЯ> `
        --lb-algorithm <АЛГОРИТМ_БАЛАНСИРОВКИ>
      ```

      </tabpanel>
      </tabs>

      Запишите идентификатор созданного пула (`id`).

   1. Определите IP-адреса виртуальных машин, которые будут участниками (members) пула. Также [определите идентификатор](/ru/networks/vnet/instructions/net#prosmotr_spiska_setey_i_podsetey_a_takzhe_informacii_o_nih) подсети, в которой находятся виртуальные машины.

      Эти виртуальные машины должны быть либо размещены в подсети, где находится балансировщик, для которого создается правило балансировки, либо доступны из этой подсети.

   1. Для каждой такой виртуальной машины создайте member-объект, который будет участником созданного пула:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```console
      openstack loadbalancer member create <ID_ПУЛА> \
        --name <ИМЯ_УЧАСТНИКА> \
        --address <IP-АДРЕС_ВМ> \
        --subnet-id <ID_ПОДСЕТИ> \
        --protocol-port <НОМЕР_ПОРТА_НАЗНАЧЕНИЯ>
      ```

      </tabpanel>
      <tabpanel>

      ```console
      openstack loadbalancer member create <ID_ПУЛА> `
        --name <ИМЯ_УЧАСТНИКА> `
        --address <IP-АДРЕС_ВМ> `
        --subnet-id <ID_ПОДСЕТИ> `
        --protocol-port <НОМЕР_ПОРТА_НАЗНАЧЕНИЯ>
      ```

      </tabpanel>
      </tabs>

      {note:warn}

      Все member-объекты в рамках одного пула должны использовать один и тот же порт.

      {/note}

   1. Создайте для пула healthcheck-объект. Он будет проверять состояние и доступность участников (members) пула.

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```console
      openstack loadbalancer healthmonitor create <ID_ПУЛА> \
        --name <ИМЯ_HEALTHCHECK-ОБЪЕКТА> \
        --delay <ЗАДЕРЖКА_В_СЕКУНДАХ> \
        --timeout <ТАЙМ-АУТ_В_СЕКУНДАХ> \
        --max-retries <КОЛИЧЕСТВО_УСПЕШНЫХ_ПОПЫТОК> \
        --max-retries-down <КОЛИЧЕСТВО_НЕУСПЕШНЫХ_ПОПЫТОК> \
        --type <ТИП_ПРОВЕРКИ>
      ```

      </tabpanel>
      <tabpanel>

      ```console
      openstack loadbalancer healthmonitor create <ID_ПУЛА> `
        --name <ИМЯ_HEALTHCHECK-ОБЪЕКТА> `
        --delay <ЗАДЕРЖКА_В_СЕКУНДАХ> `
        --timeout <ТАЙМ-АУТ_В_СЕКУНДАХ> `
        --max-retries <КОЛИЧЕСТВО_УСПЕШНЫХ_ПОПЫТОК>`
        --max-retries-down <КОЛИЧЕСТВО_НЕУСПЕШНЫХ_ПОПЫТОК> `
        --type <ТИП_ПРОВЕРКИ>
      ```

      </tabpanel>
      </tabs>

   1. Создайте прослушиватель, который будет обрабатывать входящие соединения:

      {tabs}
      
      {tab(Linux/macOS (bash, zsh))}

         ```console
         openstack loadbalancer listener create <ID_БАЛАНСИРОВЩИКА> \
           --name <ИМЯ_ПРОСЛУШИВАТЕЛЯ> \
           --protocol <ПРОТОКОЛ> \
           --default-pool <ID_ПУЛА> \
           --protocol-port <НОМЕР_ПОРТА> \
           --timeout-member-data <ТАЙМ-АУТ_1> \
           --timeout-member-connect <ТАЙМ-АУТ_2> \
           --timeout-client-data <ТАЙМ-АУТ_3> \
           --timeout-tcp-inspect <ТАЙМ-АУТ_4>
         ```
      
         Здесь:
      
         - `<ID_БАЛАНСИРОВЩИКА>` — идентификатор балансировщика нагрузки.
         - `<ИМЯ_ПРОСЛУШИВАТЕЛЯ>` — название прослушивателя.
         - `<ПРОТОКОЛ>` — протокол балансировки. Возможные значения: `TCP`, `HTTP`, `HTTPS`.
         - `<ID_ПУЛА>` — идентификатор пула.
         - `<НОМЕР_ПОРТА>` — порт протокола балансировки.
         - `<ТАЙМ-АУТ_1>` — тайм-аут бездействия сервера. По умолчанию — `50000`.
         - `<ТАЙМ-АУТ_2>` — тайм-аут установки соединения балансировщика с сервером. По умолчанию — `5000`.
         - `<ТАЙМ-АУТ_3>` — тайм-аут бездействия клиента. По умолчанию — `50000`.
         - `<ТАЙМ-АУТ_4>` — ожидание дополнительных TCP-пакетов для проверки содержимого. По умолчанию — `0`.

      {/tab}
      {tab(Windows (PowerShell))}

         ```console
         openstack loadbalancer listener create <ID_БАЛАНСИРОВЩИКА> `
           --name <ИМЯ_ПРОСЛУШИВАТЕЛЯ> `
           --protocol <ПРОТОКОЛ> `
           --default-pool <ID_ПУЛА> `
           --protocol-port <НОМЕР_ПОРТА> `
           --timeout-member-data <ТАЙМ-АУТ_1> `
           --timeout-member-connect <ТАЙМ-АУТ_2> `
           --timeout-client-data <ТАЙМ-АУТ_3> `
           --timeout-tcp-inspect <ТАЙМ-АУТ_4>
         ```

         Здесь:

         - `<ID_БАЛАНСИРОВЩИКА>` — идентификатор балансировщика нагрузки.
         - `<ИМЯ_ПРОСЛУШИВАТЕЛЯ>` — название прослушивателя.
         - `<ПРОТОКОЛ>` — протокол балансировки. Возможные значения: `TCP`, `HTTP`, `HTTPS`.
         - `<ID_ПУЛА>` — идентификатор пула.
         - `<НОМЕР_ПОРТА>` — порт протокола балансировки.
         - `<ТАЙМ-АУТ_1>` — тайм-аут бездействия сервера. По умолчанию — `50000`.
         - `<ТАЙМ-АУТ_2>` — тайм-аут установки соединения балансировщика с сервером. По умолчанию — `5000`.
         - `<ТАЙМ-АУТ_3>` — тайм-аут бездействия клиента. По умолчанию — `50000`.
         - `<ТАЙМ-АУТ_4>` — ожидание дополнительных TCP-пакетов для проверки содержимого. По умолчанию — `0`.

      {/tab}
      {/tabs}

1. Чтобы применить (`set`) нужные настройки к объектам, которые входят в правило балансировки, или отменить настройки (`unset`), используйте соответствующие команды (например, `openstack loadbalancer pool set`).

{/tab}
{/tabs}

## {heading(Редактирование правила)[id=edit_balancer_rule]}

{tabs}

{tab(Личный кабинет)}

1. Перейдите в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Нажмите на имя балансировщика.
1. В секции **Правила балансировки** в строке с правилом балансировки нажмите на значок карандаша.
1. Внесите изменения и нажмите **Сохранить**.

{/tab}

{tab(OpenStack CLI)}

{note:info}

Здесь приведены только основные аргументы команд. Подробнее о командах и их аргументах читайте в справке OpenStack CLI:

```console
openstack loadbalancer --help
openstack loadbalancer <КОМАНДА> --help
```

{/note}

1. Убедитесь, что:

    1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli#1_ustanovite_klient_openstack) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli#2_opcionalno_ustanovite_dopolnitelnye_pakety) `python-octaviaclient`.
    1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu) в OpenStack CLI.

1. Определите идентификатор балансировщика нагрузки. Для этого выведите список балансировщиков:

   ```console
   openstack loadbalancer list
   ```

1. Определите идентификатор правила балансировки. Для этого выведите список правил балансировщика нагрузки:

   ```console
   openstack loadbalancer rule list --load-balancer <ID_БАЛАНСИРОВЩИКА>
   ```
   
1. Измените правило балансировки:

   {tabs}

   {tab(Linux/macOS (bash, zsh))}

      ```console
      openstack loadbalancer rule set <ID_ПРАВИЛА> \
        --name <ИМЯ> \
        --description <ОПИСАНИЕ> \
        --protocol <ПРОТОКОЛ> \
        --port <НОМЕР_ПОРТА> \
        --pool <ID_ПУЛА> \
        --vip <VIP>
      ```

      Здесь:

      - `<ID_ПРАВИЛА>` — идентификатор правила балансировки.
      - `<ИМЯ_ПРАВИЛА>` — имя правила балансировки.
      - `<ПРОТОКОЛ>` — протокол балансировки. Возможные значения: `TCP`, `HTTP`, `HTTPS`.
      - `<НОМЕР_ПОРТА>` — порт протокола балансировки.
      - `<ID_ПУЛА>` — идентификатор пула.
      - `<VIP>` — виртуальный IP-адрес.

   {/tab}
   {tab(Windows (PowerShell))}

      ```console
      openstack loadbalancer rule set <ID_ПРАВИЛА> `
        --name <ИМЯ> `
        --description <ОПИСАНИЕ> `
        --protocol <ПРОТОКОЛ> `
        --port <НОМЕР_ПОРТА> `
        --pool <ID_ПУЛА> `
        --vip <VIP>
      ```

      Здесь:

      - `<ID_ПРАВИЛА>` — идентификатор правила балансировки.
      - `<ИМЯ_ПРАВИЛА>` — имя правила балансировки.
      - `<ПРОТОКОЛ>` — протокол балансировки. Возможные значения: `TCP`, `HTTP`, `HTTPS`.
      - `<НОМЕР_ПОРТА>` — порт протокола балансировки.
      - `<ID_ПУЛА>` — идентификатор пула.
      - `<VIP>` — виртуальный IP-адрес.

   {/tab}
   {/tabs}

1. Чтобы применить (`set`) нужные настройки к объектам, которые входят в правило балансировки, или отменить настройки (`unset`), используйте соответствующие команды (например, `openstack loadbalancer pool set`).

{/tab}
{/tabs}

## {heading(Удаление правила)[id=delete_balancer_rule]}

{tabs}

{tab(Личный кабинет)}

1. Перейдите в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Нажмите на имя балансировщика.
1. В секции **Правила балансировки** в строке с правилом балансировки нажмите на значок корзины и подтвердите удаление.

{/tab}

{tab(OpenStack CLI)}

{note:info}

Здесь приведены только основные аргументы команд. Подробнее о командах и их аргументах читайте в справке OpenStack CLI:

```console
openstack loadbalancer --help
openstack loadbalancer <КОМАНДА> --help
```

{/note}

1. Убедитесь, что:

    1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli#1_ustanovite_klient_openstack) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli#2_opcionalno_ustanovite_dopolnitelnye_pakety) `python-octaviaclient`.
    1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu) в OpenStack CLI.
   
1. Определите идентификатор балансировщика нагрузки. Для этого выведите список балансировщиков:

      ```console
      openstack loadbalancer list
      ```

1. Определите идентификатор прослушивателя. Для этого выведите список прослушивателей балансировщика нагрузки:

      ```console
      openstack loadbalancer listener list --load-balancer <ID_БАЛАНСИРОВЩИКА>
      ```

1. Определите идентификатор пула, используемого этим прослушивателем:

   ```console
   openstack loadbalancer listener show <ID_ПРОСЛУШИВАТЕЛЯ>
   ```

   Идентификатор пула будет содержаться в поле `default_pool_id`.

1. Удалите прослушиватель:

   ```console
   openstack loadbalancer listener delete <ID_ПРОСЛУШИВАТЕЛЯ>
   ```

1. Удалите пул:

   ```console
   openstack loadbalancer pool delete <ID_ПУЛА>
   ```

{/tab}
{/tabs}