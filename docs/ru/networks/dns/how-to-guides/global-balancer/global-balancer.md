VK Cloud позволяет создавать отказоустойчивые приложения за счет геораспределенной архитектуры с использованием нескольких бэкенд-серверов, размещенных в разных дата-центрах ([зонах доступности](/ru/start/concepts/architecture#az)). В случае аварии в одной из зон доступности, инфраструктура автоматически перенаправляет трафик на работоспособные серверы в других дата-центрах, минимизируя простои.

Для реализации этой модели применяется механизм балансировки нагрузки на уровне DNS, который выполняет регулярные проверки доступности серверов и перенаправляет запросы к резервным серверам.

В этом примере три ВМ в разных зонах доступности будут объединены через группы балансировки сервиса DNS.

## Подготовительные шаги

1. [Перейдите](https://msk.cloud.vk.com/app) в личный кабинет VK Cloud.
1. Выберите или [создайте](/ru/computing/iaas/instructions/vm/vm-create) три ВМ с доступом в интернет в разных [зонах доступности](/ru/start/concepts/architecture#az).
1. Запишите внешние IP-адреса этих ВМ. В этом примере:

    - `83.166.234.101`;
    - `109.120.188.102`;
    - `217.16.23.103`.

1. Для созданных ВМ [разрешите](/ru/networks/vnet/instructions/secgroups) входящий трафик с IP-адреса `169.254.169.100/32` на заданный порт. Это технический адрес VK Cloud для проверки доступности сервиса. Если файервол ограничит доступ к порту ВМ с этого адреса, DNS-балансировка отметит ВМ как недоступную и не будет отправлять трафик на нее.
1. [Создайте](/ru/networks/dns/instructions/publicdns/dns-zone#add) DNS-зону. В этом примере `example.dns.com`.
1. Зарегистрируйте ваш домен у доменного регистратора и делегируйте его на NS-серверы VK Cloud, если этого еще не сделано. Дождитесь обновления DNS-записей: обычно занимает 10–30 минут.
1. Установите утилиту `dig` на ваш компьютер для проверки работы DNS-балансировки:

   <tabs>
   <tablist>
   <tab>Ubuntu, Debian</tab>
   <tab>Red Hat, CentOS, Fedora</tab>
   <tab>macOS</tab>
   <tab>Windows</tab>
   </tablist>
   <tabpanel>

   ```bash
   sudo apt update && sudo apt install dnsutils
   ```
   
   </tabpanel>
   <tabpanel>
   
   ```bash
   # Для старых версий (yum):
   sudo yum install bind-utils

   # Для новых версий (dnf):
   sudo dnf install bind-utils
   ```

   </tabpanel>
   <tabpanel>
   
   ```bash
   brew install bind
   ```

   </tabpanel>
   <tabpanel>
   
   ```bash
   choco install bind-toolsonly
   ```
   </tabpanel>
   </tabs>

   <info>

   Вы можете использовать аналоги утилиты `dig` для проверки DNS-балансировки. Комады проверки при этом будут отличаться.

   </info>

## 1. Добавьте A-записи в DNS-зону

В DNS-зоне [создайте](/ru/networks/dns/instructions/publicdns/records#add) A-записи, соответствующие внешнему IP-адресу каждой добавленной ВМ.

## 2. Создайте группу балансировки

1. Для DNS-зоны [создайте](/ru/networks/dns/instructions/publicdns/global-balancer#add) группу балансировки с типом балансировки `Round Robin`.
1. В группу балансировки добавьте все A-записи, доступные в DNS-зоне:

   - для каждой записи выберите тип мониторинга `ICMP`;
   - остальные параметры оставьте по умолчанию.

## 3. Проверьте работу DNS-балансировки

1. На компьютере выполните команду:

   ```bash
   for i in {1..100}; do dig www.example.dns.com  A @ns4.msc.mail.ru +short; done | sort | uniq -c
   ```

   Ожидаемый ответ:

   ```bash
   33 83.166.234.101
   34 109.120.188.102
   33 217.16.23.103
   ```

   Здесь в начале строки указывается количество запросов, которые DNS-балансировка отправила к каждому серверу. Ответ показывает, что балансировка работает и пересылает запросы примерно по ровну между всеми доступными серверами (зонами доступности).

1. В личном кабинете [остановите](/ru/computing/iaas/instructions/vm/vm-manage#start_stop_restart_vm) две из трех ВМ. Это имитирует отказ сервера или недоступность дата-центра.
1. На компьютере повторите команду:

   ```bash
   for i in {1..100}; do dig www.example.dns.com  A @ns4.msc.mail.ru +short; done | sort | uniq -c
   ```

   Ожидаемый ответ:

   ```bash
   100 217.16.23.103
   ```

   Здесь ответ позывает, что DNS-балансировка отправляет все запросы на один сервер (зону доступности), потому что два других сервера недоступны.

## Удалите неиспользуемые ресурсы

Если добавленные ресурсы вам больше не нужны, удалите их:

1. [Удалите](../../instructions/publicdns/global-balancer#delete) группу балансировки.
1. [Удалите](../../instructions/publicdns/dns-zone#delete) DNS-зону.
1. [Удалите](/ru/computing/iaas/instructions/vm/vm-manage#delete_vm) ВМ.