Вы можете управлять VPN-туннелями: просматривать, добавлять в проект и удалять их из проекта, а также редактировать и перезапускать туннели.

Сервис VPN доступен в Neutron и Sprut [SDN](../../concepts/architecture#ispolzuemye_sdn). Доступные инструменты управления зависят от используемой SDN:

- Sprut SDN: интерфейс личного кабинета, API и Terraform.
- Neutron SDN: интерфейс личного кабинета, API, [Terraform](/ru/tools-for-using-services/terraform/how-to-guides/vnet/vpn) и [OpenStack CLI](/ru/tools-for-using-services/cli/openstack-cli).

## Просмотр списка VPN-туннелей и информации о них

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>OpenStack CLI</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **VPN**.

   Будет отображен список VPN-туннелей.

1. Нажмите на имя VPN-туннеля.

   Откроется страница с подробной информацией о нем. Переходите между вкладками страницы для просмотра информации о параметрах IKE и IPsec, endpoint-групп и туннеля. На этой странице можно также редактировать параметры VPN-туннеля.

</tabpanel>
<tabpanel>

1. Убедитесь, что:

   1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli) `python-neutronclient`.
   1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli) в OpenStack CLI.

1. Чтобы посмотреть список VPN-туннелей, выполните команду:

   ```bash
   openstack vpn ipsec site connection list
   ```

1. Чтобы посмотреть детальную информацию о VPN-туннеле, выполните команду:

   ```bash
   openstack vpn ipsec site connection show <идентификатор VPN-туннеля из списка, полученного ранее>
   ```

   Будет выведена общая информация о туннеле и идентификаторы:

   - `IKE Policy` — идентификатор IKE-политики. Чтобы посмотреть детальную информацию о политике, выполните команду:

     ```bash
     openstack vpn ike policy show <идентификатор IKE-политики>
     ```

   - `IPSec Policy` — идентификатор IPsec-политики. Чтобы посмотреть детальную информацию о политике, выполните команду:

     ```bash
     openstack vpn ipsec policy show <идентификатор IPsec-политики>
     ```

   - `Local Endpoint Group ID` — идентификатор локальной endpoint-группы. Чтобы посмотреть детальную информацию о группе, выполните команду:

     ```bash
     openstack vpn endpoint group show <идентификатор локальной endpoint-группы>
     ```

   - `Peer Endpoint Group ID` — идентификатор удаленной (peer) endpoint-группы. Чтобы посмотреть детальную информацию о группе, выполните команду:

     ```bash
     openstack vpn endpoint group show <идентификатор удаленной endpoint-группы>
     ```

   - `VPN Service` — идентификатор VPN-сервиса, который обслуживает этот VPN-туннель. Чтобы посмотреть детальную информацию о сервисе, выполните команду:

     ```bash
     openstack vpn service show <идентификатор VPN-сервиса>
     ```

</tabpanel>
</tabs>

## Добавление VPN-туннеля

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>OpenStack CLI</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **VPN**.
1. Нажмите кнопку **Добавить VPN** или **Добавить**. Откроется мастер создания нового VPN-туннеля.
1. Выберите SDN, в которой будет создан VPN:

   - **SDN Neutron**: VPN можно подключить только к [стандартному маршрутизатору](../../concepts/router#vozmozhnosti_standartnogo_marshrutizatora) Sprut или Neutron.
   - **SDN Sprut**: VPN можно подключить только к [продвинутому маршрутизатору](../../concepts/router#vozmozhnosti_prodvinutogo_marshrutizatora).

1. Настройте IKE:

   1. **IKE-политика** — выберите IKE-политику из выпадающего списка. Если нужной политики нет, создайте новую:

      1. Выберите из выпадающего списка пункт `Новая IKE-политика`.
      1. Задайте настройки политики:

         - **Имя политики**.
         - **Время жизни ключа** (в секундах).
         - **Алгоритм авторизации** — рекомендуется выбрать `sha256`.
         - **Алгоритм шифрования** — рекомендуется выбрать `aes256`.
         - **Версия IKE** — рекомендуется выбрать версию `v2`.
         - **Группа Диффи-Хеллмана** — рекомендуется выбрать группу `group14`.
  
   1. Нажмите кнопку **Следующий шаг**.

1. Настройте IPsec:

   1. **IPsec-политика** — выберите IPsec-политику из выпадающего списка. Если нужной политики нет, создайте новую:

      1. Выберите из выпадающего списка пункт `Новая IPsec-политика`.
      1. Задайте настройки политики:

         - **Имя политики**.
         - **Время жизни ключа** (в секундах).
         - **Алгоритм авторизации** — рекомендуется выбрать `sha256`.
         - **Алгоритм шифрования** — рекомендуется выбрать `aes256`.
         - **Группа Диффи-Хеллмана** — рекомендуется выбрать группу `group14`.

   1. Нажмите кнопку **Следующий шаг**.

1. Настройте endpoint-группы:

   1. **Маршрутизатор** — выберите маршрутизатор, подсети которого должны быть доступны через VPN-туннель. Доступные опции зависят от выбранной SDN, и среди них только те маршрутизаторы, которые подключены к внешней сети и имеют назначенный внешний IP-адрес.

   <warn>

   Для одного маршрутизатора рекомендуется создавать не более 500 соединений. При большем количестве соединений могут возникать ошибки.

   </warn>

   1. **Local Endpoint** — выберите локальную endpoint-группу из выпадающего списка. Если нужной группы нет, создайте новую:

      1. Выберите из выпадающего списка пункт `Новая endpoint-группа`.
      1. Задайте настройки группы:

         <tabs>
         <tablist>
         <tab>Neutron</tab>
         <tab>Sprut</tab>
         </tablist>
         <tabpanel>

         - **Имя** — имя локальной endpoint-группы.
         - **Подсети** — выберите одну или несколько подсетей, подключенных к выбранному ранее маршрутизатору. Эти подсети будут доступны через VPN-туннель.

         </tabpanel>
         <tabpanel>

         - **Имя** — имя локальной endpoint-группы.
         - **Адрес подсети** — укажите IP-адрес (CIDR) подсети, подключенной в выбранному ранее маршрутизатору. Эта подсеть будет доступна через VPN-туннель.
         - (Опционально) Для подключения дополнительной подсети нажмите **Добавить еще один CIDR** и укажите IP-адрес подсети, которая должна быть доступна через VPN-туннель.

         </tabpanel>
         </tabs>

   1. **Remote Endpoint** — выберите удаленную (remote) endpoint-группу из выпадающего списка. Если нужной группы нет, создайте новую:

      1. Выберите из выпадающего списка пункт `Новая endpoint-группа`.
      1. Задайте настройки группы:

         - **Имя группы**.
         - **Адрес подсети** — адрес удаленной (remote) подсети, которая будет доступна через VPN-туннель.

           При необходимости добавить еще несколько подсетей, нажмите на ссылку **Добавить подсеть**.

   1. Нажмите кнопку **Следующий шаг**.

1. Настройте VPN-туннель:

   1. Укажите базовые настройки:

      - **Имя туннеля**.
      - **Публичный IPv4 адрес пира (Peer IP)**.
      - **Ключ совместного использования (PSK)**.

        При необходимости сгенерируйте ключ, нажав соответствующую кнопку.

        <info>

        Допустимые символы:
        - заглавные и строчные буквы латинского алфавита;
        - цифры;
        - спецсимволы `-`, `+`, `&`, `!`, `@`, `#`, `$`, `%`, `^`, `*`, `(`, `)`, `,`, `.`, `:`, `;`, `_`, `=`, `<`, `>`, `{`, `}`, `/`.

        Ключ должен содержать хотя бы одну букву или цифру.

        </info>

   1. (Опционально) укажите расширенные настройки:

      - **Идентификатор маршрутизатора пира для аутентификации (Peer ID)** — по умолчанию совпадает с адресом пира.
      - (Только для VPN в SDN Sprut) **Селектор потоков траффика**:
         - **Объединить** — не расщеплять трафик-селекторы, то есть оборачивать все адресные префиксы в один туннель передачи данных;
         - **Разделить** — расщеплять трафик-селекторы, то есть для каждой пары адресных префиксов создавать отдельный туннель передачи данных.
      - **Состояние инициатора** — поведение при установке IPsec-соединения:

        - `bi-directional` (по умолчанию) — со стороны платформы VK Cloud будут производиться попытки установления соединения с удаленным пиром (remote peer).
        - `response-only` — платформа ожидает, что VPN-соединение будет инициировано удаленным пиром, и не пытается установить его самостоятельно.

      - Настройки обнаружения недоступности удаленного пира (Dead Peer Detection, DPD):

        - **При обнаружении недоступности пира** — определяет поведение платформы VK Cloud, если удаленный пир недоступен:

          - `hold` (по умолчанию) — при обнаружении недоступности IPsec-соединение разрывается. Соединение может быть переустановлено только удаленным пиром.
          - `clear` — при обнаружении недоступности IPsec-соединение разрывается. Соединение не будет переустановлено, даже если удаленный пир будет пытаться это сделать.
          - `restart` — при обнаружении недоступности IPsec-соединение разрывается. Платформа VK Cloud будет пытаться переустановить соединение с удаленным пиром.

        - **Интервал обнаружения недоступности пира** — с каким интервалом (в секундах) отправлять проверочные DPD-сообщения.

        - **Время для обнаружения недоступности пира** — если по истечении этого тайм-аута (в секундах) не было получено ни одного проверочного DPD-сообщения от удаленного пира, то он признается недоступным (dead).

          По умолчанию значение этого параметра в четыре раза больше, чем  **Интервал обнаружения недоступности пира**.

1. Нажмите кнопку **Создать VPN-туннель**.

</tabpanel>
<tabpanel>

1. Убедитесь, что:

   1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli) `python-neutronclient`.
   1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli) в OpenStack CLI.

1. Настройте IKE:

   1. Получите список IKE-политик и посмотрите детальную информацию о политиках:

      ```bash
      openstack vpn ike policy list
      ```

      ```bash
      openstack vpn ike policy show <идентификатор политики>
      ```

      Запишите идентификатор политики (`id`), которая будет использоваться VPN-туннелем.

   1. Если подходящей IKE-политики на предыдущем шаге не нашлось, создайте ее:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn ike policy create <имя политики> \
        --lifetime units=<единицы измерения, по умолчанию seconds>,value=<время жизни ключа, по умолчанию 3600> \
        --auth-algorithm <Алгоритм авторизации: sha1, sha256> \
        --encryption-algorithm <Алгоритм шифрования: 3des, aes-128, aes-192, aes-256> \
        --ike-version <Версия IKE: v1, v2> \
        --pfs <Группа Диффи-Хеллмана: group5, group2, group14>
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn ike policy create <имя политики> `
        --lifetime units=<единицы измерения, по умолчанию seconds>,value=<время жизни ключа, по умолчанию 3600> `
        --auth-algorithm <Алгоритм авторизации: sha1, sha256> `
        --encryption-algorithm <Алгоритм шифрования: 3des, aes-128, aes-192, aes-256> `
        --ike-version <Версия IKE: v1, v2> `
        --pfs <Группа Диффи-Хеллмана: group5, group2, group14>
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор политики (`id`), которая будет использоваться VPN-туннелем.

1. Настройте IPsec:

   1. Получите список IPsec-политик и посмотрите детальную информацию о политиках:

      ```bash
      openstack vpn ipsec policy list
      ```

      ```bash
      openstack vpn ipsec policy show <идентификатор политики>
      ```

      Запишите идентификатор политики, которая будет использоваться VPN-туннелем.

   1. Если подходящей IPsec-политики на предыдущем шаге не нашлось, создайте ее:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn ipsec policy create <имя политики> \
        --lifetime units=<единицы измерения, по умолчанию seconds>,value=<время жизни ключа, по умолчанию 3600> \
        --auth-algorithm <Алгоритм авторизации: sha1, sha256> \
        --encryption-algorithm <Алгоритм шифрования: 3des, aes-128, aes-192, aes-256> \
        --pfs <Группа Диффи-Хеллмана: group5, group2, group14>
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn ipsec policy create <имя политики> `
        --lifetime units=<единицы измерения, по умолчанию seconds>,value=<время жизни ключа, по умолчанию 3600> `
        --auth-algorithm <Алгоритм авторизации: sha1, sha256> `
        --encryption-algorithm <Алгоритм шифрования: 3des, aes-128, aes-192, aes-256> `
        --pfs <Группа Диффи-Хеллмана: group5, group2, group14>
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор политики, которая будет использоваться VPN-туннелем.

1. Создайте VPN-сервис, который будет обслуживать VPN-туннель:

   1. Получите список маршрутизаторов и посмотрите детальную информацию о них:

      ```bash
      openstack router list
      ```

      ```bash
      openstack router show <идентификатор марщрутизатора>
      ```

      Запишите идентификатор маршрутизатора, чьи подсети нужно сделать доступными через VPN-туннель.

      Такой маршрутизатор должен иметь доступ в интернет и привязанный к нему внешний IP-адрес.

   1. Создайте VPN-сервис, использующий этот маршрутизатор:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn service create <имя VPN-сервиса> \
        --router <идентификатор маршрутизатора, полученный на предыдущем шаге> \
        --enable
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn service create <имя VPN-сервиса> `
        --router <идентификатор маршрутизатора, полученный на предыдущем шаге> `
        --enable
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор VPN-сервиса, который будет использоваться VPN-туннелем.

1. Настройте endpoint-группы:

   1. Получите список endpoint-групп и посмотрите детальную информацию о них:

      ```bash
      openstack vpn endpoint group list
      ```

      ```bash
      openstack vpn endpoint group show <идентификатор группы>
      ```

      Запишите:
      - Идентификатор группы, которая будет использоваться VPN-туннелем в качестве локальной endpoint-группы. Такая группа должна иметь тип `subnet`.

        Подсети, принадлежащие группе, должны быть подключены к маршрутизатору, который указывался на предыдущем шаге в настройках VPN-сервиса.

      - Идентификатор группы, которая будет использоваться VPN-туннелем в качестве удаленной endpoint-группы. Такая группа должна иметь тип `cidr`.

   1. Если подходящей локальной endpoint-группы не нашлось, создайте ее:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn endpoint group create <имя локальной endpoint-группы> \
        --type subnet \
        --value <идентификатор подсети, подключенной к маршрутизатору, которая должна быть доступна через VPN-туннель> \
        ...
        --value <идентификатор дополнительной подсети>
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn endpoint group create <имя локальной endpoint-группы> `
        --type subnet `
        --value <идентификатор подсети, подключенной к маршрутизатору, которая должна быть доступна через VPN-туннель> `
        ...
        --value <идентификатор дополнительной подсети>
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор локальной endpoint-группы, которая будет использоваться VPN-туннелем.

   1. Если подходящей удаленной endpoint-группы не нашлось, создайте ее:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn endpoint group create <имя удаленной endpoint-группы> \
        --type cidr \
        --value "<удаленная подсеть в формате 10.0.0.0/24, которая должна быть доступна через VPN-туннель>" \
        ...
        --value "<дополнительная удаленная подсеть>"
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn endpoint group create <имя удаленной endpoint-группы> `
        --type cidr `
        --value "<удаленная подсеть в формате 10.0.0.0/24, которая должна быть доступна через VPN-туннель>" `
        ...
        --value "<дополнительная удаленная подсеть>"
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор удаленной endpoint-группы, которая будет использоваться VPN-туннелем.

1. Создайте VPN-туннель:

   <tabs>
   <tablist>
   <tab>Linux/macOS (bash, zsh)</tab>
   <tab>Windows (PowerShell)</tab>
   </tablist>
   <tabpanel>

   ```bash
   openstack vpn ipsec site connection create <имя VPN-туннеля> \
     --dpd action=<действие при недоступности пира>,interval=<интервал проверки>,timeout <тайм-аут проверки> \
     --initiator <поведение при установке IPsec-соединения: bi-directional, response-only> \
     --peer-address "<адрес пира VPN>" \
     --peer-id "<идентификатор пира VPN>" \
     --ikepolicy <идентификатор IKE-политики> \
     --ipsecpolicy <идентификатор IPsec-политики> \
     --vpnservice <идентификатор VPN-сервиса> \
     --local-endpoint-group <идентификатор локальной endpoint-группы> \
     --peer-endpoint-group <идентификатор удаленной endpoint-группы> \
     --psk "<ключ PSK>" \
     --enable
   ```
  
   </tabpanel>
   <tabpanel>

   ```powershell
   openstack vpn ipsec site connection create <имя VPN-туннеля> `
     --dpd action=<действие при недоступности пира>,interval=<интервал проверки>,timeout <тайм-аут проверки> `
     --initiator <поведение при установке IPsec-соединения> `
     --peer-address "<адрес пира VPN>" `
     --peer-id "<идентификатор пира VPN>" `
     --ikepolicy <идентификатор IKE-политики> `
     --ipsecpolicy <идентификатор IPsec-политики> `
     --vpnservice <идентификатор VPN-сервиса> `
     --local-endpoint-group <идентификатор локальной endpoint-группы> `
     --peer-endpoint-group <идентификатор удаленной endpoint-группы> `
     --psk "<ключ PSK>" `
     --enable
   ```

   </tabpanel>
   </tabs>

</tabpanel>
</tabs>

## Редактирование VPN-туннеля

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>OpenStack CLI</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **VPN**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного VPN-туннеля и выберите пункт **Редактировать VPN**.
1. При необходимости отредактируйте локальную или удаленную endpoint-группу:

   1. **Local Endpoint** — выберите локальную endpoint-группу из выпадающего списка. Если нужной группы нет, создайте новую:

      1. Выберите из выпадающего списка пункт `Новая endpoint-группа`.
      1. Задайте настройки группы:

         <tabs>
         <tablist>
         <tab>Neutron</tab>
         <tab>Sprut</tab>
         </tablist>
         <tabpanel>

         - **Имя** — имя локальной endpoint-группы.
         - **Подсети** — выберите одну или несколько подсетей, подключенных к выбранному ранее маршрутизатору. Эти подсети будут доступны через VPN-туннель.

         </tabpanel>
         <tabpanel>

         - **Имя** — имя локальной endpoint-группы.
         - **Адрес подсети** — укажите IP-адрес (CIDR) подсети, подключенной в выбранному ранее маршрутизатору. Эта подсеть будет доступна через VPN-туннель.
         - (Опционально) Для подключения дополнительной подсети нажмите **Добавить еще один CIDR** и укажите IP-адрес подсети, которая должна быть доступна через VPN-туннель.

         </tabpanel>
         </tabs>

   1. **Remote Endpoint** — выберите удаленную (remote) endpoint-группу из выпадающего списка. Если нужной группы нет, создайте новую:

      1. Выберите из выпадающего списка пункт `Новая endpoint-группа`.
      1. Задайте настройки группы:

         - **Имя группы**.
         - **Адрес подсети** — адрес удаленной (remote) подсети, которая будет доступна через VPN-туннель.

           При необходимости добавить еще несколько подсетей, нажмите на ссылку **Добавить подсеть**.

1. Нажмите кнопку **Следующий шаг**.
1. Отредактируйте настройки VPN-туннеля:

   1. Базовые настройки:

      - **Имя туннеля**.
      - **Публичный IPv4 адрес пира (Peer IP)**.
      - **Ключ совместного использования (PSK)**.

        При необходимости сгенерируйте ключ, нажав соответствующую кнопку.

        <info>

        Допустимые символы:
        - заглавные и строчные буквы латинского алфавита;
        - цифры;
        - спецсимволы `-`, `+`, `&`, `!`, `@`, `#`, `$`, `%`, `^`, `*`, `(`, `)`, `,`, `.`, `:`, `;`, `_`, `=`, `<`, `>`, `{`, `}`, `/`.

        Ключ должен содержать хотя бы одну букву или цифру.

        </info>

   1. (Опционально) расширенные настройки:

      - **Идентификатор маршрутизатора пира для аутентификации (Peer ID)** — по умолчанию совпадает с адресом пира.
      - (Только для VPN в SDN Sprut) **Селектор потоков траффика**:
         - **Объединить** — не расщеплять трафик-селекторы, то есть оборачивать все адресные префиксы в один туннель передачи данных;
         - **Разделить** — расщеплять трафик-селекторы, то есть для каждой пары адресных префиксов создавать отдельный туннель передачи данных.
      - **Состояние инициатора** — поведение при установке IPsec-соединения:

        - `bi-directional` (по умолчанию) — со стороны платформы VK Cloud будут производиться попытки установления соединения с удаленным пиром (remote peer).
        - `response-only` — платформа ожидает, что VPN-соединение будет инициировано удаленным пиром, и не пытается установить его самостоятельно.

      - Настройки обнаружения недоступности удаленного пира (Dead Peer Detection, DPD):

        - **При обнаружении недоступности пира** — определяет поведение платформы VK Cloud, если удаленный пир недоступен:

          - `hold` (по умолчанию) — при обнаружении недоступности IPsec-соединение разрывается. Соединение может быть переустановлено только удаленным пиром.
          - `clear` — при обнаружении недоступности IPsec-соединение разрывается. Соединение не будет переустановлено, даже если удаленный пир будет пытаться это сделать.
          - `restart` — при обнаружении недоступности IPsec-соединение разрывается. Платформа VK Cloud будет пытаться переустановить соединение с удаленным пиром.

        - **Интервал обнаружения недоступности пира** — с каким интервалом (в секундах) отправлять проверочные DPD-сообщения.

        - **Время для обнаружения недоступности пира** — если по истечении этого тайм-аута (в секундах) не было получено ни одного проверочного DPD-сообщения от удаленного пира, то он признается недоступным (dead).

          По умолчанию значение этого параметра в четыре раза больше, чем  **Интервал обнаружения недоступности пира**.

1. Нажмите кнопку **Сохранить**.

</tabpanel>
<tabpanel>

1. Убедитесь, что:

   1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli) `python-neutronclient`.
   1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli) в OpenStack CLI.

1. Посмотрите детальную информацию о VPN-туннеле, который нужно отредактировать.

1. (При необходимости) выберите другие endpoint-группы или создайте новые:

   1. Получите список endpoint-групп и посмотрите детальную информацию о них:

      ```bash
      openstack vpn endpoint group list
      ```

      ```bash
      openstack vpn endpoint group show <идентификатор группы>
      ```

      Запишите:
      - Идентификатор группы, которая будет использоваться VPN-туннелем в качестве локальной endpoint-группы. Такая группа должна иметь тип `subnet`.

        Подсети, принадлежащие группе, должны быть подключены к маршрутизатору, который указывался на предыдущем шаге в настройках VPN-сервиса.

      - Идентификатор группы, которая будет использоваться VPN-туннелем в качестве удаленной endpoint-группы. Такая группа должна иметь тип `cidr`.

   1. Если подходящей локальной endpoint-группы не нашлось, создайте ее:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn endpoint group create <имя локальной endpoint-группы> \
        --type subnet \
        --value <идентификатор подсети платформы VK Cloud, подключенной к маршрутизатору, которая должна быть доступна через VPN-туннель> \
        ...
        --value <идентификатор дополнительной подсети>
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn endpoint group create <имя локальной endpoint-группы> `
        --type subnet `
        --value <идентификатор подсети платформы VK Cloud, подключенной к маршрутизатору, которая должна быть доступна через VPN-туннель> `
        ...
        --value <идентификатор дополнительной подсети>
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор локальной endpoint-группы, которая будет использоваться VPN-туннелем.

   1. Если подходящей удаленной endpoint-группы не нашлось, создайте ее:

      <tabs>
      <tablist>
      <tab>Linux/macOS (bash, zsh)</tab>
      <tab>Windows (PowerShell)</tab>
      </tablist>
      <tabpanel>

      ```bash
      openstack vpn endpoint group create <имя удаленной endpoint-группы> \
        --type cidr \
        --value "<удаленная подсеть в формате 10.0.0.0/24, которая должна быть доступна через VPN-туннель>" \
        ...
        --value "<дополнительная удаленная подсеть>"
      ```

      </tabpanel>
      <tabpanel>

      ```powershell
      openstack vpn endpoint group create <имя удаленной endpoint-группы> `
        --type cidr `
        --value "<удаленная подсеть в формате 10.0.0.0/24, которая должна быть доступна через VPN-туннель>" `
        ...
        --value "<дополнительная удаленная подсеть>"
      ```

      </tabpanel>
      </tabs>

      После создания будет выведена информация о созданном объекте, включающая его идентификатор. Запишите идентификатор удаленной endpoint-группы, которая будет использоваться VPN-туннелем.

1. Отредактируйте настройки VPN-туннеля:

   <tabs>
   <tablist>
   <tab>Linux/macOS (bash, zsh)</tab>
   <tab>Windows (PowerShell)</tab>
   </tablist>
   <tabpanel>

   ```bash
   openstack vpn ipsec site connection set <идентификатор VPN-туннеля> \
     --name <новое имя VPN-туннеля> \
     --dpd action=<действие при недоступности пира>,interval=<интервал проверки>,timeout <тайм-аут проверки> \
     --initiator <поведение при установке IPsec-соединения: bi-directional, response-only> \
     --peer-address "<адрес пира VPN>" \
     --peer-id "<идентификатор пира VPN>" \
     --local-endpoint-group <идентификатор локальной endpoint-группы> \
     --peer-endpoint-group <идентификатор удаленной endpoint-группы> \
     --enable
   ```
  
   </tabpanel>
   <tabpanel>

   ```powershell
   openstack vpn ipsec site connection set <идентификатор VPN-туннеля> `
     --name <новое имя VPN-туннеля> `
     --dpd action=<действие при недоступности пира>,interval=<интервал проверки>,timeout <тайм-аут проверки> `
     --initiator <поведение при установке IPsec-соединения> `
     --peer-address "<адрес пира VPN>" `
     --peer-id "<идентификатор пира VPN>" `
     --local-endpoint-group <идентификатор локальной endpoint-группы> `
     --peer-endpoint-group <идентификатор удаленной endpoint-группы> `
     --enable
   ```

   </tabpanel>
   </tabs>

</tabpanel>
</tabs>

## Перезапуск VPN-туннеля

<info>

Перезапуск VPN-туннеля доступен только для VPN в SDN Neutron. В SDN Sprut все изменения туннеля применяются автоматически, перезапуск не требуется.

</info>

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>OpenStack CLI</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **VPN**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного VPN-туннеля и выберите пункт **Перезапустить VPN**.
1. Прочитайте предупреждение.
1. Нажмите кнопку **Перезагрузить**.

</tabpanel>
<tabpanel>

1. Убедитесь, что:

   1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli) `python-neutronclient`.
   1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli) в OpenStack CLI.

1. Посмотрите детальную информацию о VPN-туннеле, который нужно перезапустить.

1. Выполните команду:

   <tabs>
   <tablist>
   <tab>Linux/macOS (bash, zsh)</tab>
   <tab>Windows (PowerShell)</tab>
   </tablist>
   <tabpanel>

   ```bash
   openstack vpn service set <идентификатор VPN-сервиса> --disable && openstack vpn service set <идентификатор VPN-сервиса> --enable
   ```
  
   </tabpanel>
   <tabpanel>

   ```powershell
   openstack vpn service set <идентификатор VPN-сервиса> --disable; openstack vpn service set <идентификатор VPN-сервиса> --enable
   ```

   </tabpanel>
   </tabs>

</tabpanel>
</tabs>

## Удаление VPN-туннеля

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>OpenStack CLI</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. Перейдите в раздел **Виртуальные сети** → **VPN**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного VPN-туннеля и выберите пункт **Удалить VPN**.
1. Ознакомьтесь со списком удаляемых объектов.

   При удалении VPN-туннеля также будут удалены объекты, связанные с ним (если они не используются другими VPN-туннелями):

   - VPN-сервис, обслуживающий туннель;
   - IKE-политика и IPsec-политика;
   - локальная и удаленная endpoint-группы.

1. Нажмите кнопку **Подтвердить**.

</tabpanel>
<tabpanel>

1. Убедитесь, что:

   1. OpenStack CLI [установлен](/ru/tools-for-using-services/cli/openstack-cli) вместе с [дополнительным пакетом](/ru/tools-for-using-services/cli/openstack-cli) `python-neutronclient`.
   1. Вы можете [авторизоваться](/ru/tools-for-using-services/cli/openstack-cli) в OpenStack CLI.

1. Посмотрите список VPN-туннелей и найдите идентификатор туннеля, который нужно удалить.

1. Посмотрите подробную информацию о туннеле, который нужно удалить.

   Запишите следующие идентификаторы:

   - `IKE Policy` — идентификатор IKE-политики.
   - `IPSec Policy` — идентификатор IPsec-политики.
   - `Local Endpoint Group ID` — идентификатор локальной endpoint-группы.
   - `Peer Endpoint Group ID` — идентификатор удаленной (peer) endpoint-группы.
   - `VPN Service` — идентификатор VPN-сервиса, который обслуживает этот VPN-туннель.

1. Чтобы удалить только VPN-туннель, выполните команду:

   ```bash
   openstack vpn ipsec site connection delete <идентификатор VPN-туннеля>
   ```

1. Чтобы удалить VPN-туннель и все связанные с ним объекты, выполните команду:

   <tabs>
   <tablist>
   <tab>Linux/macOS (bash, zsh)</tab>
   <tab>Windows (PowerShell)</tab>
   </tablist>
   <tabpanel>

   ```bash
   openstack vpn ipsec site connection delete <идентификатор VPN-туннеля>
   openstack vpn ike policy delete <идентификатор IKE-политики>
   openstack vpn ipsec policy delete <идентификатор IPsec-политики>
   openstack vpn endpoint group delete <идентификатор локальной endpoint-группы>
   openstack vpn endpoint group delete <идентификатор удаленной (peer) endpoint-группы>
   openstack vpn service delete <идентификатор VPN-сервиса, который обслуживает этот VPN-туннель 
   
   ```

   </tabpanel>
   <tabpanel>

   ```powershell
   openstack vpn ipsec site connection delete <идентификатор VPN-туннеля>; `
   openstack vpn ike policy delete <идентификатор IKE-политики>; `
   openstack vpn ipsec policy delete <идентификатор IPsec-политики>; `
   openstack vpn endpoint group delete <идентификатор локальной endpoint-группы>; `
   openstack vpn endpoint group delete <идентификатор удаленной (peer) endpoint-группы>; `
   openstack vpn service delete <идентификатор VPN-сервиса, который обслуживает этот VPN-туннель>
   ```

   </tabpanel>
   </tabs>

</tabpanel>
</tabs>
