Управление [Anycast IP-адресами](../../../concepts/ips-and-inet#anycast-ip) доступно в личном кабинете VK Cloud и через [API](/ru/tools-for-using-services/api/api-spec/api-anycast).

## {heading(Добавление Anycast IP-адреса)[id=add]}

{tabs}

{tab(Личный кабинет)}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, в который нужно добавить маршрутизацию Anycast.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Нажмите кнопку **Добавить IP в проект** или **Добавить IP-адрес**, если в проект еще не добавлен ни один Anycast IP-адрес.
1. В открывшемся окне задайте название и нажмите кнопку **Добавить**.
1. [Привяжите](#associate) IP-адреса серверов или балансировщиков к Anycast IP-адресу.
1. (Опционально) [Добавьте](#add-healthcheck) правило проверки работоспособности серверов или балансировщиков к Anycast IP-адресу.

{/tab}

{/tabs}

## {heading(Привязка IP-адресов к Anycast IP-адресу)[id=associate]}

{tabs}

{tab(Личный кабинет)}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный Anycast IP-адрес.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Откройте окно выбора IP-адресов одним из способов:

   - Нажмите на название Anycast IP-адреса, перейдите на вкладку **Привязанные IP-адреса** и нажмите кнопку **Привязать IP-адрес**.
   - Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного Anycast IP-адреса и выберите пункт **Привязать IP-адрес**.
   - Выберите нужный Anycast IP-адрес с помощью флажка и нажмите кнопку **Привязать IP-адрес**.
1. В открывшемся окне:

    1. Выберите из списка тип ресурса, из которого будут выбраны IP-адреса для привязки:
       - `Балансировщики нагрузки`: балансировщики должны размещаться в сети с доступом в интернет и не иметь привязки к [Floating IP-адресу](/ru/networks/vnet/concepts/ips-and-inet#floating-ip).
       - `Виртуальные машины`: ВМ должны иметь публичные IP-адреса во [внешних сетях](/ru/networks/vnet/concepts/net-types#external_net).
       - `Продвинутые маршрутизаторы`: интерфейсы маршрутизаторов должны иметь публичные IP-адреса во внешней сети (должна быть подключена опция SNAT).

       К одному Anycast IP-адресу можно привязать IP-адреса только из одного типа ресурса.
    1. Выберите с помощью флажков публичные IP-адреса, которые нужно привязать к Anycast IP-адресу. К одному Anycast IP-адресу можно привязать до восьми IP-адресов.
    1. Нажмите кнопку **Привязать**.

{/tab}

{/tabs}

## {heading(Отвязка IP-адресов от Anycast IP-адреса)[id=separate]}

{tabs}

{tab(Личный кабинет)}

Это групповая операция: при необходимости можно отвязать сразу несколько IP-адресов, выбрав их с помощью флажков.

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный Anycast IP-адрес.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Нажмите на название Anycast IP-адреса и перейдите на вкладку **Привязанные IP-адреса**.
1. Удалите привязанный IP-адрес одним из способов:

   - Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного IP-адреса и выберите пункт **Удалить**.
   - Выберите нужный IP-адрес с помощью флажка, затем нажмите кнопку **Удалить** над таблицей.
1. Подтвердите удаление.

{/tab}

{/tabs}

## {heading(Добавление проверки работоспособности)[id=add-healthcheck]}

Если включить эту проверку, Anycast IP-адрес будет регулярно проверять доступность и работоспособность серверов и балансировщиков по заданному порту.

{note:warn}

Без включенной проверки трафик может направляться к нерабочему узлу, что приведет к потере данных или недоступности сервиса.

{/note}

{tabs}

{tab(Личный кабинет)}

Чтобы добавить правило проверки работоспособности:

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный Anycast IP-адрес.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Добавьте правило одним из способов:

    - Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного Anycast IP-адреса и выберите пункт **Добавить правило**.
    - Нажмите на название Anycast IP-адреса и перейдите на вкладку **Правило**, затем нажмите кнопку **Добавить правило**.
1. Выберите тип мониторинга: `TCP` или `ICMP`.

   Если к Anycast IP-адресу привязаны IP-адреса виртуальных машин, то для выбора доступны оба значения. Для IP-адресов продвинутых маршрутизаторов и балансировщиков нагрузки доступен только мониторинг по протоколу ICMP.
1. Если вы выбрали мониторинг по протоколу TCP, задайте порт для проверки работоспособности. Задается одно значение для всей группы связанных IP-адресов.
1. Нажмите **Сохранить**.

{/tab}

{/tabs}

{note:info}

 Для Anycast IP-адресов, к которым привязаны IP-адреса балансировщиков нагрузки, правило проверки работоспособности создается автоматически при привязке IP-адресов.

{/note}

Для виртуальных машин, IP-адреса которых указаны на вкладке **Правило**, [разрешите](../../secgroups) входящий трафик с IP-адреса `169.254.169.100/32` на заданный порт. Это технический адрес VK Cloud для проверки доступности сервиса. Если файервол ограничит доступ к порту ВМ с этого адреса, сервис Anycast IP отметит ВМ как недоступную и не будет отправлять трафик на нее.

## {heading(Изменение правила проверки работоспособности)[id=edit-healthcheck]}

{tabs}

{tab(Личный кабинет)}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный Anycast IP-адрес.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Нажмите на название Anycast IP-адреса и перейдите на вкладку **Правило**.
1. Нажмите кнопку **Редактировать правило**.
1. Выберите тип мониторинга: `TCP` или `ICMP`.

   Если к Anycast IP-адресу привязаны IP-адреса виртуальных машин, то для выбора доступны оба значения. Для IP-адресов продвинутых маршрутизаторов доступен только мониторинг по протоколу ICMP.
1. Если вы выбрали мониторинг по протоколу TCP, измените TCP-порт для проверки работоспособности.
1. Нажмите **Сохранить**.

{/tab}

{/tabs}

{note:warn}

Изменить правило для Anycast IP-адресов, к которым привязаны IP-адреса балансировщиков нагрузки, невозможно.

{/note}

## {heading(Переименование Anycast IP-адреса)[id=edit]}

{tabs}

{tab(Личный кабинет)}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный IP-адрес.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Переименуйте Anycast IP-адрес одним из способов:

    - Нажмите на название нужного Anycast IP-адреса, затем нажмите кнопку **Редактировать**.
    - Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного Anycast IP-адреса и выберите пункт **Редактировать**.
1. В открывшемся окне измените название.
1. Нажмите кнопку **Сохранить**.

{/tab}

{/tabs}

## {heading(Удаление Anycast IP-адреса)[id=delete]}

{tabs}

{tab(Личный кабинет)}

Это групповая операция: при необходимости можно удалить сразу несколько Anycast IP-адресов, выбрав их с помощью флажков.

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный Anycast IP-адрес.
1. Перейдите в раздел **Виртуальные сети** → **IP-адреса**.
1. Перейдите на вкладку **Anycast IP**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного Anycast IP-адреса и выберите пункт **Удалить**.
1. Подтвердите удаление.

{/tab}

{/tabs}
