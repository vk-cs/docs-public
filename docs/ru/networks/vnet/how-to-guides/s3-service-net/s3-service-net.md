[Сервисная сеть](/ru/networks/vnet/concepts/net-types#service_net) позволяет работать с объектным хранилищем Cloud Storage без доступа в интернет. Вы можете подключить к объектному хранилищу серверы, которые находятся в приватной облачной сети или подключены к VK Cloud через [Direct Connect](/ru/networks/directconnect/connect).

В статье показан пример настройки сервисной сети для доступа к Cloud Storage из ВМ.

Для простоты настройки ВМ будет подключена к публичной сети, чтобы иметь доступ по SSH. Подключение к сервисной сети может быть настроено и без доступа по SSH. В этом случае все настройки производятся через VNC-консоль.

<info>

Если вы настраиваете подключение к сервисной сети через Direct Connect, доступ к ВМ по SSH доступен без публичной сети.

</info>

## Подготовительные шаги

1. Обратитесь в [техническую поддержку](/ru/contacts), чтобы добавить сервисную сеть в свой проект.

    Запишите имя и IP-адрес сети. В этом примере — `s3-ephn` и `198.18.0.0/20`.

1. [Создайте бакет](/ru/storage/s3/service-management/buckets/create-bucket) в сервисе Cloud Storage, если этого еще не сделано.
1. [Создайте аккаунт](/ru/storage/s3/service-management/access-management/access-keys) в сервисе Cloud Storage, если этого еще не сделано. Сохраните идентификатор ключа и секретный ключ.
1. Подготовьте ВМ, из которой нужно подключить доступ к Cloud Storage:

    1. [Создайте ВМ](/ru/computing/iaas/service-management/vm/vm-create) со следующими параметрами:

        - **Операционная система**: в этом примере используется ОС Ubuntu. Вы можете использовать другую ОС, но настройка сети в ней будет отличаться.
        - **Сеть**: любая сеть с доступом в интернет.
        - **Настройки Firewall**: `default`, `ssh`.
        - **Назначить внешний IP**: включите опцию.
        - **Использовать резервное копирование**: отключите опцию для экономии средств.
        - Остальные настройки выберите по своему усмотрению.
    1. [Подключите](/ru/computing/iaas/service-management/vm/vm-add-net#podklyuchenie_seti_k_vm) сервисную сеть к ВМ. Выберите сервисную сеть, которая была добавлена в ваш проект. В этом примере — `s3-ephn`. Остальные параметры оставьте по умолчанию.
    1. На вкладке **Сети** посмотрите IP-адрес и MAC-адрес подключения сервисной сети к ВМ. Запишите их. В этом примере — `198.18.14.1` и `fa:16:3e:d8:86:43`.
    1. [Подключитесь](/ru/computing/iaas/service-management/vm/vm-connect/vm-connect-nix) к ВМ по SSH.
    1. Обновите пакеты до актуальной версии и перезагрузите ВМ с помощью команд:

        ```bash
        sudo apt update && sudo apt upgrade -y
        sudo reboot
        ```

    1. (Опционально) Установите утилиту [Netplan](https://www.altlinux.org/Netplan) для работы с сетевыми настройками. В виртуальных машинах с ОС Ubuntu 18 и выше эта утилита установлена по умолчанию.
    1. [Настройте AWS CLI](/ru/storage/s3/connect/s3-cli) для работы с Cloud Storage.

## 1. Настройте подключение к сервисной сети

После подключения сервисной сети к ВМ у нее появится новый сетевой интерфейс. В сервисной сети нет DHCP, поэтому интерфейс нужно настроить вручную.

Чтобы настроить сетевой интерфейс ВМ, направленный в сервисную сеть:

1. Откройте сессию терминала с ВМ и получите права root-пользователя:

    ```bash
    sudo bash
    ```

1. Посмотрите список сетевых интерфейсов ВМ:

    ```bash
    ip a
    ```

    В списке найдите интерфейс, MAC-адрес которого совпадает с MAC-адресом интерфейса подключения к сервисной сети в личном кабинете.

    Пример ответа:

    ```bash
    ens7: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000
    link/ether fa:16:3e:d8:86:43 brd ff:ff:ff:ff:ff:ff
    altname enp0s7
    ```
1. Создайте новый файл конфигурации сетевого интерфейса для Netplan:

    ```bash
    nano /etc/netplan/service.yaml
    ```

1. Укажите и сохраните следующие сетевые настройки в файле конфигурации:

    ```yaml
    network:
    version: 2
    ethernets:
        ens7:
            addresses:
            - 198.18.14.1/20
            match:
                macaddress: fa:16:3e:d8:86:43
            mtu: 1500
            set-name: ens7
    ```

    Здесь:

    - `ens7` — название интерфейса ВМ, который направлен в сервисную сеть;
    - `addresses` — IP-адрес сервисной сети;
    - `macaddress` — MAC-адрес сервисной сети.

1. Примените настройки, выполнив команду:

    ```bash
    netplan apply
    ```

1. Перенаправьте трафик Cloud Storage через сервисную сеть. Для этого укажите соответствие между доменом сервиса и его IP-адресом в сервисной сети:

    1. Откройте файл `hosts`:

        ```bash
        nano /etc/hosts
        ```

    1. Добавьте в файл строку и сохраните изменения:

        ```txt
        198.18.0.1   hb.ru-msk.vkcloud-storage.ru
        ```

1. Проверьте, что подключение к Cloud Storage устанавливается через сервисную сеть:

    ```bash
    curl hb.ru-msk.vkcloud-storage.ru -v
    ```

    В ответе должна быть строка:

    ```bash
    Connected to hb.ru-msk.vkcloud-storage.ru (198.18.0.1) port 80 (#0)
    ```

## 2. (Опционально) Отключите публичную сеть

Если доступ к ВМ по SSH вам больше не нужен, [отключите](/ru/computing/iaas/service-management/vm/vm-add-net#udalenie_seti_vm) сеть с доступом в интернет, которая была добавлена при создании ВМ.

## 3. Проверьте подключение к сервису Cloud Storage

1. Подключитесь к ВМ:
   
    - [Через VNC-консоль](/ru/computing/iaas/service-management/vm/vm-console), если публичная сеть была отключена.
    - [По SSH](/ru/computing/iaas/service-management/vm/vm-connect/vm-connect-nix), если публичная сеть не была отключена.
1. Выполните команду:

    ```bash
    aws s3 ls --endpoint-url https://hb.ru-msk.vkcloud-storage.ru
    ```

    Здесь `--endpoint-url` — домен сервиса Cloud Storage, должен соответствовать [региону](/ru/tools-for-using-services/account/concepts/regions) аккаунта. Возможные значения:

      - `https://hb.ru-msk.vkcloud-storage.ru` — домен региона Москва;
      - `https://hb.kz-ast.bizmrg.com` — домен региона Казахстан.

    В ответе должен вернуться список бакетов Cloud Storage.

## Удалите неиспользуемые ресурсы

Если созданные ресурсы вам больше не нужны, удалите их:

1. [Удалите](/ru/computing/iaas/service-management/vm/vm-manage#delete_vm) виртуальную машину.
1. [Удалите](/ru/networks/vnet/service-management/net#udalenie_seti) сети, в которых была размещена ВМ.
