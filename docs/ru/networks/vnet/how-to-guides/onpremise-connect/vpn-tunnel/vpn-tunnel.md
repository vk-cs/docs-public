VK Cloud позволяет устанавливать сетевую связность между инфраструктурой on-premises и виртуальной сетью VK Cloud с [SDN Neutron](/ru/networks/vnet/concepts/sdn#neutron) при помощи VPN-туннеля.

Для примера будет построен VPN-туннель на основе стандартного маршрутизатора до другой сети в VK Cloud. В качестве VPN-эндпоинта будет использоваться виртуальная машина. Инструкции по настройке VPN-туннеля можно адаптировать под работу с любым другим VPN-эндпоинтом, например, корпоративным файерволом или другим сетевым оборудованием.

VPN-туннель в примере будет связывать следующие сети:

- Клиентская сеть — сеть в VK Cloud, которая имитирует сеть в инфраструктуре on-premises.
- Виртуальная сеть — сеть в VK Cloud, подключенная к стандартному маршрутизатору.

В каждой сети будут созданы виртуальные машины для проверки работоспособности туннеля.

{note:warn}
Далее приведен пример настройки VPN-туннеля для сетей с SDN [Neutron](/ru/networks/vnet/concepts/sdn#neutron).
В сетях с SDN [Sprut](/ru/networks/vnet/concepts/sdn#sprut) соединение виртуальной сети VK Cloud с клиентской сетью настраивается при помощи [продвинутого маршрутизатора](/ru/networks/vnet/how-to-guides/onpremise-connect/advanced-router).
{/note}

## Подготовительные шаги

1. Убедитесь, что клиент OpenStack [установлен](/ru/tools-for-using-services/cli/openstack-cli#1_ustanovite_klient_openstack), и [пройдите аутентификацию](/ru/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu) в проекте.

1. [Создайте](/ru/networks/vnet/instructions/net#sozdanie_seti) сети.

   {note:info}

   Можно создать сеть с любыми параметрами на ваш выбор. Скорректируйте дальнейшие шаги в этом сценарии при необходимости.

   {/note}

   {tabs}

   {tab(Клиентская сеть)}

   Эта сеть будет выступать в роли клиентской сети.

   При создании сети задайте следующие параметры:

   - **Название сети**: `clientNet`.
   - **SDN**: `Neutron`. По умолчанию создается SDN Sprut.
   - **Доступ в интернет**: убедитесь, что эта опция выбрана. Она позволит назначить виртуальным машинам в этой сети публичные Floating IP-адреса.
   - **Маршрутизатор**: `Создать новый`.
   - **Список подсетей**: отредактируйте единственную подсеть в списке. Задайте следующие параметры для подсети:

     - **Имя**: `clientSubnet`.
     - **Адрес**: `172.16.0.0/29`.
     - **Шлюз**: `172.16.0.1`.
     - **Включить DHCP**: убедитесь, что эта опция выбрана.
     - **Пул DHCP IP-адресов**: `172.16.0.2 - 172.16.0.6`.
     - **Приватный DNS**: убедитесь, что эта опция выбрана.

   {/tab}

   {tab(Виртуальная сеть)}

   Эта сеть будет выступать в роли виртуальной сети.

   При создании сети задайте следующие параметры:

   - **Название сети**: `vkcloudNet`.
   - **SDN**: `Neutron`. По умолчанию создается SDN Sprut.
   - **Доступ в интернет**: убедитесь, что эта опция выбрана. Она позволит обеспечить работу VPN-туннеля и назначить виртуальным машинам в этой сети публичные Floating IP-адреса.
   - **Маршрутизатор**: `Создать новый`.
   - **Список подсетей**: отредактируйте единственную подсеть в списке. Задайте следующие параметры для подсети:

     - **Имя**: `vkcloudSubnet`.
     - **Адрес**: `10.0.0.0/29`.
     - **Шлюз**: `10.0.0.1`.
     - **Включить DHCP**: убедитесь, что эта опция выбрана.
     - **Пул DHCP IP-адресов**: `10.0.0.2 - 10.0.0.6`.
     - **Приватный DNS**: убедитесь, что эта опция выбрана.

   {/tab}

   {/tabs}

1. Определите, какие маршрутизаторы были созданы для этих сетей. Эта информация понадобится для дальнейшей настройки VPN.

   Далее предполагается, что:

   - для сети `clientNet` был создан маршрутизатор `router_1234`;
   - для сети `vkcloudNet` был создан маршрутизатор `router_5678`.

1. Определите IP-адрес интерфейса `SNAT` для маршрутизатора `router_5678`:

   1. Откройте страницу со списком подсетей для сети `vkcloudNet`.
   1. Нажмите на имя подсети `vkcloudSubnet`.
   1. Перейдите на вкладку **Порты**.
   1. Найдите в списке портов порт устройства `SNAT` и скопируйте его IP-адрес.

      {note:info}

      Если вы не находите в списке порт устройства `SNAT`, убедитесь в том, что при создании виртуальной сети выбрана SDN Neutron.

      {/note}

1. Создайте виртуальную машину, которая будет выступать в качестве VPN-шлюза в клиентской сети `clientNet`, со следующими параметрами:

   - **Имя виртуальной машины**: `client_vpn_gw`.
   - **Тип виртуальной машины**: `STD3-2-4`.
   - **Количество машин в конфигурации**: одна.
   - **Операционная система**: `Ubuntu 22.04`.
   - **Сеть**: клиентская сеть и соответствующая подсеть `clientNet: clientSubnet`.
   - **Ключ виртуальной машины**: ключ, с помощью которого будет выполняться подключение по SSH.
   - **Настройки Firewall**: все разрешено (`all`).
   - **Назначить внешний IP**: убедитесь, что эта опция выбрана.

   Прочие параметры виртуальной машины выберите на свое усмотрение.

1. Соберите сведения, необходимые для дальнейшей работы. Далее предполагается, что:

   | Объект                                                               | Значение        |
   | ---------------------------------------------------------------------| --------------- |
   | Публичный IP-адрес маршрутизатора `router_5678`                      | `192.0.2.100`   |
   | IP-адрес виртуальной машины `client_vpn_gw` в подсети `clientSubnet` | `172.16.0.5`    |
   | Floating IP-адрес виртуальной машины `client_vpn_gw`                 | `192.0.2.200`   |
   | Клиентская подсеть со стороны клиентского VPN-шлюза `client_vpn_gw`  | `172.16.0.0/29` |
   | Виртуальная подсеть со стороны облачного VPN-шлюза                   | `10.0.0.0/29`   |
   | IP-адрес порта `SNAT` в облачной подсети                             | `10.0.0.5`      |


![Example Infrastructure](assets/vpn-tunnel.png){params[noBorder=true]}

## 1. Настройте VPN-туннель на стороне облачной сети

[Создайте VPN-туннель](/ru/networks/vnet/instructions/vpn) со следующими параметрами:

{tabs}

{tab(1. Настройка IKE)}

Выберите **IKE-политика** — `Новая IKE-политика`, и задайте:

- **Имя политики**: `vkcloud-client-ike`.
- **Время жизни ключа**: 3600 секунд.
- **Алгоритм авторизации**: `sha256`.
- **Алгоритм шифрования**: `aes-256`.
- **Версия IKE**: `v2`.
- **Группа Диффи-Хеллмана**: `group14`.

{/tab}

{tab(2. Настройка IPsec)}

Выберите **IPsec-политика** — `Новая IPsec-политика`, и задайте:

- **Имя политики**: `vkcloud-client-ipsec`.
- **Время жизни ключа**: 3600 секунд.
- **Алгоритм авторизации**: `sha256`.
- **Алгоритм шифрования**: `aes-256`.
- **Группа Диффи-Хеллмана**: `group14`.

{/tab}

{tab(3. Создание Endpoint Groups)}

Выберите:

- **Маршрутизатор**: `router_5678`.

- **Local Endpoint**: `Новая endpoint-группа`.
  - **Имя**: `vkcloud-endpoint-group`.
  - **Подсети**: `vkcloudSubnet`.

- **Remote Endpoint**: `Новая endpoint-группа`.
  - **Имя группы**: `client-endpoint-group`.
  - **Адрес подсети**: `172.16.0.0/29`.

{/tab}

{tab(4. Настройка туннеля)}

Выберите **Настройки** — `Базовые`, и задайте:

- **Имя туннеля**: `vkcloud-client-vpn`.
- **Публичный IPv4 адрес пира (Peer IP)**: `192.0.2.200`.
- **Ключ совместного использования (PSK)**: любой ключ совместного использования, удовлетворяющий требованиям.

  Ключ должен:

  - быть длиной не менее 16 символов;
  - содержать хотя бы одну букву или цифру;
  - состоять только из следующих допустимых символов:
    - заглавные и строчные буквы латинского алфавита;
    - цифры;
    - спецсимволы `-`, `+`, `&`, `!`, `@`, `#`, `$`, `%`, `^`, `*`, `(`, `)`, `,`, `.`, `:`, `;`, `_`, `=`, `<`, `>`, `{`, `}`, `/`.

{/tab}

{/tabs}

## 2. Настройте VPN-туннель на стороне клиентской сети

1. Отключите [IP Source Guard](/ru/networks/vnet/concepts/traffic-limiting#source_guard) для порта VPN-шлюза, чтобы он мог пересылать любой трафик:

   1. Найдите порт с приватным IP-адресом `172.16.0.5` виртуальной машины `client_vpn_gw`. [Получите](/ru/networks/vnet/instructions/ports#prosmotr_spiska_portov_i_informacii_o_nih) идентификатор этого порта.

   1. Разрешите прохождение трафика с любых адресов через этот порт:

      ```console
      openstack port set <ИДЕНТИФИКАТОР_ПОРТА> --allowed-address ip-address=0.0.0.0/0
      ```

1. Подключитесь к виртуальной машине `client_vpn_gw` по SSH. Все дальнейшие действия должны выполняться на этой виртуальной машине.

1. Включите IP Forwarding, чтобы виртуальная машина могла маршрутизировать трафик из приватной сети в VPN-туннель:

   ```console
   echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.conf
   sudo sysctl -p

   ```

1. Установите StrongSwan — реализацию IPsec VPN для Linux:

   ```console
   sudo apt update
   sudo apt install -y strongswan libcharon-extra-plugins libcharon-extauth-plugins libstrongswan-extra-plugins

   ```

1. Добавьте параметры VPN-соединения со стороны клиентской сети в файл `/etc/ipsec.conf`. Эти параметры — зеркальное отражение настроек туннеля, сделанных [на стороне облачной сети ](#1_nastroyte_vpn_tunnel_na_storone_oblachnoy_seti).

   ```ini
   conn client-vkcloud-vpn
      authby=secret
      left=%defaultroute
      leftid=192.0.2.200
      leftsubnet=172.16.0.0/29
      right=192.0.2.100
      rightsubnet=10.0.0.0/29
      ike=aes256-sha2_256-modp2048!
      esp=aes256-sha2_256!
      keyingtries=0
      ikelifetime=3600
      lifetime=8h
      dpddelay=30
      dpdtimeout=120
      dpdaction=hold
      auto=start
   ```

   {note:info}

   Для группы Диффи-Хеллмана `group14` эквивалентное обозначение — `modp_2048`. Соответствие `modp` именам групп приводится в [RFC 3526](https://www.rfc-editor.org/rfc/rfc3526).

   {/note}

1. Укажите в файле `/etc/ipsec.secrets` ключ совместного использования (PSK). Ключ должен совпадать с ключом, указанным [на стороне облачной сети](#1_nastroyte_vpn_tunnel_na_storone_oblachnoy_seti):

   ```ini
   192.0.2.200 192.0.2.100 : PSK "<КЛЮЧ_СОВМЕСТНОГО_ИСПОЛЬЗОВАНИЯ_ЗАДАННЫЙ_ЗАРАНЕЕ>"
   ```

    {note:warn}

    Некоторые спецсимволы, например `#`, `&` или `{`, могут интерпретироваться операционной системой. В этом случае ключ будет некорректным и VPN-туннель не заработает, поэтому обязательно экранируйте ключ с помощью символов `""`.

    Пример:

    ```plaintext
    192.0.2.200 192.0.2.100 : PSK "k7@Jm4Px&9Lq#Wn2!v5*Cz8$Ys3%Ft6^Rg1=Hd0+Bl9}Qw7{Ko5&Np3@Xr1*Mj4"
    ```

   {/note}

1. Перезапустите сервис StrongSwan:

   ```console
   sudo systemctl restart strongswan-starter
   ```

## 3. Добавьте статические маршруты

Чтобы трафик проходил через VPN-туннель, требуется добавить статические маршруты:

{tabs}

{tab(На стороне облачной сети)}

1. Откройте в личном кабинете страницу со списком подсетей для сети `vkcloudNet`.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для подсети `vkcloudSubnet` и выберите пункт `Редактировать подсеть`.
1. Убедитесь, что выбрана опция **Показывать поле статических маршрутов**.
1. В поле пропишите статический маршрут до клиентской сети `172.16.0.0/29`. В качестве next hop требуется указать IP-адрес интерфейса `SNAT` маршрутизатора `router_5678` в облачной подсети `vkcloudSubnet`.

   ```text
   172.16.0.0/29 - 10.0.0.5
   ```

{/tab}

{tab(На стороне клиентской сети)}

1. Откройте в личном кабинете страницу с информацией о маршрутизаторе `router_1234`, к которому подключены клиентская подсеть `clientSubnet` и VPN-шлюз `client_vpn_gw`.
1. На вкладке **Статические маршруты** нажмите кнопку **Добавить статический маршрут**.
1. Пропишите статический маршрут до облачной сети `10.0.0.0/29`:

   - **Сеть назначения**: `10.0.0.0/29`.
   - **Промежуточный узел (Next HOP)**: `172.16.0.5` (IP-адрес VPN-шлюза в клиентской подсети).

1. Нажмите кнопку **Добавить маршрут**.

{/tab}

{/tabs}

## 4. Проверьте работоспособность VPN-туннеля

1. Посмотрите состояние VPN-туннеля со стороны платформы VK Cloud.

   Для этого откройте страницу VPN `vkcloud-client-vpn` в личном кабинете и перейдите на вкладку **Параметры туннеля**. VPN должен находиться в статусе `ACTIVE`.

1. Создайте группу правил файервола `icmp`, разрешающую ICMP-трафик.

   В этой группе создайте входящее правило:

   - **Тип**: `ICMP`.
   - **Удаленный адрес**: `Все IP-адреса`.

   Это нужно, чтобы тестовые виртуальные машины могли пинговать друг друга.

1. Создайте две виртуальные машины:

   - `clientVM`:

     - в сети `clientNet`, подсети `clientSubnet`;
     - с Floating IP-адресом для подключения к ней по SSH;
     - с группами правил файервола `default`, `ssh`, `icmp`.

   - `vkcloudVM`:
     - в сети `vkcloudNet`, подсети `vkcloudSubnet`;
     - с Floating IP-адресом для подключения к ней по SSH;
     - с группами правил файервола `default`, `ssh`, `icmp`.

1. Определите приватные IP-адреса виртуальных машин в соответствующих подсетях. Пусть:

   - `clientVM` имеет IP-адрес `172.16.0.4`;
   - `vkcloudVM` имеет IP-адрес `10.0.0.4`.

1. Подключитесь к виртуальной машине `vkcloudVM` по SSH.

1. Выполните пинг виртуальной машины `clientVM` с виртуальной машины `vkcloudVM`:

   ```console
   ping 172.16.0.4
   ```

   Хост `clientVM` должен отвечать на пинг.

## Удалите неиспользуемые ресурсы

Если созданные ресурсы вам больше не нужны, удалите их:

1. [Удалите](/ru/computing/iaas/instructions/vm/vm-manage#delete_vm) виртуальные машины.
1. [Удалите](../../../instructions/vpn#udalenie_vpn_tunnelya) VPN-туннель.
1. [Удалите](../../../instructions/router#upravlenie_staticheskimi_marshrutami) статические маршруты, прописанные на стороне клиентской сети.

   {note:info}

   Статические маршруты на стороне облачной сети будут удалены вместе с подсетью, для которой они были прописаны.

   {/note}

1. [Удалите](../../../instructions/router#udalenie_marshrutizatora) маршрутизаторы клиентской и облачной сетей.
1. Удалите клиентскую и облачную [подсети](../../../instructions/net#udalenie_podseti) и [сети](../../../instructions/net#udalenie_seti).
1. [Удалите](../../../instructions/ip/floating-ip#delete) Floating IP-адреса.
