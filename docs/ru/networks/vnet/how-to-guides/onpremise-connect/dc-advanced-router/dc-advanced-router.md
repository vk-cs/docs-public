В руководстве описано, как связать сеть, которая находится в вашей локальной инфраструктуре, с виртуальными сетями и подсетями VK Cloud. Это будет выполнено с помощью выделенного канала связи Cloud Direct Connect и продвинутого маршрутизатора с использованием динамической маршрутизации по протоколу [BGP](https://datatracker.ietf.org/doc/html/rfc1163).

В этой конфигурации продвинутый маршрутизатор является единственным маршрутизатором в проекте и выступает в роли шлюза для виртуальных машин в подключенной к нему сети. Это наиболее простой способ организации сетевой связности с вашей локальной инфраструктурой и подойдет для тестирования или размещения в облаке приложения, не требующего отказоустойчивой сетевой связности.

Схема организации сетевой связности выглядит следующим образом:

![Схема организации сетевой связности](/ru/networks/vnet/how-to-guides/onpremise-connect/dc-advanced-router/assets/cdc_p1.png){params[noBorder=true]}

Ограничения конфигурации:

- Нельзя использовать [Floating IP-адрес](../../../concepts/ips-and-inet#floating-ip). В качестве альтернативы может быть настроена трансляция DNAT (Destination NAT).
- Нельзя подключить [PaaS-сервисы](/ru/intro/start/concepts/architecture), так как их развертывание требует доступа в интернет через [публичные IP-адреса](/ru/networks/vnet/concepts/ips-and-inet#pul_publichnyh_ip_adresov_vneshney_seti_internet) VK Cloud.
- Доступно только на проектах с SDN Sprut.

<info>

VK Cloud позволяет настроить разные [варианты подключения](../../../concepts/onpremise-connect) к удаленной инфраструктуре. Выбор варианта зависит от SDN проекта, доступа к интернету из удаленной инфраструктуры и требований к отказоустойчивости соединения.

</info>

## Подготовительные шаги

1. [Активируйте доступ по API](ru/tools-for-using-services/api/rest-api/enable-api#aktivaciya_dostupa_po_api), если этого еще не сделано.
1. Убедитесь, что клиент OpenStack [установлен](/ru/tools-for-using-services/cli/openstack-cli#1_ustanovite_klient_openstack), и [пройдите аутентификацию](/ru/tools-for-using-services/cli/openstack-cli#3_proydite_autentifikaciyu) в проекте.
1. Убедитесь, что на вашем компьютере установлены пакеты curl и jq.
1. Выберите клиентскую сеть в вашей локальной инфраструктуре:

   - Сеть должна быть подключена к маршрутизатору, который:
      - поддерживает соединение по BGP-протоколу;
      - (опционально) может поддерживать BFD-протокол: это позволит сократить время сходимости протоколов маршрутизации;
      - может быть устройством или виртуальной машиной в клиентской сети.
   - Сеть может не иметь доступа к интернету.

   Если подходящей сети нет, создайте ее.

   Запишите следующую информацию:

   - имя и IP-адрес подсети;
   - имя сети, в которой находится подсеть;
   - IP-адрес машины в подсети, которая будет использоваться для проверки связи между сетями;
   - имя BGP-маршрутизатора.

   <info>
   
   Для примера будет использована сеть с виртуальной машиной Router OS 7.10 (MikroTik), выполняющей функции BGP-маршрутизатора.

   </info>

1. Выберите или [создайте](/ru/networks/vnet/service-management/net#sozdanie_seti) виртуальную сеть в вашем проекте в VK Cloud. Сеть не должна быть подключена к маршрутизатору.

   Запишите следующую информацию:

   - имя и IP-адрес подсети;
   - имя сети, в которой находится подсеть.

1. [Создайте виртуальную машину](/ru/computing/iaas/service-management/vm/vm-create) в выбранной сети.

   Запишите IP-адрес ВМ.
1. Обратитесь в [техническую поддержку](/ru/contacts), чтобы подключить в ваш проект сеть [Cloud Direct Connect](../../../../directconnect), если этого еще не сделано.
1. Узнайте UUID подключенной сети:

    1. [Перейдите](https://cloud.vk.com/app/) в личный кабинет VK Cloud.
    1. Выберите проект.
    1. Перейдите в раздел **Виртуальные сети** → **Сети**.
    1. В списке сетей найдите сеть с именем `external-vni-10XXX`. Здесь `XXX` — индивидуальный порядковый номер вашего подключения.
    1. Сохраните UUID этой сети. В этом примере UUID сетевого стыка `b2b8468e-aaaa-bbbb-cccc-327c8c2670d4`.
1. Убедитесь, что собраны все сведения, необходимые для дальнейшей работы.

[cols="1,1,1,1", options="header"]
|===
|Объект
|Клиентская сеть
|Виртуальная сеть
|Сеть Direct Connect

|Сеть
|`customer-net`
|`vkcloud-net`
|`external-vni-10XXX`, `b2b8468e-aaaa-bbbb-cccc-327c8c2670d4`

|Подсеть
|`customer-subnet`, `10.0.0.0/24`
|`vkcloud-subnet`, `172.17.0.0/24`
|![](/ru/assets/no.svg "inline")

|Виртуальная машина
|`10.0.0.5`
|`172.17.0.8`
|![](/ru/assets/no.svg "inline")

|BGP-маршрутизатор
|`MikroTik`
|![](/ru/assets/no.svg "inline")
|![](/ru/assets/no.svg "inline")
|===

## 1. Добавьте транзитную подсеть

В сеть Cloud Direct Connect [добавьте](../../custom-subnet) транзитную подсеть с маской `/30`. Запишите имя и CIDR подсети. В этом примере: `dc-subnet`, `192.168.0.0/30`.

## 2. Добавьте продвинутый маршрутизатор

[Создайте](/ru/networks/vnet/service-management/advanced-router/manage-advanced-routers#add) продвинутый маршрутизатор со следующими параметрами:

- **Название**: в этом примере `Advanced router`;
- **SNAT**: опция выключена.

## 3. Настройте сетевые интерфейсы продвинутого маршрутизатора

1. [Добавьте](ru/networks/vnet/service-management/advanced-router/manage-interfaces#add) интерфейс продвинутого маршрутизатора, направленный в виртуальную сеть:

   - **Название**: `vkcloud-net-iface`;
   - **Подсеть**: `vkcloud-subnet`;
   - **IP-адрес интерфейса**: `172.17.0.100`.
1. Добавьте интерфейс продвинутого маршрутизатора, направленный в сеть Cloud Direct Connect:

   - **Название**: `dc-iface`;
   - **Подсеть**: `dc-subnet`;
   - **IP-адрес интерфейса**: `192.168.0.1`.

## 4. Настройте сетевые интерфейсы BGP-маршрутизатора клиентской сети

1. Добавьте сетевые интерфейсы:

   - Направленный в сеть Cloud Direct Connect — `dc-subnet`. Этот интерфейс поможет организовать связность между VK Cloud и клиентской сетью.
   - Направленный в клиентскую сеть, где расположен BGP-маршрутизатор. Эти интерфейсы используются для подключения к ресурсам внутри сети. Количество таких интерфейсов зависит от структуры сети.

   В этом примере:

   - `192.168.0.2` — интерфейс в подсеть `dc-subnet`;
   - `10.0.0.15` — интерфейс в клиентскую сеть до виртуальной машины `10.0.0.5`.

1. Настройте интерфейсы с использованием DHCP.

1. Настройте системный идентификатор (System ID).

1. Подготовьте список сетей для BGP-анонса.

1. (Опционально) Если маршрутизатор поддерживает BFD, настройте BFD-протокол.

<details>
    <summary>Пример настройки для MikroTik</summary>

1. Для добавления сетевых интерфейсов подключитесь к MikroTik по SSH и выполните команду:

   ```console
    /ip address add address=192.168.0.2/30 interface ether1
    /ip address add address=10.0.0.15/24 interface ether2
   ```

1. Настройте интерфейсы с использованием DHCP:

   ```console
    /ip dhcp-client
    add add-default-route=no interface=ether1
    add add-default-route=no interface=ether2
   ```

1. Настройте системный идентификатор (System ID):

   ```console
    /system identity
    set name=bgp-customer
   ```

1. Подготовьте список сетей для BGP-анонса:

   ```console
    /ip firewall address-list
    add address=10.0.0.0/24 list=bgp_networks
   ```

1. Настройте BFD-протокол:

   ```console
    /routing bfd configuration
    add disabled=no interfaces=ether1
   ```

</details>

## 5. Настройте eBGP-соседство для продвинутого маршрутизатора

Чтобы настроить связь по BGP-протоколу, нужно добавить динамические маршруты и указать BGP-соседей. Для настройки динамической маршрутизации требуются номера автономных сетей — ASN. Настройку следует выполнять с использованием приватных номеров ASN из диапазона `64512`–`65534`, при этом номер ASN на маршрутизаторах в VK Cloud и на стороне удаленной инфраструктуры должны отличаться. В примере будут использованы следующие номера:

- `65512` для сети `customer-net`;
- `64512` для сети `vkcloud-net`.

Чтобы настроить динамические маршруты на продвинутом маршрутизаторе:

1. В [личном кабинете](https://msk.cloud.vk.com/app/) перейдите в раздел **Виртуальные сети** → **Маршрутизаторы**.
1. Откройте добавленный продвинутый маршрутизатор и перейдите на вкладку **Динамическая маршрутизация**.
1. Нажмите кнопку **Создать BGP маршрутизатор**.
1. Укажите параметры BGP-маршрутизатора:

   - **Название**: `to-MikroTik`;
   - **Router ID**: `192.168.0.1`;
   - **ASN**: `64512`.

1. Нажмите кнопку **Создать**.
1. Откройте добавленный BGP-маршрутизатор и перейдите на вкладку **BGP соседи**.
1. Добавьте BGP-соседа. Укажите параметры:

   - **Название**: `MikroTik`;
   - **Remote neighbor**: `192.168.0.2`;
   - **Remote ASN**: `65512`.

1. Нажмите кнопку **Создать**.

Убедитесь, что маршрутизатор установил связь с соседом: маркер рядом с названием зеленый. Если вы используете BFD, убедитесь, что маркер BFD также горит зеленым.

Продвинутый маршрутизатор начнет передавать BGP-анонсы своему соседу сразу после успешного согласования BGP-соседства. Перейдите на вкладку **BGP анонсы** и убедитесь, что маршрутизатор передает анонсы всех сетей, в которые направлены его интерфейсы:

- `172.17.0.0/24`;
- `192.168.0.0/30`.

Оба анонса должны иметь зеленые маркеры.

## 6. Настройте BGP-соседство для маршрутизатора клиентской сети

1. Подключитесь в маршрутизатору в вашей локальной сети.
1. Укажите параметры для подключения по BGP-протоколу:

   - ASN локальной сети: `65512`;
   - ID маршрутизатора: `172.20.2.204`;
   - ASN внешней сети: `64512`;
   - ID BGP-соседа: `172.20.2.215`;
   - использовать BFD.
1. (Опционально) Проверьте, что установлена связь по BFD-протоколу.
1. Проверьте, что установлена связь с BGP-соседом. Если BGP соединение установлено, в ответе должны прийти значения `keepalive-time` и `uptime`, отличные от нуля.
1. Просмотрите все доступные BGP-маршруты. В списке маршрутов должны быть указаны сети `172.17.0.0/24` и `172.20.2.0/24`.

<details>
 <summary>Пример настройки для MikroTik</summary>

1. Подключитесь к MikroTik по SSH и выполните команду:

    ```console
    /routing bgp connection
    add address-families=ip as=65512 local.address=172.20.2.204 .role=ebgp name=bgp-customer output.network=bgp_networks remote.address=172.20.2.215 .as=64512 router-id=172.20.2.204 use-bfd=yes
    ```
1. Проверьте, что установлена связь по BFD-протоколу. Выполните команду:

   ```console
   /routing bfd session print
   ```

   Пример ответа:

   ```console
      Flags: U - up, I - inactive 
   0 U multihop=no vrf=main remote-address=172.20.2.215%ether1 local-address=172.20.2.204 state=up state-changes=1 uptime=3h27m12s desired-tx-interval=200ms actual-tx-interval=100ms 
     required-min-rx=200ms remote-min-rx=10ms multiplier=5 hold-time=1s packets-rx=75343 packets-tx=72203
   ```

1. Проверьте, что установлена связь с BGP-соседом на стороне MikroTik. Выполните команду:

   ```console
   /routing bgp session print
   ```

   Пример ответа:

   ```console
      Flags: E - established
   0 E name="tw-bgp-mikrotik-1"
        remote.address=172.20.2.215 .as=64512 .id=172.20.2.215 .capabilities=mp,rr,gr,as4,ap,err,llgr .hold-time=4m
       .messages=5 .bytes=131 .gr-time=120 .eor=ip
      local.address=172.20.2.204 .as=65512 .id=172.20.2.204 .capabilities=mp,rr,gr,as4 .messages=4 .bytes=105 .eor=""
        output.procid=20 .network=bgp_networks
       input.procid=20 ebgp
      hold-time=3m keepalive-time=1m uptime=2m51s380ms last-started=aug/28/2023 07:27:15
   ```
1. Выполните команду, чтобы посмотреть все маршруты MikroTik:

   ```console
   /ip route print where bgp
   ```

   Пример ответа:

   ```console
   Flags: D - DYNAMIC; A - ACTIVE; b, y - BGP-MPLS-VPN
   Columns: DST-ADDRESS, GATEWAY, DISTANCE
       DST-ADDRESS    GATEWAY       DISTANCE
   DAb 172.17.0.0/24  172.20.2.215        20
   D b 172.20.2.0/24  172.20.2.215        20   
   ```

</details>

## 7. Настройте статические маршруты между сетями

1. Настройте статический маршрут от виртуальной сети `vkcloud-net` до клиентской сети `customer-net` через продвинутый маршрутизатор:

   1. В [личном кабинете](https://msk.cloud.vk.com/app/) перейдите в раздел **Виртуальные сети** → **Сети**.
   1. Выберите сеть `vkcloud-net` и откройте свойства подсети.
   1. Выберите **Показывать поле статических маршрутов**.
   1. Укажите маршрут: `10.0.0.0/24 - 172.17.0.100`.
   1. Нажмите кнопку **Сохранить**.

1. Настройте статический маршрут от клиентской сети `customer-net` до виртуальной сети `vkcloud-net` через BGP-маршрутизатор клиентской сети. Маршрут должен быть к `172.17.0.0/24` через `10.0.0.15`.

1. Перезагрузите машины `172.17.0.8` и `10.0.0.5`, чтобы маршруты попали в их маршрутную сеть.

1. Проверьте, что статические маршруты прописаны на ВМ `172.17.0.8`, которая находится в виртуальной сети `vkcloud-net`:

   1. Откройте сессию терминала с ВМ `vkcloud-vm`.
   1. Выполните команду:

       ```console
       ip route
       ```

      В списке маршрутов должны быть указаны сети `10.0.0.0/24` и `172.20.2.0/24`.
1. Проверьте список маршрутов для машины `10.0.0.5`, которая находится в клиентской сети `customer-net`. В списке маршрутов должны быть указаны сети `172.17.0.0/24` и `172.20.2.0/24`.

## 8. Проверьте работоспособность

Для проверки отправьте `ping` или `traceout` до машины в противоположной сети. Если из другой сети приходит ответ, то настройка связности сетей выполнена правильно.

Например, выполните пинг с машины `172.17.0.8` в виртуальной сети до машины `10.0.0.5` в клиентской сети:

1. Откройте сессию терминала с ВМ `vkcloud-vm`.
1. Выполните пинг внутреннего IP-адреса машины в клиентской сети:

      ```console
      ping 10.0.0.5
      ```

IP-адрес должен отвечать на пинг.

## Удалите неиспользуемые ресурсы

Если созданные ресурсы вам больше не нужны, удалите их:

1. [Удалите](/ru/computing/iaas/service-management/vm/vm-manage#delete_vm) виртуальную машину.
1. [Удалите](/ru/networks/vnet/service-management/router#udalenie_marshrutizatora) маршрутизаторы.
1. Удалите [подсеть](/ru/networks/vnet/service-management/net#udalenie_podseti) и [сеть](/ru/networks/vnet/service-management/net#udalenie_seti), в которой была размещена ВМ.
