Вы можете создать CDN-ресурс двумя способами:

- [Через интерфейс сервиса CDN](#sozdanie_cherez_interfeys_servisa_cdn). Используйте этот вариант, если нужно указать сторонние [источники контента](../../concepts/about) или настроить SSL-сертификаты вручную.

- [Через интерфейс бакета](#sozdanie_cherez_interfeys_baketa) в сервисе [Cloud Storage](/ru/base/s3). Используйте этот вариант, чтобы бакет выступал в качестве источника контента. Соответствующий бакету CDN-ресурс будет создан автоматически, SSL-сертификаты также будут настроены автоматически.

## Создание через интерфейс сервиса CDN

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>API</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где нужно создать CDN-ресурс.
1. Перейдите в раздел **CDN → CDN-ресурсы**.
1. Нажмите кнопку **Создать ресурс**.
1. Выберите опцию **Доступ к контенту конечным пользователям**, чтобы повлиять на доступность CDN-ресурса:

   - (По умолчанию) Если эта опция не выбрана, то после создания CDN-ресурса он перейдет в состояние `Приостановлен`, контент не будет доставляться [потребителям](../../concepts/about).
   - Если эта опция выбрана, то после создания CDN-ресурса он перейдет в состояние `Активен`, контент будет доставляться потребителям.

   [Включить или отключить доступ](../manage-cdn/enable-cdn) к контенту можно и после создания CDN-ресурса.

1. Настройте взаимодействие CDN-ресурса с источниками:

   - **Протокол взаимодействия с источником:** протокол, по которому [CDN-серверы](../../concepts/about) будут запрашивать контент с источников. Доступны опции:

       - `HTTP` — контент на источнике доступен только по HTTP (80 порт) или источник поддерживает перенаправление с HTTPS на HTTP.
       - `HTTPS` — контент на источнике доступен только по HTTPS (443 порт) или источник поддерживает перенаправление с HTTP на HTTPS.
       - (По умолчанию) `HTTP и HTTPS` — контент на источнике доступен по HTTP и HTTPS. В этом случае в запросе от CDN к источнику сохранится протокол запроса конечного пользователя. При этом в кеше CDN будет храниться две версия файла для каждого протокола.

   - **Запрос контента:** с каких источников CDN-серверы будут запрашивать контент.

     Доступны опции:

     <tabs>
     <tablist>
     <tab>(По умолчанию) С одного источника</tab>
     <tab>С группы источников</tab>
     </tablist>
     <tabpanel>

     В параметре **Источник контента** укажите URL, по которому нужно обращаться к источнику:

     - URL может содержать только латинские буквы, цифры, символы `.` и `-`.
     - URL не должен содержать схему (`http://` или `https://`): она уже добавлена автоматически в виде `http(s)://`. Конкретный протокол определяется соответствующим параметром, который был настроен ранее.
     - В URL можно передать как доменное имя, так и IP-адрес. Также допустимо указать порт.
     - Максимальная длина всего URL — 255 символов. Максимальная длина поддомена — 63 символа.

     **Примеры:**

     - `203.0.113.222:8080`,
     - `images.example.com`.

     В процессе создания CDN-ресурса будет автоматически создана группа источников, которая состоит из одного источника с указанными параметрами.

     </tabpanel>
     <tabpanel>

     Выберите группу источников из выпадающего списка.

     Если нужной группы нет в списке:

     1. Выберите пункт **Добавить группу источников**.
     1. Задайте имя группы источников.
     1. Добавьте первый источник:

        {include(/ru/_includes/_cdn_add_origin.md)}

     1. (Опционально) Добавьте другие источники.

     1. (Опционально) Включите или выключите отдельные источники с помощью переключателя справа от типа источника.

        Нельзя выключить источник типа `Активный`, если это единственный источник такого типа в группе.

        Выключенный источник не будет использоваться при запросе контента CDN-серверами.

     1. (Опционально) Измените параметры отдельного источника, нажав на значок ![pencil-icon](./assets/pencil-icon.svg "inline") справа от типа источника.

     1. (Опционально) Удалите отдельный источник, нажав на значок ![trash-icon](./assets/trash-icon.svg "inline") справа от типа источника.

        Нельзя удалить источник типа `Активный`, если это единственный источник такого типа в группе.

     1. Убедитесь, что для доменов всех добавленных источников (в том числе выключенных) настроены DNS-записи.

        <warn>

        Если VK Cloud не сможет проверить доступность домена с помощью запроса к DNS, то группу источников создать не удастся.

        </warn>

     1. Выберите опцию **Использовать следующий источник из списка при 4XX и 5XX кодах на источнике**, чтобы повлиять на порядок выбора источника при запросе контента CDN-серверами.

        При выбранной опции CDN-серверы будут обращаться к следующим источникам из списка, если тот источник, к которому эти серверы обращаются, недоступен. Если все источники недоступны, CDN-серверы будут возвращать ответ последнего источника в списке при запросе контента. Подробнее о выборе источника читайте в разделе [Группы источников](../../concepts/origin-groups).

        Эта опция доступна, если в группе источников настроено более одного источника.

     1. Нажмите кнопку **Создать группу**.

     </tabpanel>
     </tabs>

1. В поле **Персональный домен** укажите персональный домен, который будет использоваться для CDN. При обращении к этому домену контент будет доставлен с помощью CDN. Используйте полное квалифицированное имя домена (FQDN). Не добавляйте к нему корневое доменное имя: допустима запись вида `cdn.example.com`, но не `cdn.example.com.`.

1. (Опционально) Нажмите кнопку ![plus-icon](./assets/plus-icon.svg "inline") **Добавить домен**, чтобы указать дополнительные персональные домены. Ненужные домены можно удалить, нажав на значок ![trash-icon](./assets/trash-icon.svg "inline") рядом с ними.

   <warn>

   После создания CDN-ресурса изменить персональные домены невозможно.

   </warn>

1. Сохраните имя оригинального домена, которое нужно задать в CNAME-записи для указанных доменов.

1. Выберите опцию, отвечающую за SSL-сертификат. Сертификат будет использоваться при доступе к настроенным ранее персональным доменам по HTTPS.

   Доступны опции:

   <tabs>
   <tablist>
   <tab>Не использовать</tab>
   <tab>(По умолчанию) Let's Encrypt</tab>
   <tab>Свой сертификат</tab>
   </tablist>
   <tabpanel>

   Сертификат не будет использоваться: к персональным доменам можно будет обращаться только по HTTP.

   </tabpanel>
   <tabpanel>

   Будет использоваться бесплатный сертификат [Let's Encrypt](https://letsencrypt.org/ru/).

   Сертификат будет создан после создания CDN-ресурса, когда станут доступны серверы-источники и в DNS будут распространены изменения, касающиеся CNAME-записей для персональных доменов. Обычно на это уходит до 30 минут.

   <warn>

   При выборе этой опции также необходимо выбрать опцию **Доступ к контенту конечным пользователям**.

   </warn>

   </tabpanel>
   <tabpanel>

   Будет использоваться выбранный из выпадающего списка сертификат.

   Чтобы сертификат стал доступен для выбора, [добавьте его в хранилище сертификатов](../manage-certificates).

   </tabpanel>
   </tabs>

1. Выберите, изменять ли значение HTTP-заголовка `Host` при обращении к настроенным ранее источникам.

   CDN-серверы указывают в HTTP-запросах обязательный заголовок [Host](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host), когда запрашивают контент с источников. Использование этого заголовка позволяет обращаться к нужному виртуальному хосту на источниках.

   Доступны опции:

   <tabs>
   <tablist>
   <tab>Не менять</tab>
   <tab>Кастомный</tab>
   <tab>(По умолчанию) Пересылать</tab>
   </tablist>
   <tabpanel>

   В качестве значения заголовка будет использоваться имя домена или IP-адрес первого источника из группы источников.

   **Пример:**

   Пусть настроена группа из двух источников:

   - `203.0.113.222:8080`,
   - `images.example.com`.

   Тогда при обращении CDN-серверов к любому из этих источников будет использоваться заголовок `Host: 203.0.113.222:8080`.

   </tabpanel>
   <tabpanel>

   В качестве значения заголовка будет использоваться указанное значение домена или IP-адреса.

   **Пример:**

   Пусть настроена группа из двух источников:

   - `203.0.113.222:8080`,
   - `images.example.com`.

   Также пусть для опции указано значение `content-source.example.org`.

   Тогда при обращении CDN-серверов к любому из этих источников будет использоваться заголовок `Host: content-source.example.org`.

   </tabpanel>
   <tabpanel>

   В качестве значения заголовка будет использоваться имя первого настроенного персонального домена.

   **Пример:**

   Пусть настроена группа из двух источников:

   - `203.0.113.222:8080`,
   - `images.example.com`.

   Также пусть настроено два персональных домена для CDN:

   - `cdn.contoso.com`,
   - `cdn.example.org`.

   Тогда при обращении CDN-серверов к любому из этих источников будет использоваться заголовок `Host: cdn.contoso.com`.

   </tabpanel>
   </tabs>

   <warn>

   Убедитесь, что источники могут обрабатывать запросы с заголовком `Host`, сформированным по указанным правилам.

   </warn>

1. Нажмите кнопку **Создать ресурс**.

</tabpanel>
<tabpanel>

Чтобы создать CDN-ресурс, воспользуйтесь [методом](/ru/additionals/api/api-cdn) `POST /projects/{project_id}/resources/`.

Пример запроса:

```json
curl --location --request POST 'https://msk.cloud.vk.com/api/cdn/api/v1/projects/examplef8f67/resources'\
--header 'X-Auth-Token: example6UjMOd'\
--header 'Content-Type: application/json'\
--data '{
   "cname": "cdn.example.com",
   "originGroup": 132,
   "secondaryHostnames": [
      "1.example.com",
      "2.example.com"
   ]
}'
```
</tabpanel>
</tabs>

## Создание через интерфейс бакета

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный бакет. Если у вас еще нет бакета, [создайте его](/ru/base/s3/instructions/buckets/create-bucket).
1. Перейдите в раздел **Объектное хранилище → Бакеты**.
1. Нажмите на имя нужного бакета.
1. Перейдите на вкладку **CDN**.
1. Выберите опцию **Использовать CDN для данного бакета**.

   Чтобы бакет мог выступать в качестве источника для CDN-ресурса, выбирайте ACL `public-read` при [добавлении объектов в этот бакет](/ru/base/s3/instructions/objects/upload-object).

1. В поле **Персональный домен** укажите персональный домен, который будет использоваться для CDN. При обращении к этому домену за контентом, контент будет доставлен с помощью CDN. Используйте полное квалифицированное имя домена (FQDN). Не добавляйте к нему корневое доменное имя: допустима запись вида `cdn.example.com`, но не `cdn.example.com.`.

1. (Опционально) Нажмите кнопку ![plus-icon](./assets/plus-icon.svg "inline") **Добавить домен**, чтобы указать дополнительные персональные домены. Ненужные домены можно удалить, нажав на значок ![trash-icon](./assets/trash-icon.svg "inline") рядом с ними.

   <warn>

   После создания CDN-ресурса изменить персональные домены невозможно.

   </warn>

1. Сохраните имя оригинального домена, которое нужно задать в CNAME-записи для указанных доменов.

1. Выберите нужное время жизни кеша из выпадающего списка.

   Этот параметр позволяет в течении заданного времени кешировать ответы со следующими статусами HTTP: [200](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/200), [201](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/201), [204](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/204), [206](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/206), [301](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/301), [302](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/302), [303](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/303), [304](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/304), [307](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/307), [308](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/308).

   Ответы с другими статусами не кешируются.

   (Опционально) Можно полностью выключить кеширование, выбрав пункт **Не кешировать**.

1. Нажмите кнопку **Сохранить изменения**.

   Начнется создание группы источников и CDN-ресурса для бакета. Созданные объекты будут доступны в разделе **CDN** личного кабинета.

</tabpanel>
</tabs>

## Подготовка CDN-ресурса к работе

1. Создайте CNAME-запись для CDN-ресурса. Это позволит изменить URL-адрес. Например, если вы используете CDN-ресурс для предоставления изображений своего веб-сайта, создайте CNAME-запись типа `images.example.com`, которая будет указывать на CDN-ресурс типа `cl-541e19d9.service.cdn.msk.vkcs.cloud`.

   Если вы используете сервис DNS от VK Cloud, следуйте [инструкции](/ru/networks/dns/publicdns#dobavlenie_resursnyh_zapisey).

   Если вы не сохранили оригинальный домен при создании, вы можете найти его в информации об CDN-ресурсе:

   {include(/ru/_includes/_open-cdn.md)}

1. Замените в пути до статических файлов оригинальный домен на персональный.

1. [Загрузите контент](../upload-content) в интерфейс VK Cloud (если CDN-ресурс создавался не из бакета).
