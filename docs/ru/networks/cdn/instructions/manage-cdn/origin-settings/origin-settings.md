## Изменение протокола взаимодействия с источником

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>API</tab>
</tablist>
<tabpanel>

{include(/ru/_includes/_open-cdn.md)}

1. Перейдите на вкладку **Основные настройки**.
1. Выберите протокол взаимодействия с источником:

    - `HTTP` — контент на источнике доступен только по HTTP (80 порт) или источник поддерживает перенаправление с HTTPS на HTTP.
    - `HTTPS` — контент на источнике доступен только по HTTPS (443 порт) или источник поддерживает перенаправление с HTTP на HTTPS.
    - `HTTP и HTTPS` — контент на источнике доступен по HTTP и HTTPS. В этом случае в запросе от CDN-ресурса к источнику сохранится протокол запроса конечного пользователя. При этом в кеше CDN-ресурса будут храниться две версии файла для каждого протокола.
1. Нажмите кнопку **Сохранить изменения**.

</tabpanel>
<tabpanel>

{include(/ru/_includes/_api_cdn_create_change.md)}

В теле запроса в параметре `originProtocol` пропишите значение:

- `HTTP` — контент на источнике доступен только по HTTP (80 порт) или источник поддерживает перенаправление с HTTPS на HTTP.
- `HTTPS` — контент на источнике доступен только по HTTPS (443 порт) или источник поддерживает перенаправление с HTTP на HTTPS.
- `MATCH` — контент на источнике доступен по HTTP и HTTPS. В этом случае в запросе от CDN-ресурса к источнику сохранится протокол запроса конечного пользователя. При этом в кеше CDN-ресурса будут храниться две версии файла для каждого протокола.

Пример запроса:

```json
curl --location --request PUT 'https://msk.cloud.vk.com/api/cdn/api/v1/projects/examplef8f67/resources/175281'\
--header 'X-Auth-Token: example6UjMOd'\
--header 'Content-Type: application/json'\
--data '{
    "originGroup": 267760,
    "originGroup_name": "exampleorigin",
    "secondaryHostnames": [],
    "originProtocol": "HTTPS"
}'
```

</tabpanel>
</tabs>

## Изменение источника данных

Настройка позволяет изменить источник, с которого CDN-ресурс будет забирать контент.

Если при создании CDN-ресурса был указан один источник, то автоматически создается группа источников, которая состоит из одного источника с указанными параметрами. Поэтому при редактировании CDN-ресурса доступно только изменение группы источников, выбор одного источника недоступен.

Чтобы изменить источник:

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>API</tab>
</tablist>
<tabpanel>

{include(/ru/_includes/_open-cdn.md)}

1. Перейдите на вкладку **Основные настройки**.
1. В параметре **Группа источников** выберите группу из выпадающего списка.

    Если нужной группы нет в списке:

     1. Выберите пункт **Добавить группу источников**.
     1. Задайте имя группы источников.
     1. Добавьте первый источник:

        {include(/ru/_includes/_cdn_add_origin.md)}

     1. (Опционально) Добавьте другие источники.

     1. (Опционально) Включите или выключите отдельные источники. Нельзя выключить `Активный` источник, если это единственный источник такого типа в группе. Выключенный источник не будет использоваться при запросе контента CDN-ресурсами.

     1. (Опционально) Измените параметры отдельного источника, нажав на значок ![pencil-icon](/ru/assets/pencil-icon.svg "inline") справа от типа источника.

     1. (Опционально) Удалите отдельный источник, нажав на значок ![trash-icon](/ru/assets/trash-icon.svg "inline") справа от типа источника.

        Нельзя удалить `Активный` источник, если это единственный источник такого типа в группе.

     1. Убедитесь, что для доменов всех добавленных источников (в том числе выключенных) настроены DNS-записи.

        <warn>

        Если VK Cloud не сможет проверить доступность домена с помощью запроса к DNS, то группу источников создать не удастся.

        </warn>

     1. Выберите опцию **Использовать следующий источник из списка при 4XX и 5XX кодах на источнике**, чтобы повлиять на порядок выбора источника при запросе контента CDN-серверами.

        При выбранной опции CDN-серверы будут обращаться к следующим источникам из списка, если тот источник, к которому эти серверы обращаются, недоступен. Если все источники недоступны, CDN-серверы будут возвращать ответ последнего источника в списке при запросе контента. Подробнее о выборе источника читайте в разделе [Группы источников](../../../concepts/origin-groups).

        Эта опция доступна, если в группе источников настроено более одного источника.

     1. Нажмите кнопку **Создать группу**.
1. Нажмите кнопку **Сохранить изменения**.

</tabpanel>
<tabpanel>

{include(/ru/_includes/_api_cdn_create_change.md)}

В теле запроса пропишите параметры:

- `origin` — IP-адрес или доменное имя источника и порт, если настроен.
- `originGroup` — идентификатор или название группы источников.

Вы можете использовать в запросе или параметр `origin`, или `originGroup`.

Пример запроса для изменения отдельного источника:

```json
curl --location --request PUT 'https://msk.cloud.vk.com/api/cdn/api/v1/projects/examplef8f67/resources/175281'\
--header 'X-Auth-Token: example6UjMOd'\
--header 'Content-Type: application/json'\
--data '{
    "origin": "yoursite.com"
}'
```

Пример запроса для изменения группы источников:

```json
curl --location --request PUT 'https://msk.cloud.vk.com/api/cdn/api/v1/projects/examplef8f67/resources/175281'\
--header 'X-Auth-Token: example6UjMOd'\
--header 'Content-Type: application/json'\
--data '{
    "originGroup": 267760,
    "originGroup_name": "exampleorigin",
    "secondaryHostnames": [],
}'
```

<info>

Для редактирования или добавления самой группы источников воспользуйтесь методами для работы с группами источников.

</info>

</tabpanel>
</tabs>

## Изменение заголовка Host

CDN-серверы указывают в HTTP-запросах обязательный заголовок [Host](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Host), когда запрашивают контент с источников. Использование этого заголовка позволяет обращаться к нужному виртуальному хосту на источниках.

По умолчанию значение заголовка Host совпадает с первым CNAME.

Чтобы изменить заголовок:

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>API</tab>
</tablist>
<tabpanel>

{include(/ru/_includes/_open-cdn.md)}

1. Перейдите на вкладку **Основные настройки**.
1. В параметре **Изменение заголовка Host** выберите, изменять ли значение HTTP-заголовка `Host` при обращении к источникам:

    - `Не менять` — в качестве значения заголовка будет использоваться имя домена или IP-адрес первого источника из группы источников.

        **Пример:**

        Пусть настроена группа из двух источников:

        - `203.0.113.222:8080`,
        - `images.example.com`.

        Тогда при обращении CDN-серверов к любому из этих источников будет использоваться заголовок `Host: 203.0.113.222:8080`.

    - `Кастомный` — в качестве значения заголовка будет использоваться указанное значение домена или IP-адреса.

        **Пример:**

        Пусть настроена группа из двух источников:

        - `203.0.113.222:8080`,
        - `images.example.com`.

        Также пусть для опции указано значение `content-source.example.org`.

        Тогда при обращении CDN-серверов к любому из этих источников будет использоваться заголовок `Host: content-source.example.org`.

    - `Пересылать` — в качестве значения заголовка будет использоваться имя первого настроенного персонального домена.

        **Пример:**

        Пусть настроена группа из двух источников:

        - `203.0.113.222:8080`,
        - `images.example.com`.

        Также пусть настроено два персональных домена для CDN:

        - `cdn.contoso.com`,
        - `cdn.example.org`.

        Тогда при обращении CDN-серверов к любому из этих источников будет использоваться заголовок `Host: cdn.contoso.com`.
1. Нажмите кнопку **Сохранить изменения**.

</tabpanel>
<tabpanel>

{include(/ru/_includes/_api_cdn_create_change.md)}

В теле запроса пропишите параметры:

- Чтобы в качестве заголовка Host передавался первый CNAME ресурса (по умолчанию), для параметров `forward_host_header` и  `hostHeader` укажите `"enabled": false`.
- Чтобы в качестве заголовка Host передавалось имя первого настроенного персонального домена, укажите параметры:

    ```json
    "forward_host_header": {
        "enabled": true,
        "value": true
    },
    "hostHeader": {
        "enabled": false
    }
    ```

- Чтобы в качестве заголовка Host передавался кастомный домен или IP-адрес, укажите параметры:

    ```json
    "forward_host_header": {
        "enabled": false,
        "value": false
    },
    "hostHeader": {
        "enabled": true,
        "value": "<заголовок>"
    }
    ```

Пример запроса для установки кастомного заголовка в host:

```json
curl --location --request PUT 'https://msk.cloud.vk.com/api/cdn/api/v1/projects/examplef8f67/resources/175281'\
--header 'X-Auth-Token: example6UjMOd'\
--header 'Content-Type: application/json'\
--data '{
    "options": {
        "forward_host_header": {
            "enabled": false,
            "value": false
        },
        "hostHeader": {
            "enabled": true,
            "value": "content-source.example.org"
        }
    }
}'
```

</tabpanel>
</tabs>

<warn>

После внесения изменений в опцию необходимо [очистить кеш CDN-ресурса](../content-settings##ochictka_kesha).

</warn>

## Включение шилдинга

Шилдинг источника (или прекеш-сервер) позволяет защитить источник от высоких нагрузок. Прекеш-сервер собирает все запросы пользователей и по одному отправляет их к источнику, если нужного контенета нет в кеше самого прекеш-сервера.

<info>

Подключение шилдинга источника увеличит потребление суммарного трафика CDN.

</info>

Чтобы подключить шилдинг источника:

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

{include(/ru/_includes/_open-cdn.md)}

1. Перейдите на вкладку **Основные настройки**.
1. Включите опцию **Активировать шилдинг источника**.
1. Прочитайте предупреждение и подтвердите включение.
1. Выберите дата-центр, расположенный ближе к вашему источнику.
1. Нажмите кнопку **Сохранить изменения**.

</tabpanel>
</tabs>
