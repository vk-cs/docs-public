Настройте мониторинг метрик баз данных PostgreSQL и уведомления об их изменениях, чтобы поддерживать стабильную работу облачных приложений.

## {heading(Подготовительные шаги)[id=prepare]}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект.
1. [Создайте](/ru/dbs/dbaas/instructions/create/create-single-replica) инстанс БД PostgreSQL, если это еще не сделано.

## 1. Посмотрите данные мониторинга на странице БД

1. [Посмотрите](/ru/dbs/dbaas/monitoring/postgresql) данные мониторинга на странице инстанса БД. Обратите внимание на следующие метрики:

   [cols="1,3"]
   |===
   |**RAM Used**
   |Процент занятой памяти от общего количества памяти на узле

   |**Current CPU**
   |Процент времени, в течение которого процессор узла обеспечивает работу инстанса БД и связанной с ним инфраструктуры

   |**Current IOWait**
   |Процент от общего количества ресурсов процессора узла, затраченных на ожидание завершения операций ввода-вывода

   |**Free connections**
   |Процент доступных подключений от общего числа

   |**Disk used**
   |Процент использованного дискового пространства от общего объема на узле
   |===

1. [Добавьте](/ru/dbs/dbaas/monitoring/postgresql#dobavlenie_dannyh_monitoringa_bd_v_svoi_grafiki) данные мониторинга в свои графики, чтобы иметь быстрый доступ к ним.

## 2. Настройте оповещения

1. [Создайте](/ru/monitoring-services/alerting/instructions/notification#notification_add) один или несколько каналов уведомлений.
1. [Создайте](/ru/monitoring-services/alerting/instructions/triggers#triggers_add) триггеры со следующими параметрами:

   [cols="1,1,1", options="header"]
   |===
   |Название метрики
   |Пороговое значение
   |Описание

   |`mem_used_percent`
   |`> 85-90%`
   |Высокая загрузка памяти

   |`cpu_usage_user`
   |`> 90%`
   |Приложение перегружено

   |`cpu_usage_system`
   |`> 30%`
   |Возможны проблемы с системными вызовами

   |`cpu_usage_iowait`
   |`> 80%`
   |Высокий процент ожидания дисковых операций

   |`postgresql_free_connections_percent`
   |`< 10-20%`
   |Остается мало свободных подключений к БД

   |`disk_used_percent`
   |`> 85-90%`
   |Остается мало места на диске
   |===

При достижении порогового значения будет создан инцидент и на указанный канал уведомлений будет отправлено сообщение.

## 3. Используйте данные мониторинга

Высокие показатели утилизации CPU (**Current CPU**) и оперативной памяти (**RAM Used**), нагрузки на дисковую подсистему (**Disk used**), а также интенсивная или неравномерная нагрузка на базу данных (**Current IOWait**) свидетельствуют о высокой нагрузке на узлы или о неоптимальных индексах и запросах.

Воспользуйтесь встроенными инструментами диагностики производительности PostgreSQL от имени администратора БД, например:

- Выполните запросы к системной таблице [pg_stat_activity](https://www.postgresql.org/docs/current/monitoring-stats.html#MONITORING-PG-STAT-ACTIVITY-VIEW), чтобы собрать статистику по выполняющимся запросам.

  Обратите внимание на запросы, которые выполняются дольше всех остальных.

- Воспользуйтесь командой [EXPLAIN](https://www.postgresql.org/docs/current/sql-explain.html) для поиска узких мест в таких медленных запросах.

  Обратите внимание на запросы, не использующие индексы (большое количество строк в `Seq Scan`). [Создайте](https://www.postgresql.org/docs/current/sql-createindex.html) или [обновите](https://www.postgresql.org/docs/current/sql-reindex.html) необходимые индексы.

Низкий процент свободных подключений (**Free connections**) может свидетельствовать как о большом количестве одновременно подключенных клиентов, так и о том, что есть длинные транзакции, которые используют открытое соединение слишком долго.

Оптимизируйте использование ресурсов:

- [Увеличите значение параметра](/ru/dbs/dbaas/instructions/db-config) `max_connections`.
- Оптимизируйте запросы так, чтобы не было длинных транзакций.
- Используйте [PgBouncer](https://www.pgbouncer.org/) для уменьшения нагрузки на сервер и оптимизации использование ресурсов.

## {heading(Удалите неиспользуемые ресурсы)[id=delete]}

Развернутый инстанс БД [тарифицируется](/ru/dbs/dbaas/tariffication) и потребляет вычислительные ресурсы. Если он вам больше не нужен, [удалите](/ru/dbs/dbaas/instructions/manage-instance/postgresql#udalenie_instansa_bd_ili_ego_hostov) его.