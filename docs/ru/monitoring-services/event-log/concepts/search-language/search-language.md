Язык поиска позволяет:

- отфильтровать список записей журнала событий по одному или нескольким полям;
- применять в выражениях фильтров логические операции и операции сравнения.

Доступна фильтрация по следующим полям:

[cols="1,3", options="header"]
|===
|Поле
|Описание

|`event_id`
|Уникальный идентификатор события

|`timestamp`
|Время возникновения события, [RFC3339](https://www.ietf.org/rfc/rfc3339.txt).

Пример с таймзоной: 2006-01-02T15:04:05+07:00

Пример без таймзоны: 2006-01-02T15:04:05Z

|`action`
|Тип события

|`request_id`
|Идентификатор запроса, служит для связи с Cloud Logging

|`severity`
|Критичность события. Доступные значения: `DEFAULT`,`DEBUG`, `INFO`, `NOTICE`, `WARNING`, `ERROR`, `CRITICAL`, `ALERT`, `EMERGENCY`

|`message`
|Понятное человеку описание события

|`source.id`
|Идентификатор источника события

|`source.address`
|IP-адрес источника события

|`subject.user_id`
|Идентификатор субъекта — пользователя, с действиями которого связано событие

|`subject.address`
|IP-адрес пользователя

|`subject.project_id`
|Идентификатор проекта в OpenStack

|`subject.metadata`
|Дополнительные метаданные, определяющие пользователя.

Например: поле `subject.metadata.email` — почта пользователя

|`resource.id`
|Идентификатор ресурса в OpenStack или аналогичный

|`resource.type`
|Тип ресурса

|`resource.metadata`
|Дополнительные метаданные, определяющие ресурс.

Например:

- поле `resource.metadata.service_id` — имя сервиса (`DBaaS`);
- поле `resource.metadata.group_id` — имя подсервиса (`Redis`);
- поле `resource.metadata.stream_id` — имя объекта, где находится ресурс (`DB_id`)

|`status.code`
|Код статуса выполнения операции.

Например, код [HTTP](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status) или код [gRPC](https://developers.google.com/maps-booking/reference/grpc-api/status_codes)

|`status.message`
|Дополнительное сообщение с расшифровкой статуса

|`labels`
|Дополнительные метки, по которым можно искать события
|===

Для фильтрации списка записей в журнале используйте в поисковой строке пары `<имя поля>/<значение поля>`. Чтобы отфильтровать записи по нескольким значениям одного поля, перечислите значения друг за другом.

<info>

Если в строке поиска указать подстроку вместо выражения с парами `<имя поля>/<значение поля>`, будут отфильтрованы записи, которые содержат указанную подстроку в поле по умолчанию, а именно: `message`.

</info>

## Особенности поиска

1. Символы `"`, `'` и `＼` в строке поиска экранируются с помощью `＼`.
1. Значение можно не брать в кавычки, если оно:

    - начинается с буквы латинского алфавита и содержит только буквы латинского алфавита, цифры и знаки подчеркивания;
    - является целым числом без знака.

1. Формат значений времени: [RFC3339](https://www.ietf.org/rfc/rfc3339.txt).
1. Все значения во вложенных объектах рассматриваются как строки и сравниваются в лексикографическом порядке.
1. Поддерживается поиск по полям-массивам с помощью операторов `:`, `=`, `<>`.

## Операторы сравнения

[cols="1,2,2", options="header"]
|===
|Оператор
|Расшифровка
|Пример

|`=`
|Равно
|`message="искомая строка"`

|`<>`
|Не равно
|`message<>"искомая строка"`

|`>`
|Больше
|`severity > DEBUG`

|`<`
| Меньше
|`severity < DEBUG`

|`>=`
|Больше либо равно
|`timestamp >= "2023-04-10T10:20:00Z"`

|`<=`
|Меньше либо равно
|`timestamp <= "2023-04-10T10:20:00Z"`

|`:`
|Содержит
|`message: "строка"`
|===

## Логические операторы

Объединить несколько условий в одном фильтрующем выражении можно с помощью логических операторов:

[cols="1,2,2", options="header"]
|===
|Оператор
|Расшифровка
|Пример

|`AND`
|Логическое И
|`service_id=databases AND severity=ERROR`

|`OR`
|Логическое ИЛИ
|`severity=ERROR OR status.code=500`

|`NOT`
|Логическое ИЛИ
|`NOT message: hello`

|`EXIST`
|Проверка существования поля
|`subject.metadata.email EXIST`
|===

## Порядок вычислений

Используйте скобки для задания определенного порядка вычислений, например:

```sql
parameter1: "значение1" AND (parameter2 = "значение2" OR parameter3 < "значение3")
```
В этом примере будут найдены записи, в которых параметр `parameter1` содержит подстроку `"значение1"` и выполнено хотя бы одно из двух условий:

- Значение параметра `parameter2` равно `"значение2"`.
- Значение параметра `parameter3` меньше, чем `"значение3"` в лексикографическом смысле.

## Примеры выражений

[cols="1,1", options="header"]
|===
|Выражение
|Результат поиска

|`source.id=iam AND (subject.address="127.0.0.1" OR status.code=500)`
|Все события сервиса IAM, произошедшие с пользователем по IP-адресу `127.0.0.1` или вызвавшие код ошибки 500

|`severity=CRITICAL AND subject.metadata.email: "@example.ru"`
|Все критические события, произошедшие у пользователей с почтовым доменом `example.ru`

|`timestamp > "2023-06-02T15:04:05Z03:00" AND source.address="127.0.0.1" AND resource.metadata.stream_id="2278584446"`
|Все события, произошедшие на объекте с именем `2278584446` по IP-адресу `127.0.0.1` после 15:04:05 2 июня 2023 года. Время указано для часового пояса UTC+3
|===
