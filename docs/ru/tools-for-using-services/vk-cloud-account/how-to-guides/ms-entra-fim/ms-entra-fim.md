К VK Cloud можно подключить ваш поставщик удостоверений (Identity Provider, IdP). Это позволит вашим сотрудникам заходить в VK Cloud без ввода логина и пароля, используя корпоративные аутентификационные данные поставщика удостоверений. Такой режим называется федерация удостоверений.

Для работы в режиме федерации поставщик удостоверений должен поддерживать стандарт SAML 2.0.

Далее будет показана настройка федерации удостоверений c [Microsoft Entra](https://www.microsoft.com/en-in/security/business/microsoft-entra) в качестве поставщика удостоверений.

## Подготовительные шаги

[Настройте](https://learn.microsoft.com/en-us/entra/fundamentals/) Microsoft Entra, создайте тенант, пользователей и группы.

## 1. Создайте федерацию удостоверений в VK Cloud

<info>

Операции по созданию федерации удостоверений VK Cloud доступны только пользователям с [ролью](../../../account/concepts/rolesandpermissions) владельца проекта.

</info>

1. [Перейдите](https://cloud.vk.com/account) в аккаунт VK Cloud.
1. Перейдите в раздел **Федерация удостоверений**.
1. Перейдите на вкладку **Федерации** и нажмите кнопку **Создать**.
1. Нажмите кнопку **Скачать метаданные**. Будет скачан файл с метаданными, который понадобится для настройки Microsoft Entra.
1. Скопируйте значение параметра **URL для входа федеративных пользователей**. Это значение будет нужно указать при настройке Microsoft Entra.

## 2. Настройте Microsoft Entra

1. Перейдите в центр администрирования [Microsoft Entra](https://www.microsoft.com/ru-ru/security/business/microsoft-entra).
1. Перейдите на вкладку **Приложения → Корпоративные приложения**.
1. Нажмите на приложение **Microsoft Entra SAML Toolkit**, затем нажмите кнопку **Создать**, чтобы перейти к созданию нового корпоративного приложения.
1. В окне настроек нового приложения перейдите на вкладку **Единый вход** и выберите **SAML**.
1. Нажмите кнопку **Отправить файл метаданных** и загрузите файл с метаданными федерации.
1. Нажмите кнопку **Добавить**.
1. В поле **URL-адрес для входа** укажите URL для входа федеративных пользователей, который был скопирован при создании федерации в личном кабинете VK Cloud.
1. Нажмите кнопку **Сохранить**.
1. Перейдите в раздел **Пользователи и группы** в настройках приложения.
1. [Создайте](https://learn.microsoft.com/ru-ru/entra/fundamentals/how-to-manage-groups) как минимум одну группу, которая будет использоваться для маппинга ролей пользователя в личном кабинете.
1. Перейдите в раздел **Единый вход → SAML** в настройках приложения.
1. В блоке **Атрибуты и утверждения** нажмите кнопку **Изменить**, чтобы отредактировать утверждения.
1. Измените существующие утверждения и добавьте новые:

    1. Для утверждения `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/givenname` нажмите ![](../../../../assets/more-icon.svg "inline") и выберите **Удалить**.
    1. Нажмите на утверждение `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name` и поменяйте атрибут источника на `user.givenname`.
    1. Нажмите кнопку **Добавить утверждение группы**.
    1. Выберите **Группы, назначенные приложению**.
    1. В списке **Атрибут источника** выберите **Отображаемые имена облачных групп**.
    1. Нажмите **Дополнительные параметры**.
    1. Включите опцию **Настроить имя утверждения группы**, чтобы указать тип утверждения.
    1. В поле **Имя** укажите ` http://schemas.xmlsoap.org/claims/Group`.
    1. Нажмите кнопку **Сохранить**.
    1. (Опционально) Добавьте новое утверждение, указав в качестве пространства имен `phone_number`, а в качестве атрибута источника `user.mobilephone`.
1. Перейдите в раздел **Единый вход → SAML** в настройках приложения.
1. В блоке **Сертификаты SAML** создайте новый сертификат или импортируйте существующий.
1. Нажмите кнопку **XML метаданных федерации**. Будут скачаны метаданные IdP.

## 3. Загрузите метаданные Microsoft Entra в федерацию удостоверений VK Cloud

1. [Перейдите](https://cloud.vk.com/account) в аккаунт VK Cloud.
1. Перейдите в раздел **Федерация удостоверений**.
1. Перейдите на вкладку **Федерации** и нажмите кнопку **Загрузите метаданные IdP**, чтобы загрузить новые метаданные.
1. Выберите файл с метаданными Microsoft Entra и нажмите кнопку **Загрузить**.

## 4. Настройте связь групп и ролей в VK Cloud

{note:info}
Операции по настройке связи групп и ролей в VK Cloud доступны только следующим [ролям](../../../account/concepts/rolesandpermissions) личного кабинета: владельцу, суперадминистратору и администратору пользователей (IAM).
{/note}

1. В том же разделе [аккаунта VK Cloud](https://cloud.vk.com/account) перейдите на вкладку **Группы**.
1. Нажмите на название проекта, для которого настраивается федерация удостоверений.
1. Добавьте группы, которые вы используете в Microsoft Entra:

    1. Нажмите кнопку **Добавить**. Если на странице уже есть созданные группы, нажмите кнопку **Добавить группу**.
    1. Настройте группу:

        - **Имя группы**: укажите название группы. Название создаваемой группы должно совпадать с именем [группы](https://learn.microsoft.com/ru-ru/entra/fundamentals/quickstart-create-group-add-members) в Microsoft Entra.
        - **Разрешения** — выберите уровень, на котором будут действовать разрешения группы:
           - **Проект** — выберите, чтобы связать группу и роли в рамках одного проекта. В разных проектах можно связать одну и ту же группу с разными ролями, что позволит разграничить уровень доступа федеративного пользователя к проектам.
           - **Домен** — выберите, чтобы связать группу и роли во всех проектах одного владельца и предоставить федеративному пользователю единый уровень доступа к ним. Разрешение **Домен** доступно только владельцу проекта.
        - **Роли группы**: выберите те [роли VK Cloud](../../../account/concepts/rolesandpermissions), которые соответствуют вашей матрице доступа для создаваемой группы.

    1. Нажмите кнопку **Добавить**.

## 5. Проверьте возможность входа через федерацию

1. [Создайте](https://learn.microsoft.com/ru-ru/entra/fundamentals/how-to-create-delete-users) тестового пользователя в Microsoft Entra и [добавьте](https://learn.microsoft.com/ru-ru/entra/fundamentals/quickstart-create-group-add-members) его в нужную группу.
1. (Опционально) Перейдите в пункт меню **Шифрование маркеров** и добавьте сертификат, который можно получить из файла метаданных федерации.
    {cut(Как получить сертификат из файла метаданных?)}
    1. Откройте файл метаданных в текстовом редакторе.
    1. Скопируйте содержимое между тегами `<X509Certificate>` и `</X509Certificate>`.
    1. Вставьте скопированный текст в отдельный текстовый файл и сохраните его с разрешением `.cer`.
    {/cut}
1. Введите в строку браузера URL для входа федеративных пользователей. Вы будете перенаправлены на страницу аутентификации.
1. Введите аутентификационные данные тестового пользователя. После успешной авторизации вы будете перенаправлены на главную страницу личного кабинета VK Cloud.
1. Проверьте, что автоматически назначенная роль пользователя VK Cloud соответствует выбранной при [добавлении группы](#4_nastroyte_svyaz_grupp_i_roley_v_vk_cloud).
