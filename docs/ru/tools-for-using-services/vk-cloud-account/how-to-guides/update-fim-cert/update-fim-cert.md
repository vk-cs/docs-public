Срок действия сертификатов ADFS ограничен, после его истечения пользователи не смогут войти в систему. Для корректной работы аутентификации обновите сертификат федерации. Вы можете сделать это [вручную](#manual-update) или настроить [автоматическое](#auto-update) обновление.

## {heading(Ручное обновление сертификата)[id=manual-update]}

1. [Перейдите](https://cloud.vk.com/account) в аккаунт VK Cloud.
1. Перейдите в раздел **Федерация удостоверений**.
1. Перейдите на вкладку **Федерации**.
1. Нажмите кнопку **Скачать метаданные**.
1. Скопируйте загруженный файл на компьютер с ADFS.
1. Запустите PowerShell от имени администратора и выполните команду:

   ```bash
   Update-ADFSRelyingPartyTrust -TargetName "<RELYING_PARTY_TRUST_NAME>" -MetadataFile <PATH_TO_METADATA_XML>
   ```
   
   Здесь:

      - `<RELYING_PARTY_TRUST_NAME>` — имя проверяющей стороны (relying party trust).
      - `<PATH_TO_METADATA_XML>` — путь до XML-файла с метаданными федерации.
   
1. На компьютере откройте **ADFS** — **Relying Party Trust** и перейдите на вкладку **Encryption**. Проверьте, что сертификат обновлен.
1. Проверьте работоспособность федеративного доступа. Для этого авторизуйтесь в системе под учетной записью любого активного пользователя.

## {heading(Автоматическое обновление сертификата)[id=auto-update]}

1. Получите ID вашей федерации удостоверений:

   1. [Перейдите](https://cloud.vk.com/account) в аккаунт VK Cloud.
   1. Перейдите в раздел **Федерация удостоверений**.
   1. Перейдите на вкладку **Федерации**.
   1. Скопируйте значение параметра **ID федерации**.

1. На компьютере откройте **ADFS** — **Relying Party Trust** и перейдите на вкладку **Monitoring**.
1. В поле **Relying party's federation metadata URL** вставьте URL для обновления метаданных: 

    ```text
   https://msk.cloud.vk.com/federation-service/v1/federation/saml/<FEDERATION_ID>/metadata
   ```
   
   Здесь `<FEDERATION_ID>` — значение параметра **ID федерации** раздела **Федерация удостоверений** в аккаунте VK Cloud.

1. Проверьте доступность метаданных, нажав кнопку **Test URL**. 
1. Включите опции **Monitor relying party** и **Automatically update relying party**, затем нажмите кнопку **Apply**.
1. (Опционально) Проверьте настройки интервала между проверками метаданных для ADFS, выполнив команду PowerShell:

   ```bash
   Get-ADFSProperties | select MonitoringInterval
   ```

   По умолчанию интервал между проверками метаданных составляет 1440 минут (24 часа).

1. (Опционально) Измените интервал проверки, выполнив команду PowerShell:

   ```bash
   Set-AdfsProperties -MonitoringInterval <MINUTES>
   ```
   
   Здесь `<MINUTES>` — количество минут между проверками метаданных.

1. Дождитесь, когда метаданные будут обновлены. После этого на компьютере откройте **ADFS** — **Relying Party Trust** и перейдите на вкладку **Encryption**. Проверьте, что сертификат обновлен.
1. Проверьте работоспособность федеративного доступа. Для этого авторизуйтесь в системе под учетной записью любого активного пользователя.