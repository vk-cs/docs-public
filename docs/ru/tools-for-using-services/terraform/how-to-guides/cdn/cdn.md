В статье приведен пример создания и настройки CDN-ресурса и источников, подключения шилдинга источника и добавления SSL-сертификата при помощи Terraform.

В примерах используются:

- Ресурсы (resource):

  - [vkcs_cdn_origin_group](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/resources/cdn_origin_group);
  - [vkcs_cdn_resource](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/resources/cdn_resource);
  - [vkcs_cdn_ssl_certificate](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/resources/cdn_ssl_certificate).

- Источники данных (data source):

  - [vkcs_cdn_origin_group](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/data-sources/cdn_origin_group);
  - [vkcs_cdn_shielding_pop](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/data-sources/cdn_shielding_pop);
  - [vkcs_cdn_shielding_pops](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/data-sources/cdn_shielding_pops);
  - [vkcs_cdn_ssl_certificate](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/data-sources/cdn_ssl_certificate).

Полное описание параметров — в [документации провайдера Terraform](https://github.com/vk-cs/terraform-provider-vkcs/tree/master/docs).

{cut(Полный манифест Terraform, используемый в создании ресурсов примера)}

{include(/ru/_includes/_cdn_tf.md)}

{/cut}

## Подготовительные шаги

1. Ознакомьтесь с [документаций VK Cloud CDN](/ru/networks/cdn/concepts), чтобы иметь представление о принципах работы сервиса.

1. Проверьте [квоты](/ru/tools-for-using-services/account/concepts/quotasandlimits). Убедитесь, что в выбранном [регионе](/ru/tools-for-using-services/account/concepts/regions) достаточно ресурсов для создания CDN-ресурса. Для разных регионов могут быть настроены разные квоты.

   Чтобы увеличить квоты, обратитесь в [техническую поддержку](/ru/contacts).

1. [Установите Terraform и настройте провайдер](../../quick-start), если этого еще не сделано.

## 1. Создайте файл с описанием группы источников

Группы источников управляют внутренними серверами, отвечающими за размещение и доставку контента. Для CDN-ресурса необходимо создать группу и добавить в него хотя бы один источник. Для большей надежности и отказоустойчивости добавьте несколько источников в группу.

Создайте файл конфигурации Terraform `cdn.tf` и добавьте в него содержимое:

{include(/ru/_includes/_cdn_tf.md)[tags=origin]}

Здесь:

- `name` — имя группы источников. Обязательный параметр.
- `origins` — список источников.
- `source` — IP-адрес или домен источника и порт, если используется пользовательский порт. Обязательный параметр.
- `enabled` — доступность источника:
  - `enabled = true` или параметр не указан — источник включен;
  - `enabled = false` — источник отключен.
- `backup` — признак резервного [типа источника](/ru/networks/cdn/concepts/origin-groups) (задается на уровне источника):
  - `backup = true` — источник является резервным;
  - `backup = false` или параметр не указан — источник является активным.
- `use_next` — использование [следующего источника из списка](/ru/networks/cdn/concepts/origin-groups) (задается на уровне всей группы):
  - `use_next = true` — CDN-сервер запрашивает контент от первого активного источника. При ответе с HTTP-статусом из диапазона 4XX или 5XX CDN-сервер будет двигаться вниз по списку и запрашивать контент от остальных источников, вне зависимости от их типа.
  - `use_next = false` или параметр не указан — CDN-сервер запрашивает контент сначала от одного из активных источников. Если от активного источника придет ответ с HTTP-статусом из диапазона 5XX, CDN-сервер запросит контент от одного из резервных источников. При ответе с HTTP-статусом из диапазона 4XX от активного или резервного источника CDN-сервер вернет потребителю ошибку.

## 2. (Опционально) Добавьте шилдинг в проект

Шилдинг источника позволяет защитить источник от высоких нагрузок. Для этого используется прекеш-сервер, который собирает все запросы пользователей и по одному отправляет их к источнику, если нужного контента нет в кеше самого прекеш-сервера.

Если вы не планируете использовать шилдинг, перейдите к [добавлению SSL-сертификата](#ssl).

Для добавления шилдинга в конфигурацию CDN-ресурса получите список доступных прекеш-серверов и выберите ближайший к потребителям контента.

1. Создайте файл конфигурации Terraform `shieldings.tf` и добавьте в него содержимое:

    ```hcl

    data "vkcs_cdn_shielding_pops" "pops" {}

    output "shielding_locations" {
        value = data.vkcs_cdn_shielding_pops.pops.shielding_pops
    }
    ```

1. Поместите файлы конфигурации Terraform в одну директорию:

   - `vkcs_provider.tf`;
   - `shieldings.tf`.

1. Перейдите в эту директорию.
1. Примените изменения:

   ```console
   terraform apply
   ```
   
    В ответе вернется информация по доступным прекеш-серверам.

    Пример ответа:

    ```hcl
    shielding_locations = tolist([
      {
        "city" = "Moscow-Megafon"
        "country" = "Russia"
        "datacenter" = "mgf"
        "id" = 138
      },
    ])
    ```

    Здесь:

    - `city`, `country` — город и страна, где размещены точки присутствия прекеш-сервера.
    - `datacenter` — ЦОД, в котором размещен прекеш-сервер.
    - `id` — идентификатор точки присутствия.

1. Выберите точку присутствия прекеш-сервера и добавьте ее данные в файл конфигурации CDN-ресурса. Для этого откройте файл `cdn.tf` и добавьте в него содержимое:

    {include(/ru/_includes/_cdn_tf.md)[tags=shielding]}

## {heading(3. (Опционально) Добавьте SSL-сертификат в проект)[id=ssl]}

При доставке контента по протоколу HTTPS используются SSL-сертификаты. Вы можете добавить свой SSL-сертификат, использовать бесплатный сертификат [Let's Encrypt](https://letsencrypt.org/ru/) или не использовать SSL-сертификат вообще, тогда контент будет поставляться по протоколу HTTP.

Если вы планируете использовать сертификат Let's Encrypt или не использовать SSL-сертификат вообще, перейдите к [добавлению CDN-ресурса](#cdn).

1. Поместите файлы вашего SSL-сертификата с публичной частью `certificate.pem` и приватной частью `private-key.key` в директорию, из которой будете создавать ресурсы.
1. Проверьте, чтобы файлы содержали все строки сертификата.
1. Откройте файл `cdn.tf` и добавьте в него содержимое:

   {include(/ru/_includes/_cdn_tf.md)[tags=ssl]}

    Здесь:

    - `name` — имя SSL-сертификата.
    - `certificate` — путь до файла, содержащего публичную часть сертификата. Все строки публичной части сертификата должны быть в файле.
    - `private_key` — путь до файла, содержащего приватную часть сертификата. Все строки приватной части сертификата должны быть в файле.
   
    Все три параметра обязательные.

## {heading(4. Добавьте описание CDN-ресурса)[id=cdn]}

Откройте файл `cdn.tf` и добавьте в него содержимое:

{include(/ru/_includes/_cdn_tf.md)[tags=cdn]}

Здесь:

- `cname` — FQDN домена, при обращении к которому контент будет доставлен с помощью CDN. Обязательный параметр.

    Не добавляйте к FQDN корневое доменное имя: допустима запись вида `cdn.example.com`, но не `cdn.example.com.`. Чтобы добавить дополнительные домены для CDN, укажите их в параметре `secondary_hostnames`.
- `origin_group` — идентификатор группы источников для CDN-ресурса. Идентификатор можно указать в конфигурационном файле, получить из источника данных или ресурса. Обязательный параметр.

  {cut(Примеры)}

    - `origin_group = vkcs_cdn_origin_group.origin_group.id`: идентификатор группы источников будет получен после создания ресурса `vkcs_cdn_origin_group`.
    - `origin_group = data.vkcs_cdn_origin_group.origin_group.id`: идентификатор группы будет получен из источника данных `vkcs_cdn_origin_group`.
    - `origin_group = "266524"`: указан идентификатор, полученный из [списка групп источников](/ru/networks/cdn/instructions/manage-origin-groups#origin_group_list) в личном кабинете VK Cloud.

  {/cut}

- `active` — доступность ресурса:
  - `active = true` или параметр не указан — CDN-ресурс переходит в состояние `Активен`, контент доставляется потребителям;
  - `active = false` — CDN-ресурс переходит в состояние `Приостановлен`, контент не доставляется потребителям.
- `options` — настройки CDN-ресурса. Описание всех доступных настроек приведено в [документации VKCS-провайдера](https://docs.comcloud.xyz/providers/vk-cs/vkcs/latest/docs/resources/cdn_resource).
- `origin_protocol` — протокол взаимодействия с источником:
  - `"http"` или параметр не указан — контент на источнике доступен только по HTTP (80 порт) или источник поддерживает перенаправление с HTTPS на HTTP.
  - `"https"` — контент на источнике доступен только по HTTPS (443 порт) или источник поддерживает перенаправление с HTTP на HTTPS.
  - `"http, https"` — контент на источнике доступен по HTTP и HTTPS. В этом случае в запросе от CDN-ресурса к источнику сохранится протокол запроса конечного пользователя. При этом в кеше CDN-ресурса будут храниться две версии файла для каждого протокола.
- `shielding` — подключение шилдинга источника для CDN-ресурса. 
  - `enabled` — включение шилдинга: `true` (включен) или `false` (отключен).
  - `pop_id` — идентификатор точки присутствия шилдинга. В этом примере идентификатор будет получен из источника данных `vkcs_cdn_shielding_pop`. Вы также можете его указать непосредственно в конфигурации. Пример: `pop_id = 138`.

    Если вы не подключаете шилдинг источника, удалите блок параметров из конфигурации.
- `ssl_certificate` — SSL-сертификат для доставки контента по протоколу HTTPS:
  - `type` — тип SSL-сертификата. Доступные значения:
    - `"not_used"` — SSL-сертификат не будет использоваться.
    - `"own"` — будет добавлен пользовательский сертификат.
    - `"lets_encrypt"` — будет добавлен бесплатный сертификат [Let's Encrypt](https://letsencrypt.org/ru/). Чтобы выписать сертификат, CDN-ресурс должен быть активным (`active = true`). Сертификат будет создан после создания CDN-ресурса, когда станут доступны серверы-источники и в DNS будут распространены изменения, касающиеся CNAME-записей для персональных доменов. Обычно на это уходит до 30 минут.
  - `id` — идентификатор SSL-сертификата, привязанного к CDN-ресурсу. Идентификатор должен быть указан, если `type = "own"`. В приведенном файле `cdn.tf` идентификатор будет получен из ресурса `vkcs_cdn_ssl_certificate`, добавленного ранее.

## 5. Создайте необходимые ресурсы с помощью Terraform

1. Поместите файлы конфигурации Terraform в одну директорию с файлами SSL-сертификата:
  
   - `vkcs_provider.tf`;
   - `cdn.tf`.

1. Перейдите в эту директорию.
1. Убедитесь, что конфигурационные файлы корректны и содержат нужные изменения:

   ```console
   terraform validate && terraform plan
   ```

1. Примените изменения:

   ```console
   terraform apply
   ```

   При запросе подтверждения введите `yes`.

1. Дождитесь завершения операции.

## 6. Проверьте применение конфигурации

Убедитесь, что ресурсы успешно созданы:

1. [Перейдите](https://cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **CDN** → **CDN-ресурсы**. Убедитесь, что CDN-ресурс создан.
1. Перейдите в раздел **CDN** → **Группы источников**. Убедитесь, что группы источников созданы.
1. Перейдите в раздел **CDN** → **SSL-сертификаты**. Убедитесь, что SSL-сертификат добавлен в проект.

## Удалите неиспользуемые ресурсы

Если созданные с помощью Terraform ресурсы больше не нужны, удалите их:

1. Перейдите в директорию с файлами конфигурации Terraform.
1. Выполните команду:

   ```console
   terraform destroy
   ```

   При запросе подтверждения введите `yes`.

1. Дождитесь завершения операции.
