Сервис Marketplace и SaaS-приложение взаимодействуют между собой через [SaaS-брокер](/ru/tools-for-using-services/vendor-account/manage-apps/concepts/about#xaas_vendor_index_type_services) по протоколу VK OSB. Протокол предоставляется платформой VK Cloud.

Требования к SaaS-брокеру:

* Брокер должен реализовывать методы, которые описывают жизненный цикл инстансов сервиса. Методы представлены на схеме.

    {cut(Схема взаимодействия брокера с магазином и SaaS-приложением)}

    ![](../assets/SaaS_broker.png){params[noBorder=true]}

    {/cut}

* В брокере должна быть настроена аутентификация по безопасному протоколу HTTPS c сертификатом, выданным доверенным центром сертификации.

    {note:err}

    Использование самоподписанных сертификатов запрещено.

    {/note}

Поставщик SaaS-приложения разрабатывает SaaS-брокер полностью самостоятельно либо на основе шаблона, который предоставляется платформой VK Cloud. В шаблоне уже реализовано взаимодействие между магазином и брокером. Его необходимо дополнить описанием взаимодействия брокера с конкретным SaaS-приложением. Шаблон разработан на языке Python на основе фреймворка [FastAPI](https://fastapi.tiangolo.com/tutorial/first-steps).

Эта инструкция предназначена для случая разработки SaaS-брокера на основе шаблона от VK Cloud.

## Подготовительные шаги

1. Отправьте письмо на [marketplace@cloud.vk.com](mailto:marketplace@cloud.vk.com). В письме запросите:
   * протокол VK OSB;
   * шаблон для разработки SaaS-брокера;
   * имена тестовых и открытых пространств имен Marketplace и доступ к ним.

1. [Зарегистрируйтесь](/ru/intro/onboarding/account) на VK Cloud. Учетная запись VK Cloud необходима для тестирования приложения в магазине.

## {heading(1. Опишите конфигурацию сервиса (тарифные планы, опции))[id=service_config]}

1. Создайте файл `catalog_<ИМЯ_СЕРВИСА>.json`.
1. В JSON-файле опишите конфигурацию сервиса, используя следующую структуру:

    ```json
    {
      "services": [
        {
        <ПАРАМЕТРЫ_СЕРВИСА>,
        "preview": {
            "parameters": [
              {
                "name": "<ИМЯ_ОПЦИИ_1>" // Имя первой тарифной опции
              },
              {
                "name": "<ИМЯ_ОПЦИИ_2>" // Имя второй тарифной опции
              },
              ...
            ]
          },
        "plans": [
            { // Описание первого тарифного плана
              <ПАРАМЕТРЫ_ПЛАНА>,
              "display": {
              },
              "billing": {
              },
              "schemas": {
              }
            },
            { // Описание второго тарифного плана
              <ПАРАМЕТРЫ_ПЛАНА>,
              "display": {
              },
              "billing": {
              },
              "schemas": {
              }
            },
            ...
          ]
        }
      ]
    }
    ```

Здесь:

* `<ПАРАМЕТРЫ_СЕРВИСА>` — [параметры сервиса](../../reference/saas-apps-reference/saas-param).
* Секции `preview` и `plans` вместе определяют вид [матрицы тарифных планов](/ru/tools-for-using-services/vendor-account/manage-apps/concepts/about#xaas_tariff_matrix). В матрице будут отображаться все тарифные планы, указанные в секции `plans`, и тарифные опции, указанные в секции `preview`.
* Массив `parameters` секции `preview` содержит имена тарифных опций, может быть пустым. Эти имена используются только в конфигурационном JSON-файле. В интерфейсе магазина тарифные опции будут отображаться с именами, заданными в [секции schemas](../../reference/saas-apps-reference/schemas-section) параметром `description` этих опций.
* Секция `plans` описывает тарифные планы и их опции и для каждого плана содержит следующие блоки:

  * `<ПАРАМЕТРЫ_ПЛАНА>` — [параметры плана](../../reference/saas-apps-reference/saas-plan).
  * [Секция display](../../reference/saas-apps-reference/display-section) описывает мастер конфигурации тарифного плана.
  * [Секция billing](../../reference/saas-apps-reference/billing-section) содержит информацию о стоимости и способе тарификации плана и его опций.
  * [Секция schemas](../../reference/saas-apps-reference/schemas-section) перечисляет тарифные опции плана.

{cut(Пример конфигурационного JSON-файла)}

```json
{
  "services": [
    {
      "id": "04527a41-XXXX-57e1aecb3ebc",
      "revision": "v. 1.0",
      "name": "VK Testers",
      "short_description": "Программа крауд-тестирования с многотысячным коммьюнити бета-тестировщиков и собственной платформой для работы с данными",
      "full_description": "Мы предлагаем удобный баг-трекер для организации процесса тестирования:\n   - Автоматизация процессов с помощью API\n   - Гибкая настройка проектов\n   - Интеграция с внешними таск-трекерами\n   - Дистрибуция тестовых сборок\n   - Десктопная и мобильная версии баг-трекера",
      "singleton": false,
      "auto_bind": true,
      "icon": "https://vk.com/images/bugs/vktesters_logo.svg",
      "help": "http://vk.cc/vktesters_po_faq",
      "bindable": true,
      "plan_updateable": true,
      "deactivatable": false,
      "bindings_retrievable": true,
      "instances_retrievable": true,
      "preview": {
        "parameters": [
          {
            "name": "api_requests_daily_limit"
          },
          {
            "name": "products"
          },
          {
            "name": "members"
          }
        ]
      },
      "plans": [
        {
          "id": "f6593bfb-c0b8-40a3-8b82-c05e07f6ae9a",
          "revision": "v. 2.0",
          "name": "free",
          "description": "Бесплатный",
          "free": true,
          "metadata": {
			  "test_ns": ["test"],
              "prod_ns": ["vkcs_ru"]
          },
          "refundable": true,
          "billing_cycle_flat": "1 mons",
          "display": {
            "pages": [
              {
                "name": "Настройки",
                "index": 0,
                "groups": [
                  {
                    "name": "",
                    "index": 0,
                    "parameters": [
                      {
                        "name": "api_requests_daily_limit",
                        "index": 0
                      },
                      {
                        "name": "groups",
                        "index": 1
                      },
                      {
                        "name": "products",
                        "index": 2
                      },
                      {
                        "name": "members",
                        "index": 3
                      }
                    ]
                  }
                ]
              }
            ]
          }
          "billing": {
            "cost": 0,
            "options": {
              "products": {
                "base": 5,
                "cost": 100,
                "unit": {
                  "size": 10
                }
              },
              "groups": {
                "base": 0,
                "cost": 200,
                "unit": {
                  "size": 5
                }
              },
              "members": {
                "base": 5,
                "cost": 100,
                "unit": {
                  "size": 1
                }
              },
              "checklists_per_product": {
                "base": 2,
                "cost": 50,
                "unit": {
                  "size": 1
                }
              },
              "api_requests_daily_limit": {
                "base": 1000,
                "cost": 50,
                "unit": {
                  "size": 1000,
                  "measurement": "Запросы в сутки"
                }
              }
            }
          },
          "schemas": {
            "service_instance": {
              "create": {
                "parameters": {
                  "$schema": "http://json-schema.org/draft-04/schema#",
                  "type": "object",
                  "properties": {
                    "products": {
                      "description": "Количество продуктов",
                      "hint": "Предельное количество тестируемых на платформе проектов: к продуктам прикрепляются отчеты и чек-листы, а также загружаются сборки.",
                      "type": "integer",
                      "minimum": 0,
                      "default": 0
                    },
                    "groups": {
                      "type": "integer",
                      "description": "Количество групп пользователей",
                      "hint": "Возможность разделения сотрудников заказчика на отдельные группы с различными правами в выбранных продуктах. Инструмент позволяет структурировать доступы и тестируемые продукты, объединяя их в группы по обозначенным критериям, что повышает уровень контроля.",
                      "minimum": 0,
                      "default": 0
                    },
                    "members": {
                      "type": "integer",
                      "description": "Количество участников",
                      "hint": "Количество сотрудников компании заказчика, которые могут использовать инфраструктуру тестирования и обрабатывать отчеты от тестировщиков VK Testers.",
                      "minimum": 0,
                      "default": 0
                    },
                    "checklists_per_product": {
                      "type": "integer",
                      "description": "Количество чек-листов на продукт",
                      "hint": "Чек-лист — список действий, которые нужно выполнить при тестировании продукта. Большее количество чек-листов позволяет лучше структурировать проводимые участниками VK Testers проверки.",
                      "minimum": 0,
                      "default": 0
                    },
                    "api_requests_daily_limit": {
                      "type": "integer",
                      "description": "Доступ к открытому API",
                      "hint": "Открытое API помогает встроить платформу тестирования в работу существующих в вашей компании решений. Увеличенный суточный лимит на запросы позволяет поддерживать больше интеграций одновременно.",
                      "minimum": 0,
                      "default": 0
                    },
                    "report_notifications": {
                      "type": "boolean",
                      "description": "Уведомления о новых отчетах",
                      "hint": "Настройка мгновенных уведомлений для сотрудников компании о появлении новых отчетов.",
                      "const": false
                    }
                  }
                }
              },
              "update": {
                "parameters": {
                  "$schema": "http://json-schema.org/draft-04/schema#",
                  "type": "object",
                  "properties": {
                    "products": {
                      "description": "Количество продуктов",
                      "hint": "Предельное количество тестируемых на платформе проектов: к продуктам прикрепляются отчеты и чек-листы, а также загружаются сборки.",
                      "type": "integer",
                      "minimum": 0,
                      "default": 0
                    },
                    "groups": {
                      "type": "integer",
                      "description": "Количество групп пользователей",
                      "hint": "Возможность разделения сотрудников заказчика на отдельные группы с различными правами в выбранных продуктах. Инструмент позволяет структурировать доступы и тестируемые продукты, объединяя их в группы по обозначенным критериям, что повышает уровень контроля.",
                      "minimum": 0,
                      "default": 0
                    },
                    "members": {
                      "type": "integer",
                      "description": "Количество участников",
                      "hint": "Количество сотрудников компании заказчика, которые могут использовать инфраструктуру тестирования и обрабатывать отчеты от тестировщиков VK Testers.",
                      "minimum": 0,
                      "default": 0
                    },
                    "checklists_per_product": {
                      "type": "integer",
                      "description": "Количество чек-листов на продукт",
                      "hint": "Чек-лист — список действий, которые нужно выполнить при тестировании продукта. Большее количество чек-листов позволяет лучше структурировать проводимые участниками VK Testers проверки.",
                      "minimum": 0,
                      "default": 0
                    },
                    "api_requests_daily_limit": {
                      "type": "integer",
                      "description": "Доступ к открытому API",
                      "hint": "Открытое API помогает встроить платформу тестирования в работу существующих в вашей компании решений. Увеличенный суточный лимит на запросы позволяет поддерживать больше интеграций одновременно.",
                      "minimum": 0,
                      "default": 0
                    },
                    "report_notifications": {
                      "type": "boolean",
                      "description": "Уведомления о новых отчетах",
                      "hint": "Настройка мгновенных уведомлений для сотрудников компании о появлении новых отчетов.",
                      "const": false
                    }
                  }
                }
              }
            },
            "service_binding": {
              "create": {
                "parameters": {
                  "type": "object",
                  "properties": {
                  }
                }
              }
            }
          }
        }
      ]
    }
  ]
}
```

{/cut}

## {heading(2. Разработайте SaaS-брокер)[id=saas_broker]}

1. Разработайте клиент для взаимодействия с API вашего сервиса.
1. Разработайте сервисный менеджер, описывающий взаимодействие брокера и сервиса. Для этого реализуйте следующие методы:

   * Создание тенанта или аккаунта. Входные данные метода:

      * OSB ID инстанса сервиса, который формируется магазином при подключении сервиса. OSB ID передается в SaaS-приложение, чтобы SaaS-приложение сформировало ID инстанса сервиса. ID инстанса сервиса используется в методах, описанных ниже.
      * ID тарифного плана.
      * Тарифные опции плана, описанные в JSON-файле конфигурации сервиса в [секции plans.schemas.service_instance.create](../../reference/saas-apps-reference/schemas-section).
      * (Опционально) Контекст, содержащий информацию о пользователе: электронная почта, [уникальный идентификатор проекта (PID)](/ru/tools-for-using-services/account/instructions/project-settings/manage#poluchenie_identifikatora_proekta).

   * Обновление тенанта или аккаунта. Входные данные метода:

      * ID инстанса сервиса.
      * ID тарифного плана.
      * Тарифные опции плана, описанные в JSON-файле конфигурации сервиса в [секции plans.schemas.service_instance.update](../../reference/saas-apps-reference/schemas-section).

   * Получение и удаление тенанта или аккаунта. Входные данные методов: ID инстанса сервиса.
   * Создание сервисных привязок (bindings). Входные данные метода:

      * ID инстанса сервиса.
      * Параметры сервисных привязок, описанные в JSON-файле конфигурации сервиса в [секции plans.schemas.service_binding.create](../../reference/saas-apps-reference/schemas-section).
      * (Опционально) Контекст, содержащий информацию о пользователе: электронная почта, [уникальный идентификатор проекта (PID)](/ru/tools-for-using-services/account/instructions/project-settings/manage#poluchenie_identifikatora_proekta).

   * Получение и удаление сервисных привязок. Входные данные методов:

      * ID инстанса сервиса.
      * ID сервисной привязки.

1. Интегрируйте клиент в сервисный менеджер.
1. Настройте аутентификацию в брокере.

1. Если в SaaS-приложении есть постоплатные тарифные опции и метрики по ним собираются по [pull-модели](/ru/tools-for-using-services/vendor-account/manage-apps/concepts/about#billing_pull), выполните дополнительные действия:

    1. В сервисном менеджере реализуйте метод для получения отчета по фактически использованным ресурсам SaaS-приложения. В ответе на запрос брокер должен передать магазину отчет.

        {cut(Пример отчета о фактически использованных ресурсах SaaS-приложения)}

        ```json
        {
            "batch_id": 35,
            "data": [
                {
                "kind": "vms",
                "type": "cb",
                "unit": "month",
                "price": 600.0,
                "value": 1.0,
                "plan_uuid": "2f070fe3-3e31-4482-bad4-a4d0c36bab31",
                "instance_uuid": "d1dff97c-df6c-45a7-95e1-b539a8d77721"
            },
            {
                "kind": "storage",
                "type": "cb",
                "unit": "GB-month",
                "price": 3.3,
                "value": 2.4474525451660156,
                "plan_uuid": "2f070fe3-3e31-4482-bad4-a4d0c36bab31",
                "instance_uuid": "d1dff97c-df6c-45a7-95e1-b539a8d77721"
            },
            {
                "kind": "vms",
                "type": "cb",
                "unit": "month",
                "price": 600.0,
                "value": 0.0,
                "plan_uuid": "354df2fa-5ec3-45e1-b99b-7d45840cf3df",
                "instance_uuid": "3910e993-63f0-4a90-95d7-5eea35785c29"
            },
            {
                "kind": "storage",
                "type": "cb",
                "unit": "GB-month",
                "price": 3.3,
                "value": 0.0,
                "plan_uuid": "354df2fa-5ec3-45e1-b99b-7d45840cf3df",
                "instance_uuid": "3910e993-63f0-4a90-95d7-5eea35785c29"
            },
            {
                "kind": "storage",
                "type": "cb",
                "unit": "GB-month",
                "price": 7.0,
                "value": 0.0,
                "plan_uuid": "d719f348-3497-4341-8465-a438bfcc2d96",
                "instance_uuid": "f10e67be-dfd7-4dcd-917c-4bfd3cd64ce2"
            }
            ]
        }
        ```
  
        Здесь:

        * `batch_id` — ID отчета, сформированный брокером.
        * `kind` — имя тарифной опции. Должно соответствовать имени, используемому в файле с конфигурацией сервиса.
        * `type` — имя сервиса. Должно соответствовать параметру `ИМЯ_СЕРВИСА`, указанному в имени файла с конфигурацией сервиса (`catalog_<ИМЯ_СЕРВИСА>.json`).
        * `unit` — единица измерения опции.
        * `price` — стоимость единицы опции в месяц. Должна соответствовать значению `plans.billing.options.cost` конкретной опции, указанному в файле с конфигурацией сервиса.
        * `value` — сколько единиц опции было фактически использовано за месяц. Значение формируется SaaS-приложением.
        * `plan_uuid` — ID тарифного плана.
        * `instance_uuid` — ID инстанса (тенанта/аккаунта) сервиса.

        {/cut}

    1. В сервисном менеджере реализуйте метод для сообщения брокеру о том, что отчет обработан (списание денежных средств по отчету произошло или запланировано).

## {heading(3. Загрузите конфигурацию сервиса в брокер)[id=saas_load_configuration_to_broker]}

1. Перейдите в директорию с брокером.
1. Поместите файл с конфигурацией сервиса `catalog_<ИМЯ_СЕРВИСА>.json` в поддиректорию `resources`.
1. В файле `resources/plan_mapping.json` укажите:

   * `<ИМЯ_СЕРВИСА>` — имя сервиса.
   * `<ID_ПЛАНА>` — ID тарифных планов, указанных в файле `catalog_<ИМЯ_СЕРВИСА>.json`.
   * `<SAAS_ID_ПЛАНА>` (формат `string`) — ID тарифных планов на стороне сервиса, соответствующих ID тарифных планов `<ID_ПЛАНА>`.

      ```json
      {
        "<ИМЯ_СЕРВИСА>": {
          "<ID_ПЛАНА>": <SAAS_ID_ПЛАНА>,
          "<ID_ПЛАНА>": <SAAS_ID_ПЛАНА>
        }
      }
      ```

   Пример содержимого файла `plan_mapping.json`:

   ```json
   {
     "VKT": {
       "0dc54b75-XXXX-89d5a47eef71": 1,
       "312b628e-XXXX-080ab4ca3acb": 2,
       "e2ae1588-XXXX-3f5081a799a9": 3,
       "b54e7247-XXXX-7a9dccc22e7b": 4
     }
   }
   ```

1. В директории с брокером переименуйте файл `.env.example` в `.env`.
1. В файле `.env` укажите имя сервиса в `BROKER_MODE`:

   ```json
   BROKER_MODE=<ИМЯ_СЕРВИСА>
   ```

## 4. (Опционально) Протестируйте брокер локально

1. В файле `.env` в директории брокера опишите переменные окружения:

   * `BROKER_PROVIDER_CLIENT_ID` — имя брокера для доступа к SaaS-приложению.
   * `BROKER_PROVIDER_SECRET` — пароль для доступа брокера к SaaS-приложению.
   * `BROKER_PROVIDER_URL` — URL SaaS-приложения.
   * `BROKER_USERNAME` — имя магазина для межсервисного взаимодействия c брокером.
   * `BROKER_PASSWORD` — пароль магазина для межсервисного взаимодействия с брокером.

1. В файле `.env` в директории брокера укажите значения переменных для доступа к БД брокера.
1. Установите Python-библиотеки, выполнив команду:

   {tabs}

   {tab(Linux)}

   ```console
   pip install -r requirements/prod.txt
   ```

   {/tab}

   {/tabs}

1. Запустите брокер, выполнив команду:

   {tabs}

   {tab(Linux)}

   ```console
   gunicorn app.main:app --log-file - --workers ${UVICORN_WORKERS:-1} --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:${BROKER_PORT:-8000} --timeout ${WORKER_TIMEOUT:-90}
   ```

   {/tab}

   {/tabs}

   Пример ответа на команду запуска брокера:

   ```console
   INFO:     Started server process [34934]
   INFO:     Waiting for application startup.
   INFO:     Application startup complete.
   INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
   ```

1. После установки брокера откройте в браузере страницу [http://0.0.0.0:8000/docs](http://0.0.0.0:8000/docs).

   Страница содержит описание API брокера в редакторе Swagger.

1. Выполните запросы API, используя следующие параметры:

   * Значение версии протокола VK OSB `x-broker-api-version` (например, `"0.1"`).
   * Значение `BROKER_USERNAME` из файла `.env`.
   * Значение `BROKER_PASSWORD` из файла `.env`.

## 5. Разверните образ с брокером в окружении

Чтобы собрать образ, воспользуйтесь файлом `Dockerfile` в директории шаблона брокера.

{note:warn}

Чтобы Marketplace мог взаимодействовать с брокером и SaaS-приложением, брокер должен быть доступен круглосуточно.

{/note}

## 6. Зарегистрируйте брокер

Отправьте письмо на [marketplace@cloud.vk.com](mailto:marketplace@cloud.vk.com). В письме укажите:

* Информацию о компании:

  * имя компании,
  * контактное лицо,
  * телефон.

* Электронную почту пользователя, которому будут приходить уведомления об ошибках при создании инстансов сервиса.
* Параметры брокера, приведенные в таблице.

[cols="2,5,2,2", options="header"]
|===
|Имя
|Описание
|Формат
|Обязательный

|`name`
|
Имя брокера
|string
| ![](/ru/assets/check.svg "inline")

|`url`
|
URL, на который будут отправляться запросы от магазина
|string
| ![](/ru/assets/check.svg "inline")

|`description`
|
Описание брокера
|string
| ![](/ru/assets/no.svg "inline")

|`osb_version`
|
Версия протокола VK OSB
|string
| ![](/ru/assets/check.svg "inline")

|`username`
|
Имя магазина для межсервисного взаимодействия c брокером.

{note:err}

Должно совпадать со значением переменной окружения `BROKER_USERNAME` в файле `.env` директории брокера

{/note}

|string
| ![](/ru/assets/no.svg "inline")

|`password`
|
Пароль магазина для межсервисного взаимодействия с брокером.

{note:err}

Должен совпадать со значением переменной окружения `BROKER_PASSWORD` в файле `.env` директории брокера

{/note}
|string
| ![](/ru/assets/no.svg "inline")
|===

После регистрации брокера SaaS-приложение будет доступно в тестовом пространстве имен магазина. В открытом пространстве имен магазина сервис будет доступен только после публикации.

## {heading(7. Протестируйте сервис в магазине)[id=saas_test_marketplace]}

Чтобы проверить, как сервис будет функционировать в VK Cloud, протестируйте его в тестовом пространстве имен магазина:

1. Отправьте письмо на [marketplace@cloud.vk.com](mailto:marketplace@cloud.vk.com), чтобы получить бонусы, которые выдаются для тестирования сервиса. Средства будут зачислены на бонусный счет вашего проекта в VK Cloud.
1. Если у вас нет доступа к тестовым пространствам имен, указанным в конфигурации сервиса, отправьте письмо на [marketplace@cloud.vk.com](mailto:marketplace@cloud.vk.com). В письме укажите:

   * Имена тестовых пространств имен Marketplace, заданных в параметре `metadata` в [JSON-файле конфигурации сервиса](../../reference/saas-apps-reference/saas-param).
   * Электронную почту пользователя, которому необходим доступ в тестовые пространства имен Marketplace.

1. [Перейдите](https://msk.cloud.vk.com/app/services/marketplace) в раздел **Магазин приложений** личного кабинета VK Cloud.
1. Нажмите кнопку **Все решения**.
1. Нажмите на карточку вашего сервиса и перейдите на вкладку **Тарифные планы**.
1. Убедитесь, что мастер конфигурации каждого тарифного плана отображается корректно.
1. Подключите сервис.
1. Обновите инстанс сервиса:

   1. Поменяйте значения тарифных опций текущего тарифного плана.
   1. Перейдите на новый тарифный план.

1. Проверьте основные пользовательские сценарии сервиса.
1. [Удалите](/ru/applications-and-services/marketplace/instructions/pr-instance-manage#udalenie_instansa_servisa) инстанс сервиса.
1. Если вы указали тестовые значения стоимости в конфигурации сервиса на время тестирования и отладки, [отредактируйте](../saas-update) их.
1. Если в процессе тестирования вы изменили конфигурацию сервиса, убедитесь, что ревизия сервиса [обновлена](../saas-update).

## {heading(8. Опубликуйте сервис)[id=saas_publish_service]}

Отправьте письмо на [marketplace@cloud.vk.com](mailto:marketplace@cloud.vk.com). В письме укажите ID сервиса и его ревизию.

Будет проведено модерирование конфигурации сервиса. После этого сервис будет опубликован в магазине.

Публикуемая ревизия сервиса переместится из тестового пространства имен магазина в открытое, указанное в параметре `metadata` [JSON-файле конфигурации сервиса](../../reference/saas-apps-reference/saas-param). Сервис будет доступен всем пользователям, имеющим доступ в это открытое пространство имен.

{note:warn}

В открытых пространствах имен доступна только последняя опубликованная ревизия сервиса.

{/note}
