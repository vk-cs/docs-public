Вы можете в автоматическом режиме устанавливать SSL-сертификаты на инстансы ваших image-based приложений при их развертывании на платформе VK Cloud, а также своевременно обновлять установленные SSL-сертификаты. Это позволит вашим приложениям использовать защищенный HTTPS-протокол для обмена данными с пользователями.

Ниже на примере показано, как интегрировать [систему управления SSL-сертификатами](/ru/tools-for-using-services/vendor-account/concepts/ssl-cert-concept) в image-based приложение.

## {heading(Подготовительные шаги)[id=preparatory_steps]}

Зарегистрируйте домен, в котором будут находиться инстансы image-based приложения, если это еще не сделано.

## {heading(1. Подготовьте образ ВМ инстанса приложения)[id=adjust_vm_image]}

При [подготовке образа](/ru/tools-for-using-services/vendor-account/manage-apps/ibservice_add/ib_image_create) ВМ, на которой установлено image-based приложение:

1. Создайте директорию для хранения файла SSL-сертификата и файла с его приватным ключом.

   Если на ВМ будет установлено несколько приложений и SSL-сертификатов для них, для повышения безопасности рекомендуется создать отдельную директорию для каждого приложения.

1. (Опционально) Настройте доступ к файлам SSL-сертификата и его приватного ключа:

   1. Создайте пользователя, который будет назначен владельцем этих файлов.
   1. Создайте группу пользователей для файлов SSL-сертификата и его приватного ключа.
   1. Предоставьте пользователю и группе права доступа к файлам SSL-сертификата и его приватного ключа, а также к директории, где они будут размещены.

      Для повышения безопасности не рекомендуется предоставлять больше прав, чем необходимо. В этом случае достаточно установить права доступа:

      - для директории — `755` (владелец имеет неограниченный доступ, а группа и остальные пользователи — только права на чтение и выполнение);
      - для файлов — `644` (владелец имеет права на чтение и запись, а группа и остальные пользователи — только право на чтение).

1. (Опционально) Укажите, какие действия необходимо выполнять на ВМ инстанса каждый раз после обновления SSL-сертификата:

   1. Подготовьте bash-скрипт с нужными действиями и разместите файл скрипта на образе ВМ.
   1. Если был создан пользователь-владелец SSL-сертификата, предоставьте ему право доступа к директории, где находится скрипт, и право выполнять скрипт.
   1. Проверьте, что скрипт выполняется корректно.

## {heading(2. Подготовьте манифест Terraform приложения)[id=adjust_manifest]}

Добавьте [ресурс ivkcs_cert](/ru/tools-for-using-services/vendor-account/manage-apps/ivkcs/ivkcs_resources/ivkcs_cert) в [манифест Terraform](/ru/tools-for-using-services/vendor-account/manage-apps/ibservice_add/tf_manifest/tf_manifest_steps) с описанием инфраструктуры для развертывания инстанса приложения.

{cut(Пример ресурса с базовыми настройками)}

Приведенная в примере конфигурация ресурса:

- Создает SSL-сертификат для домена `example.com`.
- Размещает SSL-сертификат и его приватный ключ в директории `/etc/ssl/certs/`.
- Выполняет скрипт `/opt/scripts/reload_nginx.sh` каждый раз после обновления SSL-сертификата.

```hcl
resource "ivkcs_cert" "web_cert" {
  uuid              = var.instance_uuid
  domain            = "example.com"
  path_cert         = "/etc/ssl/certs/"
  renewal_hook_path = "/opt/scripts/reload_nginx.sh"
}
```

Здесь:

- `uuid` — идентификатор инстанса image-based приложения.
- `domain` — FQDN домена, в котором будут находиться инстансы вашего image-based приложения и для которого будет выпущен SSL-сертификат.
- `path_cert` — путь к директории, где будут храниться файл SSL-сертификата и файл с его приватным ключом.
- `renewal_hook_path` — путь к директории со скриптом, который будет выполняться после обновления SSL-сертификата.

{/cut}

{cut(Пример ресурса с расширенными настройками)}

Приведенная в примере конфигурация ресурса:

- Создает SSL-сертификат для домена `secure.example.com`.
- Размещает SSL-сертификат и его приватный ключ в директории `/opt/app/ssl/`.
- Выполняет скрипт `/opt/app/scripts/restart_service.sh` каждый раз после обновления SSL-сертификата.
- Назначает пользователя `nginx` владельцем файлов SSL-сертификата и его приватного ключа.
- Назначает группу `ssl-cert` для файлов SSL-сертификата и его приватного ключа.
- Устанавливает тайм-ауты для операций с SSL-сертификатом.

```hcl
resource "ivkcs_cert" "secure_cert" {
  uuid              = var.instance_uuid
  domain            = "secure.example.com"
  path_cert         = "/opt/app/ssl/"
  renewal_hook_path = "/opt/app/scripts/restart_service.sh"
  cert_files_owner  = "nginx"
  cert_files_group  = "ssl-cert"

  timeouts {
    create = "30m"
    update = "15m"
    delete = "5m"
  }
}
```

Здесь:

- `uuid` — идентификатор инстанса image-based приложения.
- `domain` — FQDN домена, в котором будут находиться инстансы вашего image-based приложения и для которого будет выпущен SSL-сертификат.
- `path_cert` — путь к директории, где будут храниться файл SSL-сертификата и файл с его приватным ключом.
- `renewal_hook_path` — путь к директории со скриптом, который будет выполняться после обновления SSL-сертификата.
- `cert_files_owner` — пользователь-владелец файлов SSL-сертификата и его приватного ключа.
- `cert_files_group` — группа пользователей для файлов SSL-сертификата и его приватного ключа.
- `timeouts.create` — тайм-аут создания SSL-сертификата.
- `timeouts.update` — тайм-аут обновления SSL-сертификата.
- `timeouts.delete` — тайм-аут удаления SSL-сертификата.

{/cut}
