Сервис Cloud Desktop поддерживает два способа аутентификации пользователей при подключении к удаленным рабочим столам:

- Аутентификация с помощью службы каталогов пользователей AD или LDAP. Используется по умолчанию.
- Двухфакторная аутентификация с помощью сервиса [SAML](https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language) (доступно только для пулов рабочих столов под управлением ОС Windows).

Одновременно для всех рабочих столов сервиса Cloud Desktop используется только один из способов аутентификации пользователей. При необходимости между способами аутентификации можно переключаться. При этом не потребуется повторной настройки других компонентов сервиса: сети, подсистемы удаленного доступа к рабочим столам и подключения к каталогу пользователей.

Чтобы использовать сервис аутентификации SAML в Cloud Desktop, выполните подготовительные действия:

1. [Настройте](../setup-ldap) службу каталогов пользователей AD или LDAP.
1. Подключите поставщика удостоверений SAML к тому же домену, что и служба каталогов.
1. Подготовьте поставщика удостоверений SAML для интеграции с сервисом Cloud Desktop. Порядок настройки зависит от выбранного SAML-провайдера.

    <warn>

    Если вы выбрали [подсистему VK](../setup-provider), используйте [Keycloak](https://www.keycloak.org) в качестве поставщика удостоверений SAML. Настройте Keycloak, следуя [инструкции](../../../how-to-guides/keycloak).

    </warn>

Чтобы настроить двухфакторную аутентификацию с помощью сервиса SAML:

1. [Перейдите](https://msk.cloud.vk.com/app) в личный кабинет VK Cloud.
1. Перейдите в раздел **Cloud Desktop** → **Настройки сервиса**.
1. (Опционально) На вкладке **SAML** включите опцию **Включить SAML**.

    Если опция отключена, то аутентификация пользователей будет выполняться с помощью службы каталогов AD или LDAP.

1. На вкладке **SAML** задайте параметры:

    - **ID клиента**: укажите уникальный идентификатор клиентского приложения в сервисе аутентификации SAML.
    - **URL метаданных**: укажите URL-адрес, по которому находится XML-файл с метаданными для SAML-интеграции.
    - **Проверка SSL**: включите опцию, чтобы проверять всю цепочку сертификатов на валидность и отсутствие в списках отзыва. При отключенной опции будет проверяться только наличие SSL-сертификата.  
    - **Тип Биндинга**: выберите способ отправки ответа на запрос аутентификации сервисом SAML.

      - Для подсистемы Termidesk — `HTTP-Redirect` или `HTTP-POST`.
      - Для подсистемы VK — `HTTP-Redirect`, `HTTP-POST` или `Artifact`.

    - **Response Binding Type**: выберите способ обратного перенаправления пользователя на сервис, запросивший SAML-авторизацию.

      - Для подсистемы Termidesk — `HTTP-Redirect` или `HTTP-POST`.
      - Для подсистемы VK — `HTTP-Redirect`, `HTTP-POST` или `Artifact`.

    - **Формат Name ID**: выберите формат сопоставления идентификаторов имен SAML у поставщиков удостоверений и поставщиков услуг.

      - Для подсистемы Termidesk доступно только значение `Unspecified`.
      - Для подсистемы VK доступны следующие значения:

        - `Unspecified`: формат NameID указывается непосредственно в запросе на SAML-аутентификацию. 
        - `NotConfigured`: для NameID формат не настроен и не передается в запросе.
        - `Email address`: NameID совпадает с адресом электронной почты пользователя, например `john@company.com`.
        - `Transient`: сервис SAML идентифицирует пользователя с помощью предоставленного NameID и дает ему доступ, который действует только для одного сеанса.
        - `Persistent`: предоставленный NameID регистрируется в сервисе SAML и используется для нескольких сеансов.
        - `X509SubjectName`: NameID совпадает с именем пользователя в сертификате X.509, например `CN=john,O=Company Ltd.,C=US`.
        - `WindowsDomainQualifiedName`: NameID совпадает с именем пользователя в формате FQDN, например `CompanyDomain\John`.
        - `KerberosPrincipalName`: NameID совпадает с именем принципала в протоколе Kerberos, например `john@realm`.
        - `EntityIdentifier`: NameID имеет формат URI и используется для идентификации поставщика SAML-услуг.

    - **Group Attr Name**: укажите тип атрибута пользователя, который будет возвращаться сервисом SAML и на основании которого система будет принимать решение о предоставлении доступа. Тип атрибута может быть любым. Обычно указывается значение `Group`, т.е. доступ предоставляется в зависимости от того, к какой группе принадлежит пользователь.

      <warn>

      Если вы выбрали [подсистему VK](../setup-provider), укажите значение `memberOf`.

      </warn>

1. Нажмите кнопку **Сохранить**.
