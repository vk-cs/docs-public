В этом руководстве приведены рекомендации по диагностике и устранению проблем с конфигурацией сети на виртуальных машинах.

В качестве примера предполагается, что:

- виртуальная машина имеет только один сетевой интерфейс;
- решается проблема отсутствующего доступа к виртуальной машине по SSH.

Описанные шаги также могут быть использованы, когда потерян доступ до другого приложения, например веб-сервера NGINX или когда у виртуальной машины есть несколько сетевых интерфейсов.

## Перед началом работы

1. Выполните принудительную перезагрузку.

   Эта операция может помочь, если виртуальная машина не отвечает или ее сетевой интерфейс инициализируется некорректно:
   1. [Остановите](../../instructions/vm/vm-manage#start_stop_restart_vm) виртуальную машину.
   1. Для остановленной виртуальной машины [выполните](../../instructions/vm/vm-manage#prinuditelnyy_perezapusk_vm) принудительный перезапуск.

   Если это не решило проблему, выполните остальные шаги и перейдите к диагностике.

1. [Убедитесь](../../instructions/vm/vm-manage#start_stop_restart_vm), что виртуальная машина запущена.

1. [Убедитесь](../../instructions/vm/vm-console#vnc_konsol), что вы можете получить доступ к VNC-консоли виртуальной машины и авторизоваться в ней.

   Если это необходимо, [восстановите пароль](../../instructions/vm/vm-manage#vosstanovlenie_parolya) для логина.

## 1. Проверьте настройки сетевого интерфейса

Иногда подключению препятствуют некорректная инициализация сетевого интерфейса виртуальной машины или его неверные настройки. Проверьте [настройки сетевого интерфейса](/ru/computing/iaas/how-to-guides/interface-settings-check).

## 2. Проверьте, что нужные приложения запущены на виртуальной машине

Если сетевой интерфейс настроен корректно, но доступа нет, проверьте, что на виртуальной машине запущены необходимые приложения и сервисы, например SSH. Они могут быть не запущены или работать на нестандартном порте. 

Проверьте работу SSH:

1. Подключитесь к консоли виртуальной машины и авторизуйтесь.

1. Проверьте, запущен ли сервис SSH:

   ```console
   sudo systemctl status ssh
   ```

   По выводу команды определите, запущен ли сервис:

   - `Active: active (running)`: сервис SSH запущен.
   - `Active: inactive (dead)`: сервис SSH не запущен.

1. В зависимости от статуса сервиса SSH выполните следующие действия:

   {tabs}

   {tab(Если сервис SSH запущен)}

   1. Определите, на каком порте работает сервис SSH:

      ```console
      sudo cat /etc/ssh/sshd_config | grep -w Port
      ```

      Вывод будет содержать номер порта, например `Port 22`.

      Если сервис работает на стандартном порте `22` — [перейдите к проверке настроек файервола ВМ](#3_proverte_nastroyki_fayervola_virtualnoy_mashiny). Иначе перейдите к следующему шагу.

   1. Подключитесь к ВМ, указав номер порта:

      ```console
      ssh -i <ПУТЬ_К_КЛЮЧУ> <ИМЯ_ПОЛЬЗОВАТЕЛЯ>@<ВНЕШНИЙ_IP-АДРЕС_ВМ> -p <ПОРТ>
      ```
   1. Проверьте наличие доступа к виртуальной машине по SSH. Если доступа нет, [перейдите к проверке настроек файервола ВМ](#3_proverte_nastroyki_fayervola_virtualnoy_mashiny).

   {/tab}

   {tab(Если сервис SSH не запущен)}

   1. Определите, на каком порте работает сервис SSH:

      ```console
      sudo cat /etc/ssh/sshd_config | grep -w Port
      ```

      Вывод будет содержать номер порта, например `Port 22`.

   1. Убедитесь, что другие процессы не используют этот порт. Просмотрите логи сервиса SSH:

      ```console
      sudo journalctl -xeu ssh
      ```

      Если в логах есть подобная строка, то порт сервиса SSH используется другим процессом:

      ```text
      error: Bind to port 22 on 0.0.0.0 failed: Address already in use.
      ```

   1. Определите, какой процесс занял порт:

      1. Установите утилиту `netstat`:

         {tabs}
         {tab(Debian, Ubuntu)}

         ```console
         sudo apt install net-tools -y
         ```

         {/tab}
         {tab(AlmaLinux, CentOS)}

         ```console
         sudo yum install net-tools -y
         ```

         {/tab}
         {/tabs}

      1. Выполните команду:

         ```console
         sudo netstat -plntu | grep :22
         ```

         В этом примере вывода порт `22` используется процессом `some-other-service` с PID `1234`:

         ```text
         tcp   0   0 0.0.0.0:22   0.0.0.0:*  LISTEN   1234/some-other-service
         tcp6  0   0 :::22        :::*       LISTEN   1234/some-other-service
         ```

   1. Остановите процесс, использующий порт SSH:

      - либо с помощью `systemctl`:

          ```console
          sudo systemctl stop some-other-service
          ```

      - либо принудительно завершив работу процесса:

         ```console
         sudo kill 1234
         ```

   1. Измените настройки сервиса, соответствующего остановленному процессу, чтобы сервис использовал порт, отличный от `22`.

   1. Перезапустите сервис:

      ```console
      sudo systemctl restart some-other-service
      ```

   1. Перезапустите сервис SSH:

      ```console
      sudo systemctl restart sshd
      ```

   1. Убедитесь, что сервис SSH успешно запущен:

      ```console
      sudo systemctl status sshd
      ```

      {caption(Пример фрагмента вывода)[align=left;position=above]}
      ```text
      Active: active (running)
      ```
      {/caption}

      Если сервис SSH не запускается, проверьте настройки сервиса в конфигурационном файле `/etc/ssh/sshd_config`.

      Для получения дополнительной информации о проблемах в работе сервиса посмотрите логи:

      ```console
      sudo journalctl -xeu ssh
      ```

   1. Проверьте наличие доступа к виртуальной машине по SSH. Если доступа нет, [перейдите к проверке настроек файервола ВМ](#3_proverte_nastroyki_fayervola_virtualnoy_mashiny).

   {/tab}

   {/tabs}

## 3. Проверьте настройки файервола виртуальной машины

Если на виртуальной машине настроен файервол (например, `iptables`, `ufw`, `firewalld`), то он может препятствовать подключению.

Далее описано, как временно отключить все правила файервола, разрешив весь трафик. Это поможет убедиться, что проблема именно в файерволе.

{note:warn}

После того как проблема с подключением будет локализована, верните настройки файервола (с необходимыми корректировками). Если весь трафик разрешен, безопасность виртуальной машины снизится.

{/note}

Чтобы проверить настройки файервола:

1. Подключитесь к консоли виртуальной машины и авторизуйтесь.

1. Отключите файервол:

   {tabs}
   {tab(ufw)}

   ```console
   sudo ufw disable
   ```

   {/tab}
   {tab(firewalld)}

   ```console
   sudo systemctl stop firewalld
   ```

   {/tab}
   {tab(iptables)}

   1. Сохраните существующие правила `iptables`:

      ```console
      sudo iptables-save | sudo tee ~/iptables.rules
      ```

   1. Выполните команды:

      ```console
      sudo iptables -P INPUT ACCEPT
      sudo iptables -P FORWARD ACCEPT
      sudo iptables -P OUTPUT ACCEPT
      sudo iptables -t nat -F
      sudo iptables -t mangle -F
      sudo iptables -F
      sudo iptables -X
      ```

   {/tab}
   {/tabs}

1. Проверьте наличие доступа по SSH к виртуальной машине.

   Если доступ появился, скорректируйте правила файервола и снова включите его.

   Если доступ не появился, снова включите файервол.

Чтобы снова включить файервол:

1. Подключитесь к консоли виртуальной машины и авторизуйтесь.

1. Выполните команду:

   {tabs}
   {tab(ufw)}

   ```console
   sudo ufw enable
   ```

   {/tab}
   {tab(firewalld)}

   ```console
   sudo systemctl start firewalld
   ```

   {/tab}
   {tab(iptables)}

   ```console
   sudo iptables-restore < ~/iptables.rules
   ```

   {/tab}
   {/tabs}

## 4. Проверьте настройки групп безопасности

Некорректно настроенные группы безопасности могут препятствовать подключению по SSH, даже если на уровне виртуальной машины препятствий нет.

Далее описано, как временно настроить правила групп безопасности так, чтобы разрешить весь трафик. Это поможет убедиться, что проблема именно в группах безопасности.

{note:warn}

После того как проблема с SSH-подключением будет локализована, заново настройте правила групп безопасности (с необходимыми корректировками). Если весь трафик разрешен, безопасность виртуальной машины снизится.

{/note}

Чтобы проверить настройки групп безопасности:

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужная виртуальная машина.
1. Перейдите в раздел **Облачные вычисления → Виртуальные машины**.
1. Нажмите на имя нужной виртуальной машины.
1. Перейдите на вкладку **Сети**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного сетевого подключения и выберите пункт **Редактировать подключение**.
1. В параметре **Настройки Firewall**:

   1. Удалите все выбранные группы безопасности.
   1. Выберите из выпадающего списка группы безопасности `default` и `all` («все разрешено»).

      Группа безопасности `default` разрешает любой исходящий трафик. Группа безопасности `all` разрешает любой входящий трафик.

1. Нажмите кнопку **Сохранить**.

1. Проверьте наличие доступа по SSH к виртуальной машине.

   Если доступ появился, скорректируйте группы безопасности и добавьте их снова вместо группы `all`.

   Если доступ не появился, вернитесь к исходным настройкам.

Чтобы снова включить группы безопасности:

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужная виртуальная машина.
1. Перейдите в раздел **Облачные вычисления → Виртуальные машины**.
1. Нажмите на имя нужной виртуальной машины.
1. Перейдите на вкладку **Сети**.
1. Нажмите ![ ](/ru/assets/more-icon.svg "inline") для нужного сетевого подключения и выберите пункт **Редактировать подключение**.
1. В параметре **Настройки Firewall**:

   1. Удалите группу безопасности `all`.
   1. Выберите из выпадающего списка необходимые группы безопасности.

      Если выбранные группы безопасности не содержат правила, разрешающие исходящий трафик, выберите также группу безопасности `default`. Эта группа разрешает исходящий трафик. В противном случае у виртуальной машины не будет доступа в сеть.

   {note:info}

   Чтобы правила пропускали трафик SSH-сервиса, работающего на стандартном порте `22`, достаточно выбрать группы `default` и `ssh` («разрешен только ssh»).

   {/note}

## 5. Обратитесь в техническую поддержку

Если диагностика не помогла в решении проблемы, [обратитесь в техническую поддержку](/ru/contacts), предоставив информацию, полученную при диагностике.
