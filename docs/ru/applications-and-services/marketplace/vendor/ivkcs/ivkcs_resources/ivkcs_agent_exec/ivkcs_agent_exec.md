# {heading(Ресурс ivkcs_agent_exec)[id=ivkcs_agent_exec]}

Аргументы ресурса `ivkcs_agent_exec` приведены в {linkto(#tab_arguments)[text=таблице %number]}.

{caption(Таблица {counter(table)[id=numb_tab_arguments]} — Аргументы ресурса ivkcs_agent_exec)[align=right;position=above;id=tab_arguments;number={const(numb_tab_arguments)}]}
[cols="2,5,2,2", options="header"]
|===
|Имя
|Описание
|Формат
|Обязательный

|
`uuid`
|
Идентификатор развертывания сервиса
|string
|Да

|
`name`
|
Общее имя для скриптов, описанных в аргументе `step`
|string
|Да

|
`hosts`
|
Список имен хостов, где будет выполняться скрипт
|list, элементы списка — string
|Да

|
`step`
|
Описывает скрипты, которые будут запускаться агентами на хостах. Определяет порядок выполнения скриптов
|list, структура одного элемента приведена в таблице ниже
|Да
|===
{/caption}

Аргументы одного элемента `step` приведены в {linkto(#tab_arguments1)[text=таблице %number]}.

{caption(Таблица {counter(table)[id=numb_tab_arguments1]} — Аргументы одного элемента step)[align=right;position=above;id=tab_arguments1;number={const(numb_tab_arguments1)}]}
[cols="2,5,2,2,2", options="header"]
|===
|Имя
|Описание
|Формат
|Обязательный
|Пересоздание ресурса при изменении значения

|
`index`
|
Индекс скрипта, определяет порядок выполнения
|
integer
|Да
|Нет

|
`type`
|
Язык скрипта. Возможные значения:

* `bash`
* `python`

|
string
|Да
|Нет

|
`options`
|
Параметры выполнения скрипта
|
set, аргументы списка — в {linkto(#tab_script_options)[text=таблице %number]}
|Нет
|Да

|
`content`
|
Тело скрипта
|
string
|Да
|Да
|===
{/caption}

Аргументы `options` для описания опций скрипта приведены в {linkto(#tab_script_options)[text=таблице %number]}.

{caption(Таблица {counter(table)[id=numb_tab_script_options]} — Опции скрипта)[align=right;position=above;id=tab_script_options;number={const(numb_tab_script_options)}]}
[cols="2,5,2,2", options="header"]
|===
|Имя
|Описание
|Формат
|Значение по умолчанию

|
`environment_variables`
|
Список переменных окружения, дополнительных к переменным окружения системы
|
list, элементы списка — string в формате `<ENVIRONMENT_VARIABLE_NAME>=<VALUE>`
|
—

|
`exit_codes`
|
Ожидаемые коды выхода скрипта.

Если получен код выхода, означающий успешное выполнение скрипта, то скрипту присваивается статус  `success`.

Если получен код выхода, означающий завершение скрипта с ошибкой, то скрипт будет запущен повторно. Если в результате всех повторных попыток скрипт завершен с ошибкой, то статус скрипта — `failed`

Параметры повторного запуска задаются в опциях:

* `attempts`
* `attempt_pause`

|
list, элементы списка — integer
|
`0, -1`.

Код `0` — скрипт завершен успешно.

Код `-1` — с ошибкой

|
`halt_codes`
|
Коды выхода скрипта, при которых скрипт не будет запущен повторно
|
list, элементы списка — integer
|
`125`

|
`stop_signal`
|
Сигнал, отправляемый скрипту, если превышен тайм-аут его выполнения — `SIGTERM`.

Тайм-аут задается в опции `timeout`
|
integer
|
`15`

|
`stop_timeout`
|
Тайм-аут, отсчитываемый с момента получения сигнала `SIGTERM`. По истечении тайм-аута процесс завершается принудительно — `SIGKILL`.

Пример значений:

* `1m`.
* `15s`.
* `1h`

|
string
|
`5s`

|
`cwd`
|
Директория для выполнения скрипта
|
string
|
`/tmp`

|
`user`
|
Пользователь, от имени которого скрипт будет запущен.

<warn>

Если указанный пользователь не будет найден, то скрипт будет запущен от пользователя по умолчанию.

</warn>
|
string
|
`root`

|
`group`
|
Группа пользователя, от имени которого скрипт будет запущен.

<warn>

Если указанная группа пользователей не будет найдена, то скрипт будет запущен от группы по умолчанию.

</warn>
|
string
|
`root`

|
`timeout`
|
Тайм-аут выполнения скрипта. Если скрипт не завершился в течение тайм-аута, то ему отправляется сигнал `SIGTERM` (задан в опции `stop_signal`).

Значение задается в таком же формате, как и опция `stop_timeout`
|
string
|
`60s`

|
`attempts`
|
Количество попыток повторного запуска скрипта, если получены коды выхода о завершении скрипта с ошибкой (заданы в опции `exit_codes`).

<warn>

Коды из списка `halt_codes` не приводят к повторному запуску скрипта.

</warn>
|
integer
|
`3`

|
`attempt_pause`
|
Длительность паузы между повторными запусками скрипта.

Значение задается в таком же формате, как и опция `stop_timeout`
|
string
|
`5s`

|
`pause_before`
|
Длительность паузы перед запуском скрипта.

Значение задается в таком же формате, как и опция `stop_timeout`
|
string
|
`0`

|
`pause_after`
|
Длительность паузы после завершения скрипта.

Значение задается в таком же формате, как и опция `stop_timeout`
|
string
|
`0`

|
`store_result`
|
Сохранять или нет результат выполнения скрипта на диск хоста
|
boolean
|
true

|
`structured_result_file`
|
Путь файла с форматированным результатом скрипта
|
string
|
—

|
`once`
|
Определяет, будет ли скрипт выполняться только один раз или будет выполняться при каждом повторном развертывании сервиса.

Если задано значение `true`, то скрипт будет выполнен только при первоначальном развертывании сервиса
|
boolean
|
`false`
|===
{/caption}

Для каждого скрипта, описанного в `step`, ресурс `ivkcs_agent_exec` возвращает атрибут `hash` (формат string), который содержит хеш скрипта для передачи в сервис управления конфигурациями. По полученным значениям сервис управления конфигурациями сравнивает текущее и целевое (описано в манифесте Terraform) состояние хостов.