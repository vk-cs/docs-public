Это руководство поможет вам сменить домен и настроить SSL-сертификаты для вашего WordPress-сайта. Рассмотрен следующий пример:

- Сервис WordPress развернут на сервере под управлением AlmaLinux с использованием процесса HTTPD (Apache) и системы принудительного контроля доступа SELinux.
- Этот сервер находится в домене `old-domain.com` и будет перенесен в новый домен `new-domain.com`, зарегистрированный вами самостоятельно.

## 1. Измените доменное имя на сервере

1. Отредактируйте конфигурацию виртуального хоста Apache:

    1. Откройте конфигурационный файл Apache для вашего сайта. Обычно он находится в `/etc/httpd/conf.d/your-site.conf`.
    1. Найдите блок `VirtualHost` и замените в нем текущее доменное имя на новое.

        Пример блока с новым доменным именем:

        ```apache
        <VirtualHost *:80>
            ServerName new-domain.com
            ServerAlias www.new-domain.com
            DocumentRoot /var/www/html
            <Directory "/var/www/html">
                AllowOverride All
                Require all granted
            </Directory>
        </VirtualHost>
        ```

1. Если используются дополнительные файлы конфигурации (например, для поддоменов), замените в них доменное имя на новое.

1. Перезапустите Apache с помощью команды:

    ```bash
    sudo systemctl restart httpd
    ```

1. Если у вас включен SELinux, настройте его для работы с новым доменом:

    1. Восстановите SELinux-контекст безопасности для папки `/var/www/html/`, чтобы Apache имел доступ к новым конфигурациям. Для этого выполните команду:

        ```bash
        sudo restorecon -Rv /var/www/html/
        ```

    1. Разрешите демону HTTPD устанавливать внешние сетевые подключения и обращаться к домашним директориям пользователей. Для этого выполните команды:

        ```bash
        sudo setsebool -P httpd_can_network_connect 1
        sudo setsebool -P httpd_enable_homedirs 1
        ```

1. Настройте SSL-сертификат.

    1. Установите пакет `Certbot` для автоматического получения сертификатов от Let’s Encrypt, выполнив команду:

        ```bash
        sudo dnf install certbot python3-certbot-apache
        ```

    1. Запустите `Certbot` и следуйте инструкциям для автоматической установки SSL-сертификата на новый домен:

        ```bash
        sudo certbot --apache -d new-domain.com -d www.new-domain.com
        ```

    1. Когда `Certbot` предложит перенаправление HTTP на HTTPS, включите эту опцию. Это позволит автоматически перенаправлять пользователей на безопасное соединение.

    1. После установки SSL-сертификата включите его автоматическую проверку и обновление, выполнив команду:
  
        ```bash
        sudo systemctl enable certbot-renew.timer
        ```

    1. Перезапустите Apache с помощью команды:

        ```bash
        sudo systemctl restart httpd
        ```

        <info>

        С этого момента для перехода на дашборд WordPress используйте адрес `http://new-domain.com/wp-admin`.

        </info>

## 2. Измените доменное имя в настройках WordPress

1. Измените URL-адреса в настройках WordPress:

    1. Перейдите в браузере по адресу `http://new-domain.com/wp-admin`.
    1. Войдите в WordPress, используя логин и пароль администратора.
    1. Перейдите в раздел **Settings → General**.
    1. Замените доменное имя на новое в полях **WordPress Address (URL)** и **Site Address (URL)**:

        ```txt
        https://new-domain.com
        ```

    1. Нажмите кнопку **Save Changes**.

1. Замените все ссылки на старый домен новыми в контенте и настройках базы данных, выполнив команды:

    ```bash
    cd /var/www/html
    wp search-replace 'http://old-domain.com' 'https://new-domain.com' --allow-root
    ```

1. Если вы используете кеширующий плагин, например, **WP Super Cache** или **W3 Total Cache**, очистите весь кеш через настройки плагина.
1. Сгенерируйте заново структуру постоянных URL-адресов на сайте. Для этого перейдите в раздел **Settings → Permalinks** и нажмите кнопку **Save Changes**.

    <info>

    С этого момента для перехода на ваш WordPress-сайт используйте адрес `http://new-domain.com`.

    </info>

## 3. Проверьте корректность работы сайта

1. Проверьте SSL-сертификат:

    1. Перейдите на сайт и убедитесь, что он открывается по протоколу HTTPS без ошибок.
    1. Используйте онлайн-инструменты, такие как [SSL Labs](https://www.ssllabs.com/ssltest/), для проверки корректности SSL-сертификата.

1. Убедитесь, что все запросы к старому домену корректно перенаправляются на новый. Это можно сделать с помощью инструмента [Redirect Checker](https://www.redirect-checker.org/).

1. Проверьте функциональность сайта:

    1. Пройдитесь по страницам сайта и убедитесь, что ссылки работают корректно.
    1. Убедитесь, что по новым URL-ссылкам загружаются все медиафайлы.

## 4. Усильте безопасность сайта

Для улучшения безопасности настройте HSTS — механизм, принудительно активирующий защищенное соединение через протокол HTTPS. Для этого добавьте в конфигурацию Apache следующие строки:

```apache
<VirtualHost *:443>
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
</VirtualHost>
```

## 5. Обновите ссылки на ваш сайт

1. Если ваш сайт уже был проиндексирован поисковыми системами, отправьте в Google Search Console и Яндекс Вебмастер новую XML-карту сайта, указав в ней новое доменное имя.
1. Если вы активно ведете социальные сети или другие внешние ресурсы, обновите в них ссылки на ваш домен.
