Вы можете защитить свою инфраструктуру от возможных веб-угроз с помощью сервиса Check Point CloudGuard Network. Этот сервис представляет собой комплексное решение для усовершенствованного предотвращения угроз и защиты сети в облаке любого типа. Сервис Check Point CloudGuard Network включает в себя:

* Security Gateway BYOL — виртуальный шлюз (файервол нового поколения);
* Security Management BYOL — сервер управления сервисом.

<details>

<summary>Принцип работы сервиса</summary>

1. В одной или разных сетях создаются две ВМ: виртуальный шлюз и сервер управления, — с предустановленной на них ОС GAiA.
1. На каждой из этих ВМ при первом подключении запускается мастер первоначальной настройки, который позволяет настроить стартовые параметры для последующей работы с этими ВМ через веб-интерфейс.
1. К шлюзу подключаются нужные сети.
1. Управление сервисом происходит с помощью приложения SmartConsole, которое подключается к серверу управления. Это приложение позволяет:

   * настроить связь виртуального шлюза с сервером управления;
   * настроить политику безопасности, добавив нужные лицензии;
   * настроить резервное копирование.

</details>

Пройдя все шаги инструкции, вы:

1. Развернете и настроите виртуальный шлюз.
1. Развернете и настроите сервер управления.
1. Настроите сетевой доступ к шлюзу и серверу управления.
1. Настроите сетевые интерфейсы шлюза.
1. Настроите политику безопасности.
1. Ознакомитесь с вариантами резервного копирования.

Используя сервис Check Point CloudGuard Network, вы соглашаетесь с лицензионным соглашением [магазина приложений](/ru/intro/start/legal/marketplace), а также с [лицензионным соглашением Check Point](https://www.checkpoint.com/support-services/software-license-agreement-limited-hardware-warranty/).

<warn>

Check Point CloudGuard Network предоставляется по модели BYOL (Bring Your Own Licence). Напишите партнеру Check Point на почту [cpcloud@rrc.ru](mailto:cpcloud@rrc.ru) для приобретения лицензии на использование сервиса.

</warn>

## {heading(Подготовительные шаги)[id=preparatory_steps]}

1. [Зарегистрируйтесь](/ru/intro/start/account-registration) в VK Cloud.
1. Спланируйте топологию сети и адресацию: продумайте, будут ли виртуальный шлюз и сервер управления находиться в одной сети или в разных. По умолчанию при развертывании шлюза и сервера управления используется одна и та же сеть.
1. (Опционально) Оцените необходимый размер диска ВМ, на которой будет развернут сервер управления Check Point CloudGuard Network, в зависимости от приобретенных лицензий Check Point.

   <details>

   <summary>Требования к инфраструктуре виртуального шлюза</summary>

   | Системные требования | Количество CPU, шт | Объем RAM, ГБ | Объем жесткого диска, не менее ГБ |
   |----------------------|--------------------|---------------|-----------------------------------|
   | Минимальные          | 1                  | 8             | 100                               |
   | Оптимальные          | 2                  | 12            | 150                               |

   </details>

   <details>

   <summary>Требования к инфраструктуре сервера управления</summary>

   | Лицензия             | Количество CPU, шт | Объем RAM, ГБ | Объем жесткого диска, не менее ГБ |
   |----------------------|--------------------|---------------|-----------------------------------|
   | Network Policy Management blade |2        | 8             | 200                               |
   | Network Policy Management blade \+ SmartLog | 2 | 10      | 200                               |
   | Network Policy Management blade \+ SmartLog \+ SmartEvent/SmartReporter | 4 | 12 | 200        |

   </details>

1. (Опционально) [Создайте](/ru/networks/vnet/service-management/net#sozdanie_seti) сеть с доступом в интернет, если она не была создана ранее.

## 1. Разверните сервис Check Point CloudGuard Network

1. Разверните шлюз **Security Gateway BYOL**:

   1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
   1. Перейдите в раздел **Магазин приложений**.
   1. На карточке сервиса **Check Point CloudGuard Network — Security Gateway BYOL** нажмите кнопку **Подробнее**.
   1. На странице сервиса нажмите кнопку **Подключить**.
   1. Задайте параметры шлюза на странице настройки сервиса:

      - **Сеть**: выберите ранее созданную сеть с доступом в интернет или создайте новую, указав ее тип (Neutron или Sprut) и адрес подсети.
      - Остальные параметры оставьте без изменений.

   1. Нажмите кнопку **Следующий шаг**.
   1. На странице подтверждения проверьте итоговые параметры подключения и нажмите кнопку **Подключить тариф**.

   После завершения развертывания на почту придет одноразовая ссылка на инструкцию по настройке шлюза. Сохраните эту инструкцию.

1. Разверните сервер управления **Security Management BYOL**:

   1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
   1. Перейдите в раздел **Магазин приложений**.
   1. На карточке сервиса **Check Point CloudGuard Network — Security Management BYOL** нажмите кнопку **Подробнее**.
   1. На странице сервиса нажмите кнопку **Подключить**.
   1. Задайте параметры сервера управления на странице настройки сервиса:

      - **Сеть**: выберите ранее созданную сеть с доступом в интернет, где будет размещена ВМ с развернутым сервисом, или создайте новую сеть, указав ее тип (Neutron или Sprut) и адрес подсети.
      - Остальные параметры выберите в соответствии с [рекомендациями](#preparatory_steps) или оставьте значения по умолчанию.

   1. Нажмите кнопку **Следующий шаг**.
   1. На странице подтверждения проверьте итоговые параметры подключения и нажмите кнопку **Подключить тариф**.

   После завершения развертывания на почту придет одноразовая ссылка на инструкцию по настройке сервера управления. Сохраните эту инструкцию.

## {heading(2. Настройте виртуальный шлюз)[id=setup_gateway]}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **Облачные вычисления** → **Виртуальные машины**.
1. В списке виртуальных машин нажмите на имя ВМ, которая была создана в качестве виртуального шлюза.
1. На странице ВМ перейдите на вкладку **Консоль**.
1. Введите логин и пароль, полученные в инструкции по настройке шлюза, для входа в командную строку CLISH операционной системы GAiA.
1. Установите новый пароль на ВМ шлюза с помощью команды:

   ```bash
   set user admin password
   ```
1. Выполните команды:

   ```bash
   set hostname <имя_хоста>
   set interface eth0 ipv4-address <внутренний_IP> subnet-mask <маска_подсети>
   set static-route default nexthop gateway address <ip_шлюза_по_умолчанию> on
   save config
   ```

   Здесь:

   * `<имя_хоста>` — имя виртуальной машины шлюза. Имя ВМ генерируется автоматически при развертывании сервиса **Security Gateway BYOL**. Вы можете изменить имя ВМ с помощью этого параметра.
   * `<внутренний_IP>` — внутренний IP-адрес шлюза, указанный в инструкции по настройке шлюза.
   * `<маска_подсети>` — маска подсети, указанная в инструкции по настройке шлюза.
   * `<ip_шлюза_по_умолчанию>` — статический маршрут к шлюзу по умолчанию, указанный в инструкции по настройке шлюза.

## {heading(3. Настройте сервер управления)[id=setup_management]}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **Облачные вычисления** → **Виртуальные машины**.
1. В списке виртуальных машин нажмите на имя ВМ, которая была создана в качестве сервера управления.
1. На странице ВМ перейдите на вкладку **Консоль**.
1. Введите логин и пароль, полученные в инструкции по настройке сервера управления, для входа в командную строку CLISH операционной системы GAiA.
1. Установите новый пароль на ВМ сервера управления с помощью команды:

   ```bash
   set user admin password
   ```
1. Выполните команды:

   ```bash
   set hostname <имя_хоста>
   set interface eth0 ipv4-address <внутренний_IP> subnet-mask <маска_подсети>
   set static-route default nexthop gateway address <ip_шлюза_по_умолчанию> on
   save config
   ```

   Здесь:

   * `<имя_хоста>` — имя виртуальной машины сервиса управления. Имя ВМ генерируется автоматически при развертывании сервиса **Security Management BYOL**. Вы можете изменить имя ВМ с помощью этого параметра.
   * `<внутренний_IP>` — внутренний IP-адрес сервера управления, указанный в инструкции по настройке сервера управления.
   * `<маска_подсети>` — маска подсети, указанная в инструкции по настройке сервера управления.
   * `<ip_шлюза_по_умолчанию>` — статический маршрут к серверу управления по умолчанию, указанный в инструкции по настройке сервера управления.

## 4. Увеличьте размеры логических томов ВМ шлюза и севера управления

В случае развертывания шлюза и сервера управления на виртуальных машинах с диском более 100 ГБ увеличьте размер логических томов `lv_current` или `lv_log` для этих ВМ:

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **Облачные вычисления** → **Виртуальные машины**.
1. В списке виртуальных машин нажмите на имя ВМ, которая была создана в качестве шлюза или сервера управления Check Point CloudGuard Network.
1. На странице ВМ перейдите на вкладку **Консоль**.
1. Введите логин, полученный в инструкции по настройке нужной ВМ, и выбранный при настройке ВМ пароль.
1. Установите пароль для загрузчика GRUB 2:

   ```bash
   set grub2-password
   ```

1. Установите пароль для экспертного режима (аналог однопользовательского режима в Linux):

   ```bash
   set expert-password
   ```

1. Сохраните изменения в настройках:

   ```bash
   save config
   ```

1. Перезагрузите ВМ:

   ```bash
   reboot
   ```

1. Нажмите любую клавишу, когда во время загрузки появится приглашение `Press any key to see the boot menu`.
1. Выберите режим **Start in maintenance mode**.
1. Введите логин, установленный при настройке шлюза (или сервера управления) и пароль, установленный для загрузчика GRUB2.
1. Запустите диспетчер логических томов LVM:

    ```bash
    lvm_manager
    ```

1. Введите `2` для выбора опции `Resize lv_current/lv_log Logical Volume`.
1. Выберите нужный логический том, введя соответствующее число с клавиатуры.
1. Задайте любое значение из предложенного диапазона.

Дополнительная информация приведена в [статье sk95566](https://support.checkpoint.com/results/sk/sk95566) (доступ к статье открывается после приобретения продукта Check Point CloudGuard Network).

## {heading(5. Настройте сетевой доступ к шлюзу)[id=configure_network_access_to_gateway]}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **Виртуальные сети** → **Настройки firewall**.
1. Добавьте разрешающие правила для входящего трафика с IP-адресов вашей сети для группы безопасности, указанной в инструкции по настройке шлюза:
   1. Нажмите на имя нужной группы безопасности.
   1. В блоке **Входящий трафик** нажмите **+ Добавить правило**.
   1. Выберите типа трафика и укажите порты:

      <tabs>
      <tablist>
      <tab>Все протоколы и все порты</tab>
      <tab>HTTPS</tab>
      <tab>SSH</tab>
      </tablist>
      <tabpanel>

      Чтобы разрешить любой входящий трафик с IP-адресов вашей сети:

      1. В поле **Тип** выберите **Все протоколы и все порты**.
      1. В разделе **Удаленный адрес** выберите **Диапазон IP-адресов** и нажмите **Использовать мой IP** для автоматической подстановки диапазона IP-адресов вашей сети.

      </tabpanel>
      <tabpanel>

      Выберите **HTTPS** и укажите порт `443`, чтобы разрешить входящий трафик с любых IP-адресов на TCP-порт `443`.

      </tabpanel>
      <tabpanel>

      Выберите **SSH** и укажите порт `22`, чтобы разрешить входящий трафик с любых IP-адресов на TCP-порт `22`.

      </tabpanel>
      </tabs>

   1. Нажмите **Сохранить правило**.

1. Подключитесь к виртуальному шлюзу через веб-интерфейс GAiA Portal и завершите настройку шлюза с помощью мастера настройки First Time Configuration Wizard:

   1. Перейдите по адресу ```https://<внешний_IP_адрес>:443```, где `<внешний_IP_адрес>` — внешний IP-адрес шлюза, указанный в инструкции по настройке шлюза.
   1. Введите логин, полученный в инструкции по настройке шлюза, и пароль, установленный при [настройке](#setup_gateway).
   1. В появившемся окне в разделе **SIC** задайте пароль в поле **Activation Key**. Запишите этот пароль. Он понадобится при подключении шлюза к серверу управления.

Теперь вы можете подключаться к ВМ шлюза с помощью веб-интерфейса GAiA Portal по адресу `https://<внешний_IP_адрес>` (или по SSH `<внешний_IP_адрес>:22`).

## {heading(6. Настройте сетевой доступ к серверу управления)[id=configure_network_access_to_management]}

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **Виртуальные сети** → **Настройки firewall**.
1. Добавьте разрешающие правила для входящего трафика с IP-адресов вашей сети для группы безопасности, указанной в инструкции по настройке сервера управления:
   1. Нажмите на имя нужной группы безопасности.
   1. В блоке **Входящий трафик** нажмите **+ Добавить правило**.
   1. Выберите типа трафика и укажите порты:

      <tabs>
      <tablist>
      <tab>Все протоколы и все порты</tab>
      <tab>HTTPS</tab>
      <tab>SSH</tab>
      <tab>Другое</tab>
      </tablist>
      <tabpanel>

      Чтобы разрешить любой входящий трафик с IP-адресов вашей сети:

      1. В поле **Тип** выберите **Все протоколы и все порты**.
      1. В разделе **Удаленный адрес** выберите **Диапазон IP-адресов** и нажмите **Использовать мой IP** для автоматической подстановки диапазона IP-адресов вашей сети.

      </tabpanel>
      <tabpanel>

      Выберите **HTTPS** и укажите порт `443`, чтобы разрешить входящий трафик с любых IP-адресов на TCP-порт `443`.

      </tabpanel>
      <tabpanel>

      Выберите **SSH** и укажите порт `22`, чтобы разрешить входящий трафик с любых IP-адресов на TCP-порт `22`.

      </tabpanel>
      <tabpanel>

      Вы можете задать другие порты для подключения к серверу управления через приложение SmartConsole:

      1. В поле **Тип** выберите **Другое**.
      1. Укажите TCP-порты `19009`, `18210`, `18190`, `443`, чтобы разрешить входящий трафик с любых IP-адресов на эти порты.

      </tabpanel>
      </tabs>

   1. Нажмите **Сохранить правило**.

1. Подключитесь к серверу управления через веб-интерфейс GAiA Portal и завершите настройку с помощью мастера настройки First Time Configuration Wizard:

   1. Перейдите по адресу `https://<внешний_IP_адрес>:443`, где `<внешний_IP_адрес>` — внешний IP-адрес севера управления, указанный в инструкции по настройке сервера управления.
   1. Введите логин, полученный в инструкции по настройке сервера управления, и пароль, установленный при [настройке](#setup_management).
   1. В окне мастера настройки First Time Configuration Wizard нажмите **Next**.
   1. На шаге «Deployment Options» оставьте настройки без изменения и нажмите **Next**.
   1. На шаге «Management Connection» оставьте настройки без изменения и нажмите **Next**.
   1. На шаге «Device Information» оставьте настройки без изменения и нажмите **Next**.
   1. На шаге «Date and Time Settings» оставьте настройки без изменения и нажмите **Next**.
   1. На шаге «Installation Type» выберите **Security Gateway and/or Security Management**.
   1. На шаге «Products» выберите с помощью флажка только **Security Management**, чтобы настроить сервис **Check Point CloudGuard Network — Security Management BYOL** как сервер управления. При необходимости вы можете настроить сервис как шлюз и сервер управления одновременно. Подробнее об этом читайте в [официальной документации сервиса](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_Installation_and_Upgrade_Guide/Content/Topics-IUG/Installing-Standalone.htm).
   1. На шаге «Security Management Administrator» оставьте настройки без изменения и нажмите **Next**.
   1. На шаге «Security Management GUI Clients» оставьте настройки без изменения и нажмите **Next**.
   1. На шаге «First Time Configuration Wizard Summary» нажмите **Finish** и подтвердите перезагрузку системы.

Теперь вы можете подключаться к ВМ сервера управления с помощью веб-интерфейса GAiA Portal по адресу `https://<внешний_IP_адрес>` (или по SSH `<внешний_IP_адрес>:22`), где `<внешний IP-адрес>` — внешний IP-адрес севера управления, указанный в инструкции по настройке сервера управления.

## 7. Добавьте сетевые интерфейсы

По умолчанию для ВМ создается один сетевой интерфейс. Для добавления сетевого интерфейса к шлюзу:

1. [Перейдите](https://msk.cloud.vk.com/app/) в личный кабинет VK Cloud.
1. Перейдите в раздел **Облачные вычисления** → **Виртуальные машины**.
1. В списке виртуальных машин нажмите на имя ВМ, которая была создана в качестве шлюза.
1. Перейдите на вкладку **Сети**.
1. [Подключите](/ru/computing/iaas/service-management/vm/vm-add-net#podklyuchenie_seti_k_vm) нужную сеть к ВМ шлюза и [добавьте](/ru/networks/vnet/service-management/secgroups#dobavlenie_pravila) правила в группу безопасности для этой сети.

   <info>

   Сетевой интерфейс добавляется и удаляется в операционной системе GAiA без необходимости перезагрузки.

   </info>

1. [Настройте](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_Gaia_AdminGuide/Content/Topics-GAG/Physical-Interfaces.htm?tocpath=Network%20Management%7CNetwork%20Interfaces%7C_____1) сетевой интерфейс в ОС GAiA с использованием веб-интерфейса GAiA Portal или SSH.

## 8. Настройте политику безопасности

1. Установите приложение SmartConsole для управления сервисом Check Point CloudGuard Network по [ссылке](https://sc1.checkpoint.com/documents/Jumbo_HFA/R81.20_SC/R81.20/R81.20_Downloads.htm) или загрузив ее через веб-интерфейс GAiA Portal шлюза или сервера управления:

   1. Перейдите по адресу ```https://<внешний IP-адрес>```, где `<внешний IP-адрес>` — внешний IP-адрес шлюза или севера управления, указанный в инструкции по настройке.
   1. Выберите в меню слева **Maintenance** → **Download SmartConsole**.
   1. Нажмите **Download** для скачивания дистрибутива SmartConsole.
   1. Запустите установочный файл SmartConsole.
   1. Примите все предложения установщика и дождитесь окончания его работы.

1. [Подключитесь](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_SecurityManagement_AdminGuide/Content/Topics-SECMG/Connecting-to-Security-Management-Server-through-SmartConsole.htm?tocpath=_____7#Connecting_to_the_Security_Management_Server_through_SmartConsole) к серверу управления с помощью SmartConsole, указав логин и пароль, установленные для сервера управления, а также внешний IP-адрес сервера управления, указанный в инструкции по настройке.
1. [Подключите](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_SecurityManagement_AdminGuide/Content/Topics-SECMG/Creating-New-Security-Gateway.htm?tocpath=Managing%20Gateways%7C_____1) шлюз к серверу управления, указав:

   * **Name**: имя ВМ шлюза, заданное в параметре `hostname` во время [настройки шлюза](#setup_gateway).
   * **IPv4 Address**: внутренний IP-адрес шлюза, заданный в параметре `<внутренний_IP>` во время [настройки шлюза](#setup_gateway).

   На этапе подключения введите SIC-пароль, который вы указали во время [настройки сетевого доступа к шлюзу](#configure_network_access_to_gateway).

1. Включите нужные программные блейды для шлюза:

   1. Дважды нажмите на имя нужного шлюза в списке.
   1. В свойствах шлюза отметьте нужные настройки на вкладке **Network Security**.

1. [Создайте](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_SecurityManagement_AdminGuide/Content/Topics-SECMG/Introducing-the-unified-access-control-policy.htm?tocpath=Creating%20an%20Access%20Control%20Policy%7C_____1) политику Access Control Policy.
1. Настройте политику [Threat Prevention Policy](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_ThreatPrevention_AdminGuide/Content/Topics-TPG/The_Check_Point_Threat_Prevention_Solution.htm?TocPath=The%20Check%20Point%20Threat%20Prevention%20Solution%7C_____0#The_Check_Point_Threat_Prevention_Solution) в режиме  **Custom Threat Prevention** или **Autonomous Threat Prevention**, а также политики QoS Policy и HTTPS Inspection при необходимости.
1. [Установите](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_SecurityManagement_AdminGuide/Content/Topics-SECMG/Managing-Server-and-Gateway-Licenses.htm?tocpath=Managing%20Gateways%7CManaging%20%20Licenses%7C_____1) лицензии на шлюз и сервер управления.
1.  Установите политики [Access Control Policy](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_SecurityManagement_AdminGuide/Content/Topics-SECMG/Installing-the-Access-Control-Policy.htm?tocpath=Creating%20an%20Access%20Control%20Policy%7C_____10) и [Threat Prevention Policy](https://sc1.checkpoint.com/documents/R81.20/WebAdminGuides/EN/CP_R81.20_SecurityManagement_AdminGuide/Content/Topics-SECMG/Installing-Threat-Prevention-Policy.htm) на шлюз.

## 9. Предусмотрите резервное копирование

<warn>

Резервное копирование и восстановление инстансов сервиса Check Point CloudGuard Network средствами VK Cloud не поддерживается.

</warn>

Варианты резервного копирования описаны в [cтатье sk108902](https://support.checkpoint.com/results/sk/sk108902) и включают следующие встроенные процедуры резервного копирования GAiA:

* **System Backup** — выполняет резервное копирование конфигурации ОС GAiA и базы сервера управления и используется для периодического резервного копирования. Размер резервной копии:

  * десятки или сотни МБ для шлюзов;
  * сотни или тысячи МБ для сервера управления.

* **Snapshot** — создает снимок системных настроек и продуктов, таких как:

  * файловая система (root);
  * конфигурация системы (интерфейсы, маршрутизация, имя хоста и т.д.);
  * конфигурация программных блейдов;
  * база данных управления (на сервере управления).

  Размер снимка — несколько гигабайтов. Используется в основном перед обновлением операционной системы GAiA на новую версию или перед установкой программного пакета Jumbo Hotfix.

## Удалите неиспользуемые ресурсы

Работающая инфраструктура сервиса потребляет вычислительные ресурсы. Если она вам больше не нужна:

- [Удалите](/ru/applications-and-services/marketplace/service-management/pr-instance-manage#udalenie_instansa_servisa) инстанс сервиса Check Point CloudGuard Network.
- [Удалите](/ru/computing/iaas/service-management/vm/vm-manage#delete_vm) ВМ, созданные в качестве шлюза и сервера управления.
- Убедитесь, что вместе с ВМ были удалены все диски.
- [Удалите](/ru/networks/vnet/service-management/net#udalenie_seti) сеть, используемую для сервиса.
