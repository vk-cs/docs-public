Arenadata DB Monitoring — готовое решение для мониторинга баз данных Arenadata DB в инфраструктуре VK Cloud. Содержит набор предустановленных инструментов для сбора метрик, визуализации и своевременного оповещения о проблемах.

Пройдя все шаги этой инструкции, вы:

1. Подключите в личном кабинете VK Cloud сервис Arenadata DB Monitoring.

   При подключении автоматически будет создана виртуальная машина и на ней установлены:

   - [Grafana](https://grafana.com/docs/grafana/latest/) — сервис для визуализации и анализа данных мониторинга;
   - [Prometheus](https://prometheus.io/) — сервис мониторинга и оповещений;
   - ADB Exporter — сервис сбора метрик из Arenadata DB;
   - [Alertmanager](https://prometheus.io/docs/alerting/latest/alertmanager/) — обработчик оповещений, поступающих от Prometheus.

1. Подготовите базу данных Arenadata DB для работы с сервисом Arenadata DB Monitoring.
1. Настроите сервис ADB Exporter.
1. Установите и настроите Node Exporter — агент сбора метрик состояния операционной системы.
1. Установите и настроите cAdvisor — агент для сбора метрик контейнеров Docker.
1. Подключитесь к сервису Grafana и посмотрите дашборды с данными, поступающими из Prometheus.

## Подготовительные шаги

1. Создайте Telegram-чат, в который будут отправляться оповещения от сервиса Arenadata DB Monitoring, сохраните идентификатор чата.
1. Создайте Telegram-бот, который будет использоваться для отправки оповещений, сохраните токен бота.
1. [Зарегистрируйтесь](/ru/intro/start/account-registration) в VK Cloud, если это не сделано ранее.
1. [Создайте](/ru/dbs/adb/quick-start/create-adb) инстанс Arenadata DB. Сохраните данные, указанные при создании инстанса:

   - Имя кластера Arenadata DB. Оно же является именем инстанса.
   - Имя базы данных Arenadata DB.
   - Имя и пароль пользователя базы данных Arenadata DB.

   Эти данные понадобятся при подключении и настройке сервиса Arenadata DB Monitoring.

1. Перейдите в раздел **Аналитические БД** → **Инстансы АБД**.
1. Нажмите на имя нужного инстанса.
1. На вкладке **Информация** в строке **Connecting settings** найдите и сохраните данные:

   - IP-адрес узла Arenadata DB — значение аргумента `-h` в psql-команде.
   - Порт для подключения к Arenadata DB — значение аргумента `-p` в psql-команде.

   Эти данные понадобятся при подключении и настройке сервиса Arenadata DB Monitoring.

## 1. Подключите сервис Arenadata DB Monitoring

1. [Перейдите](https://msk.cloud.vk.com/app) в личный кабинет VK Cloud.
1. [Создайте](/ru/networks/vnet/instructions/net#sozdanie_seti) сеть с доступом в интернет, если она не была создана ранее.
1. В [настройках подсети](/ru/networks/vnet/instructions/net#redaktirovanie_podseti), где будет размещена ВМ инстанса Arenadata DB Monitoring, отключите опцию **Приватный DNS**.
1. Перейдите в раздел **Магазин приложений**, на странице раздела нажмите кнопку **Все решения**.
1. На карточке сервиса **Arenadata DB Monitoring** нажмите кнопку **Подробнее**.
1. На странице с описанием сервиса нажмите кнопку **Подключить**.
1. Введите данные на странице **Параметры сервера**.

   1. Укажите параметры виртуальной машины, на которой будет развернут инстанс сервиса:

      - **Зона доступности**: выберите [дата-центр](/ru/intro/start/concepts/architecture#az), где будет запущена ВМ.
      - **Тип виртуальной машины**: выберите предустановленную [конфигурацию ВМ](/ru/computing/iaas/concepts/vm/flavor).
      - **Сеть**: выберите сеть с доступом в интернет и подсеть, для которой отключена опция **Приватный DNS**.

   1. Укажите параметры системного диска и диска с данными:

      - **Размер диска**: укажите нужный размер диска ВМ в гигабайтах.
      - **Тип диска**: выберите [один из типов диска](/ru/computing/iaas/concepts/data-storage/disk-types#disk_types) — `HDD`, `SSD` или `High-IOPS SSD`.

1. Нажмите кнопку **Следующий шаг**.
1. Введите данные на странице **Параметры мониторинга**.

   1. Укажите ранее сохраненные данные для подключения к базе данных Arenadata DB:

      - имя кластера (инстанса) Arenadata DB, для которого будет выполняться мониторинг;
      - IP-адрес узла кластера Arenadata DB, к которому будет подключаться сервис Arenadata DB Monitoring;
      - порт для подключения к Arenadata DB;
      - логин и пароль пользователя базы данных Arenadata DB;
      - имя базы данных в кластере Arenadata DB.

   1. Задайте логин и пароль пользователя для входа в Grafana. Этот пользователь будет обладать правами администратора Grafana.
   1. Укажите ранее сохраненные параметры Telegram-бота для оповещений.

1. Нажмите кнопку **Следующий шаг**.
1. Ознакомьтесь с тарифными условиями и стоимостью инфраструктуры для развертывания сервиса и нажмите кнопку **Подключить тариф**.

   После успешного развертывания на зарегистрированную в VK Cloud почту придут сообщения:

   - уведомление со ссылкой на инстанс сервиса в личном кабинете VK Cloud;
   - письмо с одноразовой ссылкой.

1. Перейдите по одноразовой ссылке из письма и сохраните данные для доступа к сервису:

   - `grafanaUser` и `grafanaPassword` — логин и пароль администратора Grafana;
   - `productURL` — ссылка на веб-интерфейс Grafana;
   - `sshUser` — имя администратора ВМ инстанса Arenadata DB Monitoring;
   - `sshKey` — приватный ключ для подключения ĸ ВМ по SSH.

   {note:info}

   Если данные для доступа утрачены, [сгенерируйте](../../instructions/pr-instance-manage#update_access) новые.

   {/note}

## 2. Подключитесь к ВМ инстанса Arenadata DB Monitoring

1. [Перейдите](https://msk.cloud.vk.com/app) в личный кабинет VK Cloud.
1. Перейдите в раздел **Облачные вычисления** → **Виртуальные машины**.
1. Нажмите на имя ВМ, начинающееся с `adb-monitoring-`.
1. На странице ВМ скопируйте и сохраните внешний IP-адрес. Он понадобится для подключения к ВМ инстанса Arenadata DB Monitoring.
1. Создайте на вашем компьютере файл `vkc_monitoring.pem` и скопируйте в него полученный в письме SSH-ключ.
1. Установите доступ к файлу `vkc_monitoring.pem` так, чтобы только владелец имел права на чтение и запись. Для этого выполните команду:

   ```console

   chmod 600 vkc_monitoring.pem

   ```

1. Подключитесь к ВМ инстанса Arenadata DB Monitoring, выполнив команду:

   ```console

   ssh -i <ПУТЬ_К_КЛЮЧУ>/vkc_monitoring.pem <ЛОГИН>@<IP-АДРЕС_ВМ>

   ```

   Здесь:

   - `<ПУТЬ_К_КЛЮЧУ>` — путь к директории с файлом `vkc_monitoring.pem`.
   - `<ЛОГИН>` — имя администратора ВМ, полученное в письме (`sshUser`).
   - `<IP-АДРЕС_ВМ>` — сохраненный ранее внешний IP-адрес ВМ инстанса Arenadata DB Monitoring.

## 3. Подготовьте БД Arenadata DB для работы с Arenadata DB Monitoring

1. На ВМ инстанса Arenadata DB Monitoring подключитесь к БД Arenadata DB. Для этого выполните команду, подставив в нее ранее сохраненные данные:

   ```console

   psql -h <IP-АДРЕС_БД> -p <ПОРТ> -U <ЛОГИН> <ИМЯ_БД>

   ```

   Здесь:

   - `<IP-АДРЕС_БД>` — IP-адрес узла кластера Arenadata DB.
   - `<ПОРТ>` — порт для подключения к Arenadata DB.
   - `<ЛОГИН>` — логин пользователя базы данных Arenadata DB.
   - `<ИМЯ_БД>` — имя базы данных в кластере Arenadata DB.

1. Внутри терминала psql выполните скрипт инициализации базы данных:

   ```console

   \i /home/almalinux/init.sql

   ```
1. Создайте пользователя базы данных с именем `vkc_monitoring` и установите для него пароль `<ПАРОЛЬ>`:

   ```console

   CREATE USER vkc_monitoring WITH login password `<ПАРОЛЬ>` RESOURCE GROUP monitoring_group CONNECTION LIMIT 5;

   ```

1. Выйдите из терминала psql с помощью команды `\q`.

## 4. Настройте сервис ADB Exporter

Сервис ADB Exporter предназначен для экспорта метрик из баз данных Arenadata DB в Prometheus. Сервис формирует метрики на основе описаний в конфигурационном файле и автоматически обновляет их значения по заданному расписанию, выполняя SQL-запросы к базе данных.

ADB Exporter автоматически устанавливается и настраивается на ВМ инстанса при развертывании сервиса Arenadata DB Monitoring. Чтобы ADB Exporter получал метрики из вашей БД Arenadata DB, укажите в его конфигурационном файле параметры доступа к БД:

1. На ВМ инстанса Arenadata DB Monitoring откройте конфигурационный файл сервиса ADB Exporter:

   ```console

   sudo nano /etc/adb_exporter/config.yml

   ```

1. Добавьте в конфигурационный файл параметры подключения к базе данных Arenadata DB с помощью ранее созданного пользователя `vkc_monitoring`:

   ```txt

   datasource:
      dsn: "postgresql://vkc_monitoring:<ПАРОЛЬ>@<IP-АДРЕС_БД>:<ПОРТ>/<ИМЯ_БД>?sslmode=disable"

   ```
   Здесь:

   - `<ПАРОЛЬ>` — ранее заданный пароль пользователя `vkc_monitoring`.
   - `<IP-АДРЕС_БД>` — IP-адрес узла кластера Arenadata DB.
   - `<ПОРТ>` — порт для подключения к Arenadata DB.
   - `<ИМЯ_БД>` — имя базы данных в кластере Arenadata DB.

1. Перезапустите ADB Exporter:

   ```console

   sudo systemctl restart adb_exporter

   ```

1. Проверьте состояние ADB Exporter:

   ```console

   sudo systemctl status adb_exporter

   ```

   Если сервис успешно запущен и работает, ответ команды будет содержать строку:

   ```txt

   Active: active (running)

   ```

## 5. Установите и настройте агент Node Exporter

Агент Node Exporter собирает системные метрики серверов, включая использование процессора, памяти, дисков, файловых систем и сетевых интерфейсов. Без установки этого агента не будут работать некоторые дашборды Grafana и оповещения в Prometheus.

1. Установите агент Node Exporter на все узлы кластера Arenadata DB, как описано на [странице продукта в GitHub](https://github.com/prometheus/node_exporter/blob/master/README.md).
1. На ВМ инстанса Arenadata DB Monitoring откройте конфигурационный файл сервиса Prometheus:

   ```console

   sudo nano /opt/monitoring_data/prometheus/prometheus.yml

   ```

1. Добавьте в конфигурационный файл информацию об источниках метрик: IP-адреса узлов кластера (`targets`) и метки метрик (`labels`).

   Пример конфигурации Prometheus:

   ```yml

   - job_name: 'node_exporter'
     static_configs:
       - targets: ['localhost:9100']
         labels:
           instance: segment-1
           adb_cluster: staging

   ```
1. Перезапустите Prometheus.

   ```console

   sudo systemctl restart prometheus

   ```

1. Проверьте состояние Prometheus:

   ```console

   sudo systemctl status prometheus

   ```

   Если сервис успешно запущен и работает, ответ команды будет содержать строку:

   ```txt

   Active: active (running)

   ```

## 6. Установите и настройте агент cAdvisor

Агент cAdvisor собирает метрики работы контейнеров Docker, включая использование процессора, памяти, дискового ввода-вывода и сетевого трафика. Без установки этого агента не будут работать некоторые дашборды Grafana и оповещения в Prometheus.

1. Установите агент cAdvisor на все узлы кластера Arenadata DB, на которых запущены контейнеризованные приложения. Процедура установки описана на [странице продукта в GitHub](https://github.com/google/cadvisor/blob/master/README.md).
1. На ВМ инстанса Arenadata DB Monitoring откройте конфигурационный файл сервиса Prometheus:

   ```console

   sudo nano /opt/monitoring_data/prometheus/prometheus.yml

   ```

1. Добавьте в конфигурационный файл информацию об источниках метрик: IP-адреса узлов кластера (`targets`) и метки метрик (`labels`).

   Пример конфигурации Prometheus:

   ```yml

   - job_name: 'docker_exporter'
     metrics_path: /metrics
     static_configs:
       - targets: ['localhost:8080']
         labels:
           instance: adcc-node-1
           environment: staging

   ```
1. Перезапустите Prometheus.

   ```console

   sudo systemctl restart prometheus

   ```

1. Проверьте состояние Prometheus:

   ```console

   sudo systemctl status prometheus

   ```

   Если сервис успешно запущен и работает, ответ команды будет содержать строку:

   ```txt

   Active: active (running)

   ```

## 7. Подключитесь к веб-интерфейсу Grafana

1. Перейдите по сохраненной ранее ссылке `productURL` из письма. Откроется веб-интерфейс Grafana.
1. Авторизуйтесь с помощью логина и пароля администратора Grafana, полученных в письме (`grafanaUser` и `grafanaPassword`).
1. Просмотрите содержимое дашбордов с отображением метрик, собранных Prometheus.

   {note:info}

   Менять пароль при первом входе необязательно.

   {/note}
