В этой статье мы расскажем, как настроить ваш первый экспортер для экспорта данных в S3 совместимое хранилище. В качестве S3 совместимого хранилища мы будем использовать S3 хранилище в облаке VK CS, а источника данных для экспорта – эмулятор.

Для экспорта потока данных в объектное хранилище необходимо:

1. Настроить доступ в объектное хранилище.
2. Создать экспортер.
3. Создать правило.
4. Назначить правило на эмулятор.

## Настройка доступа в объектное хранилище

Чтобы настроить доступ в объектное хранилище выполните следующие шаги:

1. В личном кабинете VK CS перейдите в раздел «Объектное хранилище».
2. Создайте новый приватный бакет с названием `s3_exporter`.
3. Создайте новый аккаунт и запомните выданные Access Key ID и Secret Key.

## Создание экспортера в IoT

1. Перейдите на страницу «Экспортеры».
2. Нажмите на кнопку «Добавить экспортер».
3. Укажите в полях формы следующие значения:
    - Идентификатор: s3
    - Название: s3
    - Описание: S3 экспортер
    - Тип экспортера: s3

4. Кликните «Следующий шаг».
5. Укажите в полях формы следующие значения:

    - CONNECTION_URL_STRING: hb.bizmrg.com
    - BUCKET: s3_exporter
    - REGION: ru-msk
    - SSL: 1
    - ACCESS_KEY_ID: ранее полученный Access Key ID
    - SECRET_ACCESS_KEY: ранее полученный Secret Key
    - MAX_BULK_INSERT_SIZE: 100
    - PERIOD_BETWEEN_RETRIES: 5s
    - FORMAT: jsonl
    - BULK_INSERT_TIMEOUT: 1m

6. Нажмите «Сохранить».

## Создание правил в IoT

1. Перейдите на страницу «Правила».
2. Нажмите «Добавить правило».
3. Укажите в полях формы следующие значения:

    - Название: Экспорт в S3
    - Идентификатор: export_s3
    - Тип правила: реактивное
    - Правило активно: Да

4. Кликните по кнопке «Следующий шаг».
5. В теле правила заполните следующий код:

```python
from coiiot_sdk import exporters, context, user_logs

logger = user_logs.get_logger()
exporter = exporters.get_by_name("s3")
ctx = context.current()

logger.info("sending event into s3 storage")
try:
    exporter.send({
        "tag": ctx.tag.full_name,
        "value": ctx.msg.value,
        "timestamp": ctx.msg.timestamp,
    })
except Exception as e:
    logger.error("failed to send event into s3 storage")
else:
    logger.info("successfully sent event into s3 storage")
```

6. Нажмите «Добавить».

## Назначение правила на эмулятор

1. Перейдите на страницу «Устройства».
2. Выберите эмулятор из списка.
3. Перейдите на вкладку «Общая структура».
4. У датчика температуры выберите «Редактировать».
5. В поле «Правила потоковой обработки» добавьте правило _export_s3_.
6. Кликните «Сохранить».

Теперь при каждом измерении температуры от эмулятора будет срабатывать правило, которое будет экспортировать данные в объектное хранилище. На странице «Логирование» → «Логи правила» можно посмотреть, как выполняется правило.

При включенном эмуляторе файлы в S3 бакете должны появиться через несколько минут.
