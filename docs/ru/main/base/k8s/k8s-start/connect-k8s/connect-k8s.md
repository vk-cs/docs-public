## Описание

Подключение к кластеру происходит с помощью утилиты `kubectl`.

Инструмент командной строки Kubernetes `kubectl` позволяет запускать команды в кластерах Kubernetes.

`kubectl` можно использовать для развертывания приложений, проверки и управления ресурсами кластера, а также для просмотра логов.

Полный список операций, которые можно выполнить с помощью `kubectl`, доступен в [официальной документации](https://kubernetes.io/docs/reference/kubectl/overview/).

<warn>

При использовании версий kubectl v1.23 и выше, вам необходимо ввести пароль при подключении. Чтобы воспользоваться автоматическим вводом пароля, его можно указать в файле настройки подключения kubeconfig.

</warn>

## Подключение к кластеру

Чтобы подключиться к кластеру с помощью `kubectl`:

<tabs>
<tablist>
<tab>Kubernetes v1.22 и ниже</tab>
<tab>Kubernetes v1.23+</tab>
</tablist>
<tabpanel>

1. [Установите](../../k8s-clusters/kubectl/kubectl.md) `kubectl`, если он еще не установлен.

   <warn>

   Убедитесь, что мажорная версия установленного `kubectl` не отличается от той, которая используется в кластере. Например, версия v1.19 может работать с версиями v1.16 и v1.15. Использование последней версии `kubectl` поможет избежать непредвиденных проблем при подключении.

   </warn>

1. Если версия кластера Kubernetes больше или равна v1.23, вам необходимо установить client-keystone-auth по [инструкции](../../k8s-clusters/client-keystone-auth/client-keystone-auth.md).

1. Добавьте необходимую роль (Администратор/Оператор/Аудитор Kubernetes) пользователю в разделе «Управление доступами» в Личном кабинете. Обновление ролей и прав происходит с небольшой задержкой. Подробности вы можете узнать в статье [Управление доступом](https://mcs.mail.ru/docs/base/k8s/k8s-concepts/k8s-sso).

1. Загрузите на локальный компьютер файл конфигурации кластера, к которому необходимо подключиться:

   1. Перейдите в раздел «Контейнеры» Панели VK Cloud.
   1. Выберите в контекстном меню требуемого кластера пункт «Получить Kubeconfig для доступа к кластеру».

   Такой файл автоматически создается для каждого нового кластера и имеет имя в формате `<имя кластера>_kubeconfig.yaml`.

   <info>

   В дальнейших шагах предполагается, что загруженный файл имеет имя `kubernetes-cluster-1234_kubeconfig.yaml` и находится в директории `~/Downloads`. Скорректируйте приведенные ниже команды при необходимости.

   </info>

1. Импортируйте загруженный файл конфигурации, чтобы `kubectl` мог найти кластер Kubernetes и получить к нему доступ:

   <tabs>
   <tablist>
   <tab>Linux, macOS (bash)</tab>
   <tab>Windows (PowerShell)</tab>
   </tablist>
   <tabpanel>

   1. Перейдите в директорию `.kube/`, которая находится в вашей домашней директории:

      ```bash
      cd ~/.kube
      ```

   1. Если такой директории не существует — создайте ее и назначьте минимально необходимые права:

      ```bash
      mkdir ~/.kube && \
      chmod -R 0600 ~/.kube && \
      cd ~/.kube
      ```

   1. Поместите файл конфигурации в директорию `~/.kube` под именем `config`:

      ```bash
      mv ~/Downloads/kubernetes-cluster-1234_kubeconfig.yaml ~/.kube/config
      ```

   1. Укажите `kubectl` использовать этот файл конфигурации, задав переменную среды окружения:

      ```bash
      export KUBECONFIG=$KUBECONFIG:$HOME/.kube/config
      ```

   </tabpanel>
   <tabpanel>

   1. Перейдите в директорию `.kube/`, которая находится в вашей домашней директории:

      ```powershell
      cd ~/.kube
      ```

   1. Если такой директории не существует — создайте ее:

      ```powershell
      mkdir ~/.kube; `
      cd ~/.kube
      ```

   1. Поместите файл конфигурации в директорию `~/.kube` под именем `config`:

      ```powershell
      mv ~/Downloads/kubernetes-cluster-1234_kubeconfig.yaml ./config
      ```

   1. Укажите `kubectl` использовать этот файл конфигурации, задав переменную среды окружения:

      ```powershell
      $Env:KUBECONFIG="$Env:KUBECONFIG;$HOME\.kube\config"
      ```

   </tabpanel>
   </tabs>

1. Выполните тестовое подключение к кластеру:

   ```bash
   kubectl cluster-info
   ```

   Могут быть выведены:

   - Краткая информация о том, что control plane кластера и CoreDNS функционируют, например:

     ```text
     Kubernetes control plane is running at https://NNN.NNN.NNN.NNN:6443
     CoreDNS is running at https://NNN.NNN.NNN.NNN:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

     ```

     Это означает, что `kubectl` правильно сконфигурирован и успешно подключился к кластеру.
     Теперь можно использовать `kubectl` для управления вашим кластером.

   - Иные сообщения, которые могут указывать на проблемы с подключением, например:

     ```text
     The connection to the server NNN.NNN.NNN.NNN:6443 was refused - did you specify the right host or port?
     ```

     ```text
     Unable to connect to the server: EOF
     ```

1. При проблемах с подключением:

   1. Проверьте, что:

      1. Кластер включен и работает.
      1. `kubectl` настроен корректно.

   1. Соберите вывод следующих команд:

      ```bash
      kubectl config view
      ```

      ```bash
      kubectl cluster-info dump
      ```

   1. Передайте собранную информацию в службу технической поддержки VK Cloud для диагностики и устранения проблемы.
