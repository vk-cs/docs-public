Постоянный том ([persistent volume](https://kubernetes.io/docs/concepts/storage/persistent-volumes/), PV) предоставляет возможности для длительного хранения данных в кластерах Kubernetes. Данные, хранящиеся на PV, не теряются при сбое отдельного контейнера или пода целиком.

В рабочих нагрузках ([workloads](https://kubernetes.io/docs/concepts/workloads/)) нельзя использовать PV напрямую. Необходимо дополнительно создать [Persistent Volume Claim](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#introduction) (PVC), который позволяет запросить постоянный том с нужными параметрами и затем использовать его в рабочих нагрузках. Самые распространенные параметры, которые можно указать в PVC:

- Объем хранилища (`spec.resources.requests.storage`).
- Режим доступа (`spec.accessModes`) к тому.

  Kubernetes поддерживает следующие режимы доступа к тому:

  - `ReadWriteOnce` (RWO): том может быть примонтирован в режиме «чтение и запись» одним узлом (node) кластера. Такой том может использоваться несколькими подами сразу, если все они размещены на одном узле, к которому примонтирован этот том.

  - `ReadOnlyMany` (ROX): том может быть примонтирован в режиме «только чтение» несколькими узлами кластера.
  - `ReadWriteMany` (RWX): том может быть примонтирован в режиме «чтение и запись» несколькими узлами кластера.

  С помощью PVC можно запросить PV, который способен работать сразу в нескольких режимах, но при монтировании такого PV придется выбрать один из режимов. Например, если с помощью PVC запрошен PV с режимами RWO и RWX, будет доступно одно из действий:

  - либо примонтировать этот PV в режиме RWO одним узлом кластера;
  - либо примонтировать этот PV в режиме RWX несколькими узлами кластера;

## Жизненный цикл PV и PVC

Жизненный цикл PV и PVC не зависит от жизненного цикла подов и [состоит](https://kubernetes.io/docs/concepts/storage/persistent-volumes/#lifecycle-of-a-volume-and-claim) из четырех последовательных этапов:

1. Подготовка (provisioning).
1. Связывание (binding).
1. Использование (using).
1. Освобождение (reclaiming).

### 1. Подготовка

Чтобы PV можно было запросить с помощью PVC, его нужно заранее подготовить одним из способов:

- Статическая подготовка (static provisioning): PV создается вручную, например, администратором Kubernetes.
- Динамическая подготовка (dynamic provisioning): PV создается автоматически после создания PVC.

Для динамической подготовки необходимо выполнение двух условий:

- В кластере Kubernetes должны быть настроены классы хранения (storage classes). Кластеры Kubernetes VK Cloud уже содержат [преднастроенные классы хранения](../../concepts/storage#prednastroennye_klassy_hraneniya).

- Для PVC не должно быть найдено подходящих PV, которые уже существуют.

В ходе динамической подготовки Kubernetes попытается создать PV, соотвествующий параметрам PVC. Будет использован один из классов хранения:

- класс хранения, явно заданный в PVC;
- класс хранения по умолчанию, если класс не задан в PVC явно.

В кластерах Kubernetes VK Cloud класс хранения по умолчанию [не настроен](../../concepts/storage#prednastroennye_klassy_hraneniya). Если вы не планируете явно задавать класс хранения в PVC, то перед созданием PVC [выберите вручную класс хранения по умолчанию](https://kubernetes.io/docs/tasks/administer-cluster/change-default-storage-class/).

### 2. Связывание

Для использования в рабочих нагрузках PV и PVC связываются по принципу «один к одному». Уже связанный PV нельзя использовать с другими PVC.

Когда в кластере Kubernetes появляется новый PVC:

1. Kubernetes пытается найти подходящий PV, который доступен для связывания (статус PV: `Available`) и максимально точно отвечает параметрам, заданным в PVC.

   Если нет доступных PV, которые в точности соответствуют заданным в PVC параметрам, может быть выбран PV с избыточными характеристиками. Следите за доступными PV и создаваемыми PVC, чтобы не допустить ситуации, когда все PV большого объема связаны с PVC, которые запрашивают небольшие объемы хранилища. Место на таких PV будет расходоваться нерационально и они не будут доступны для связывания, когда в кластере появятся PVC, требующие большого объема хранилища.

   <details>
   <summary>Пример выбора PV</summary>

   Например, пусть в кластере существуют:

   - PVC, который запрашивает хранилище объемом 10Gi в режиме ROX;
   - Первый PV объемом 100Gi с режимами ROX, RWX;
   - Второй PV объемом 5Gi с режимом ROX;
   - Третий PV объемом 100Gi с режимами RWO, ROX, RWX.

   В этом случае PVC будет связан с первым PV, несмотря на то, что:

   - объем PV превышает запрошенный и PV поддерживает больше режимов, чем указано в PVC;
   - существует третий PV с таким же объемом, как у первого PV, но с более широким набором режимов доступа.

   </details>

1. Kubernetes выполняет одно из действий:

   - Если подходящий PV был найден, Kubernetes связывает его с PVC.
   - Если подходящий PV не был найден, то Kubernetes сначала пытается выполнить динамическую подготовку тома, а затем связать созданный PV с PVC.

1. PVC, с которым не удалось связать ни один PV, находится в состоянии `Unbound`. Рабочие нагрузки не могут работать с таким PVC в качестве тома. Kubernetes будет периодически пытаться связать такой PVC с новыми PV, если они появятся в кластере.

### 3. Использование

После того, как Kubernetes связал PVC с PV, этот PVC может использоваться рабочей нагрузкой как обычный том.

### 4. Освобождение

Когда PVC больше не нужен и удаляется, то к PV, связанному с этим PVC, применяется заданная политика освобождения (reclaim policy).

Политика задается одним из способов:

- при создании постоянного тома вручную;
- при установке класса хранения по умолчанию или установке класса хранения в PVC.

Доступные политики:

- Оставить том (`Retain`).

  Используйте эту политику для PV с важными данными, чтобы защитить данные при случайном удалении PVC. При необходимости можно вручную очистить и удалить такие тома вручную.

- Удалить том (`Delete`).

  В зависимости от выбранного типа PV также может быть удалено связанное с PV нижележащее хранилище.

  <warn>

  Используйте эту политику и реализующие ее классы хранения с осторожностью: возможна потеря данных.
  В VK Cloud, благодаря [интеграции с Cinder CSI](../../concepts/storage#rabota_s_container_storage_interface_csi), при удалении PV также будет удален связанный облачный диск VK Cloud.

  </warn>

В кластерах Kubernetes VK Cloud выбранный тип хранилища влияет на [доступные политики освобождения](../../concepts/storage#dostupnye_politiki_osvobozhdeniya_postoyannyh_tomov).

## Смотрите также

- [Как устроено хранилище в Kubernetes VK Cloud](../../concepts/storage).
- [Список преднастроенных классов хранения](../../concepts/storage#prednastroennye_klassy_hraneniya).
- [Сценарий использования](../../use-cases/storage), демонстрирующий использование различных PVC.
- [Официальную документацию Kubernetes](https://kubernetes.io/docs/concepts/storage/persistent-volumes) с более подробной информацией про PVC и PV.
