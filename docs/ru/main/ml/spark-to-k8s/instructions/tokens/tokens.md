Для работы с кластерами Spark используются токены доступа (также известны как refresh-токены). Регистрационные токены (также известны как register-токены) используются для создания токенов доступа с помощью библиотеки Cloud ML Platform. Далее описывается, как работать с токенами обоих типов.

## Подготовительные шаги

Если вы планируете работать с токенами с помощью библиотеки Cloud ML Platform, выполните приведенные ниже действия.

<details>
<summary>Подготовка окружения для Python и установка библиотеки Cloud ML Platform</summary>

1. Подготовьте окружение для работы с Python любым удобным для вас способом:

   <tabs>
   <tablist>
   <tab>С помощью VK Cloud</tab>
   <tab>Самостоятельно</tab>
   </tablist>
   <tabpanel>

   [Создайте инстанс JupyterHub](/ru/ml/mlplatform/jupyterhub/start/create) на платформе VK Cloud. Он уже содержит в себе настроенные Python 3.x и pip, с которыми можно работать из блокнота JupyterHub (notebook).

   </tabpanel>
   <tabpanel>

   1. Установите Python 3.x и pip.
   1. При необходимости настройте виртуальное окружение (virtual environment) для Python.

   Например, можно воспользоваться [conda](https://conda.io/projects/conda/en/latest/index.html) или выполнить установку и настройку вручную.

   </tabpanel>
   </tabs>

1. Установите библиотеку Cloud ML Platform для Python:

   1. Загрузите [файл с библиотекой](https://mlplatform.hb.ru-msk.vkcs.cloud/mlplatform_client.tar.gz).

      По приведенной ссылке всегда доступна самая актуальная версия библиотеки.

   1. Установите пакеты из загруженного файла:

      <tabs>
      <tablist>
      <tab>Блокнот JupyterHub</tab>
      <tab>pip</tab>
      </tablist>
      <tabpanel>

      ```bash
      %pip install mlplatform_client.tar.gz
      ```

      </tabpanel>
      <tabpanel>

      ```bash
      pip install mlplatform_client.tar.gz
      ```

      </tabpanel>
      </tabs>

</details>

## Получение списка токенов доступа

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://mcs.mail.ru/app/) в личный кабинет VK Cloud.
1. Выберите проект, в котором находятся токены.
1. Перейдите в раздел **ML Platform → Токены**.

Будет выведен список токенов доступа.

</tabpanel>
</tabs>

## Создание токена доступа

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>Библиотека Cloud ML Platform</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://mcs.mail.ru/app/) в личный кабинет VK Cloud.
1. Выберите проект, в котором нужно создать токен.
1. Перейдите в раздел **ML Platform → Токены**.
1. Нажмите кнопку **Создать токен доступа**.
1. В открывшемся окне укажите параметры токена:

   - **Название**: может быть любым.
   - **Роль**: одна из ролей токена.

     - `Пользователь`. Эта роль дает право выполнять операции, требующие авторизации при работе с библиотекой Cloud ML Platform (например, отправить задание на кластер Spark).
     - `Администратор`. Эта роль дает те же права, что и роль `Пользователь`, а также дополнительно дает права на работу с токенами.

1. Нажмите кнопку **Создать**.
1. В открывшемся окне скопируйте значение токена и сохраните его на своем устройстве.

   <err>

   После закрытия окна восстановить значение токена будет невозможно. Если оно утеряно, создайте новый токен.

   </err>

1. Нажмите кнопку **Готово**.

</tabpanel>
<tabpanel>

<warn>

Для упрощения изложения значение регистрационного токена содержится непосредственно в примере скрипта Python, а значение токена доступа выводится с помощью `print()`.

Значения этих токенов — чувствительная информация. Примите необходимые меры предосторожности при работе с ними, чтобы избежать утечек.

</warn>

1. Попросите владельца токена доступа с ролью `Администратор` [создать для вас регистрационный токен](#sozdanie_registracionnogo_tokena).

1. Создайте новый токен доступа с помощью регистрационного токена, выполнив скрипт Python:

   ```python
   from mlplatform_client import MLPlatform
 
   REGISTER_TOKEN = "<значение регистрационного токена>"

   mlp = MLPlatform()
   refresh_token = mlp.create_refresh_token(REGISTER_TOKEN)
 
   print(refresh_token)
   ```

   Параметры токена доступа (например, его имя, роль и время жизни) определяются регистрационным токеном.

   После выполнения этого скрипта будет выведено значение созданного токена доступа.

1. Cкопируйте значение токена и сохраните его на своем устройстве.

<info>

Созданный таким образом токен доступа отображается в личном кабинете.

</info>

</tabpanel>
</tabs>

## Создание регистрационного токена

<tabs>
<tablist>
<tab>Библиотека Cloud ML Platform</tab>
</tablist>
<tabpanel>

<warn>

Для упрощения изложения значение токена доступа содержится непосредственно в примере скрипта Python, а значение регистрационного токена выводится с помощью `print()`.

Значения этих токенов — чувствительная информация. Примите необходимые меры предосторожности при работе с ними, чтобы избежать утечек.

</warn>

1. [Создайте токен доступа](#sozdanie_tokena_dostupa) с ролью `Администратор`, если у вас его еще нет.

1. Создайте регистрационный токен, выполнив скрипт Python:

   ```python
   from mlplatform_client import MLPlatform
   from mlplatform_client.serializers.auth import MLPTokenType
    
   ADMIN_REFRESH_TOKEN = "<значение токена доступа с ролью Администратор>"
    
   mlp = MLPlatform(ADMIN_REFRESH_TOKEN)

   register_token = mlp.create_register_token(
       client_name="<имя токена доступа>",
       access_ttl="<время жизни регистрационного токена>",
       refresh_ttl="<время жизни токена доступа>",
       token_type=<роль токена доступа>)

   print(register_token)
   ```

   Где:

   - `client_name`: имя токена доступа, который будет создан с помощью этого регистрационного токена.
   - `access_ttl`: время жизни регистрационного токена (в формате `2h45m30s`). Регистрационный токен с истекшим сроком жизни не получится использовать для создания токена доступа.
   - `refresh_ttl`: время жизни токена доступа (в формате `2h`). Если не указывать этот параметр, то токен доступа будет действовать бессрочно.
   - `token_type`: роль токена доступа:

     - Значение `MLPTokenType.USER` соответствует роли `Пользователь`. Эта роль дает право выполнять операции, требующие авторизации при работе с библиотекой Cloud ML Platform (например, отправить задание на кластер Spark).
     - Значение `MLPTokenType.ADMIN` соответствует роли `Администратор`. Эта роль дает те же права, что и роль `Пользователь`, а также дополнительно дает права на работу с токенами.

   После выполнения этого скрипта будет выведено значение созданного регистрационного токена доступа.

1. Предоставьте этот регистрационный токен другому пользователю, чтобы он мог использовать этот токен для создания токена доступа с заданными параметрами.

</tabpanel>
</tabs>

## Удаление токена доступа

<tabs>
<tablist>
<tab>Личный кабинет</tab>
<tab>Библиотека Cloud ML Platform</tab>
</tablist>
<tabpanel>

1. [Перейдите](https://mcs.mail.ru/app/) в личный кабинет VK Cloud.
1. Выберите проект, где находится нужный токен.
1. Перейдите в раздел **ML Platform → Токены**.
1. Раскройте меню нужного токена и выберите пункт **Удалить**.
1. Нажмите кнопку **Подтвердить**.

</tabpanel>
<tabpanel>

<warn>

Для упрощения изложения значения токенов доступа содержатся непосредственно в примере скрипта Python.

Значения этих токенов — чувствительная информация. Примите необходимые меры предосторожности при работе с ними, чтобы избежать утечек.

</warn>

1. [Создайте токен доступа](#sozdanie_tokena_dostupa) с ролью `Администратор`, если у вас его еще нет.

1. [Получите список токенов доступа](#poluchenie_spiska_tokenov_dostupa) и определите имя токена, который нужно удалить.

1. Удалите токен доступа, выполнив скрипт Python:

   ```python
   from mlplatform_client import MLPlatform

   ADMIN_REFRESH_TOKEN = "<значение токена доступа с ролью Администратор>"
   REFRESH_TOKEN_NAME = "<имя токена доступа, который нужно удалить>"

   mlp = MLPlatform(ADMIN_REFRESH_TOKEN)
   mlp.delete_token(token_name=REFRESH_TOKEN_NAME)

   print("Token", REFRESH_TOKEN_NAME, "was deleted.")
   ```

   После выполнения этого скрипта будет выведено сообщение об удалении токена доступа.

</tabpanel>
</tabs>
