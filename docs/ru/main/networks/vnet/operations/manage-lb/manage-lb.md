Вы можете управлять балансировщиками нагрузки: просматривать, редактировать и удалять их, добавлять и изменять правила балансировки, манипулировать публичными IP-адресами.

## Просмотр списка балансировщиков нагрузки и информации о них

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. Перейдите в [личный кабинет](https://mcs.mail.ru/app/) VK Cloud.
1. Выберите проект и регион.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.

   Будет отображен список балансировщиков.

1. Нажмите на имя нужного балансировщика.

   Откроется страница с подробной информацией о нем. На этой странице можно также [редактировать](#redaktirovanie-balansirovshchika-nagruzki) параметры балансировщика.

</tabpanel>
</tabs>

## Добавление балансировщика нагрузки

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. Перейдите в [личный кабинет](https://mcs.mail.ru/app/) VK Cloud.
1. Выберите проект и регион.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Нажмите кнопку **Добавить балансировщик** или **Добавить**.
1. Задайте параметры балансировщика:

   - **Название балансировщика**.
   - **Сеть**: сеть и подсеть, в которой будет размещаться балансировщик.

     Балансировщик будет распределять входящий трафик на выбранные сервисы, которые размещены в этой подсети.

     <warn>

     Изменить этот параметр позднее невозможно.

     </warn>

   - **DNS-имя**: (опционально) DNS-имя для балансировщика.
   - **Назначить внешний IP**: если эта опция выбрана, то балансировщику будет назначен публичный IP-адрес, через который он будет доступен из интернета. В противном случае балансировщик будет выступать в качестве внутреннего балансировщика нагрузки. Такой IP-адрес можно [назначить позднее](#upravlenie-publichnymi-ip-adresami).

     Выберите эту опцию, если планируется размещать за балансировщиком сервисы, которые должны быть доступны из интернета.
     Опцию можно выбрать только при условии, что сеть, выбранная ранее, находится за маршрутизатором, который имеет доступ в интернет.

1. Задайте правила балансировки.
1. Нажмите кнопку **Добавить балансировщик**.

</tabpanel>
</tabs>

## Редактирование имени балансировщика нагрузки

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. Перейдите в [личный кабинет](https://mcs.mail.ru/app/) VK Cloud.
1. Выберите проект и регион.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Выполните одно из действий для балансировщика, который нужно отредактировать:

   - Нажмите на имя балансировщика.
   - Раскройте меню балансировщика и выберите пункт **Редактировать**.

   Откроется страница с подробной информацией о балансировщике.

1. Чтобы изменить имя:

   1. Нажмите на значок карандаша рядом с текущим именем балансирощика.
   1. Задайте новое имя.
   1. Нажмите кнопку **Переименовать**.

</tabpanel>
</tabs>

## Управление публичными IP-адресами

### Назначить публичный IP-адрес

Если сеть балансировщика подключена к маршрутизатору с доступом в интернет, то можно назначить балансировщику публичный (внешний) IP-адрес.

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. Перейдите в [личный кабинет](https://mcs.mail.ru/app/) VK Cloud.
1. Выберите проект и регион.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Выполните одно из действий:

   - Нажмите на имя нужного балансировщика.

     На странице с подробной информацией о балансировщике нажмите ссылку **Назначить** в блоке **IP-адреса** → **Внешний**.

   - Раскройте меню нужного балансировщика и выберите пункт **Назначить внешний IP**.

1. Выберите нужный публичный IP-адрес из списка либо создайте новый.
1. Нажмите кнопку **Подтвердить**.

</tabpanel>
</tabs>

### Отвязать публичный IP-адрес

Если сеть балансировщика подключена к маршрутизатору с доступом в интернет, и балансировщику назначен публичный (внешний) IP-адрес, то этот адрес можно отвязать.

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. Перейдите в [личный кабинет](https://mcs.mail.ru/app/) VK Cloud.
1. Выберите проект и регион.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Выполните одно из действий:

   - Нажмите на имя нужного балансировщика.

     На странице с подробной информацией о балансировщике нажмите символ **x** рядом с IP-адресом в секции **IP-адреса** → **Внешний**.

   - Раскройте меню нужного балансировщика и выберите пункт **Отвязать внешний IP**.

1. Нажмите кнопку **Подтвердить**.

</tabpanel>
</tabs>

## Управление правилами балансировки

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

1. [Перейдите](#prosmotr-spiska-balansirovshchikov-nagruzki-i-informacii-o-nih) на страницу балансировщика для его редактирования.
1. В секции **Правила балансировки** выполните одно из доступных действий:

   1. Добавьте правило балансировки.
   1. Отредактируйте существующее правило балансировки, нажав на значок карандаша рядом с правилом.
   1. Удалите существующее правило балансировки, нажав на значок корзины рядом с правилом.

При добавлении или редактировании правила доступны следующие параметры:

1. Параметры правила:

   - **Протоколы и порты** (только при создании правила):

     - Протокол балансировки и порт, который будет использоваться балансировщиком.
     - Протокол и порт назначения.

     При выборе протокола балансировки `TCP` доступны два протокола назначения: `TCP` или `PROXY`. Proxy-протокол можно использовать, если он поддерживается серверами, которые находятся за балансировщиком.

   - **Метод балансировки**:

     - `LEAST_CONNECTIONS`: использовать бэкенд, к которому установлено наименьшее число соединений.
     - `ROUND_ROBIN`: перебирать последовательно все бэкенды.
     - `SOURCE_IP`: закреплять бэкенд для обработки трафика за конкретным IP-адресом клиента.

   - **Разрешенные CIDR**: IP-адреса или адреса подсетей, с которых разрешены подключения к балансировщику. Этот параметр может использоваться для ограничения доступа к балансировщику только с доверенных адресов.

     Если параметр не задан, то разрешено подключение с любых IP-адресов (что эквивалентно CIDR `0.0.0.0/0`).

   - **Timeout параметры**:

     - `Client data`: таймаут неактивности клиента.
     - `Member connect`: таймаут установки соединения с бэкендом.
     - `Member data`: таймаут неактивности бэкенда.
     - `TCP inspect`: таймаут ожидания дополнительных TCP-сегментов при инспекции контента.

     Значения таймаутов задаются в миллисекундах. Минимальное значение — `0`, максимальное — `2073600000` (576 часов).

   - **Отправлять заголовок X-Forwarded-For** (только для протоколов балансировки HTTP и HTTPS): опция, позволяющая включить отправку на бэкенд соответствующего HTTP-заголовка. По умолчанию опция выключена.

   - **Применить для следующих инстансов**: инструменты для выбора инстансов виртуальных машин, которые будут выступать бэкендами для балансировщика. Можно добавить инстанс либо выбрав его из списка, либо выбрав тег, назначенный инстансу.

     <info>

     Группы безопасности для выбранных виртуальных машин должны быть настроены так, чтобы разрешать трафик на порт и протокол назначения.

     </info>

   - **Сертификат** (только для протокола балансировки HTTPS): сертификат, который будет использоваться балансировщиком для терминирования SSL-соединения.

     Можно выбрать уже существующий сертификат или загрузить новый.

     При загрузке нового сертификата указываются:

     - **Название сертификата**.
     - **Сертификат или цепочка сертификатов**: публичный сертификат или цепочка сертификатов. Можно вставить в поле в текстовом виде или загрузить из файла.
     - **Приватный ключ**: приватный сертификат. Можно вставить в поле в текстовом виде или загрузить из файла.
     - **Пароль**: пароль от приватного сертификата (если используется). Можно вставить в поле в текстовом виде или загрузить из файла.

1. Параметры проверки доступности бэкендов (healthcheck):

   - **Тип проверки**: TCP или HTTP.
   - **Интервал**: интервал проверки в секундах.
   - **Кол-во попыток**: сколько раз попытаться провести проверку, прежде чем признавать бэкенд недоступным.
   - **Таймаут**: таймаут в секундах, после истечения которого считается, что бэкенд не отвечает на проверку.

   Следующие параметры доступны только для типа проверки `HTTP`:

   - **HTTP-метод**: метод, который надо использовать для проверки доступности.
   - **Статус ответа**: [HTTP-статус](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status), при получении которого проверка доступности будет считаться успешной.
   - **Путь запроса**: путь, по которому надо обратиться для проверки доступности.

</tabpanel>
</tabs>

## Удаление балансировщика нагрузки

<tabs>
<tablist>
<tab>Личный кабинет</tab>
</tablist>
<tabpanel>

Это групповая операция: при необходимости можно удалить сразу несколько балансировщиков нагрузки, выбрав их с помощью флажков.

Для удаления балансировщика:

1. Перейдите в [личный кабинет](https://mcs.mail.ru/app/) VK Cloud.
1. Выберите проект и регион, где находится нужный балансировщик.
1. Перейдите в раздел **Виртуальные сети** → **Балансировщики нагрузки**.
1. Выполните одно из действий для нужного балансировщика:

   - Выберите с помощью флажка балансировщик, затем нажмите кнопку **Удалить**.
   - Раскройте меню балансировщика и выберите пункт **Удалить балансировщик**.

1. Подтвердите удаление балансировщика.

</tabpanel>
</tabs>
