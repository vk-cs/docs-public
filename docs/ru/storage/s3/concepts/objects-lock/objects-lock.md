## Принцип неизменяемого хранения данных 

Принцип неизменяемого хранения данных — модель WORM (Write-Once-Read-Many, «однократная запись, многократное чтение») — фундаментальная концепция в области управления информацией. Эта модель гарантирует, что после записи данные не могут быть изменены или удалены в течение определенного периода.

Современные бизнес-процессы и технические требования выдвигают три ключевых задачи для внедрения неизменяемого хранения:

* Устойчивость к киберугрозам. В условиях роста атак вредоносных программ, которые шифруют или полностью уничтожают данные, неизменяемые резервные копии обеспечивают гарантированную точку восстановления из нескомпрометированного состояния.
* Целостность данных и защита от ошибок. Неизменяемость защищает критически важную информацию от случайного удаления или повреждения, вызванного человеческим фактором или программными сбоями.
* Соблюдение нормативных требований. Многие отрасли подчиняются строгим законодательным нормам, требующим хранения данных в неизменяемом виде в течение установленных сроков для обеспечения аудита и юридической значимости.

Cloud Storage — объектное хранилище, совместимое с S3 API — поддерживает функцию блокировки объектов (Object Lock) для реализации модели WORM. Она позволяет эффективно решать перечисленные задачи, обеспечивая высокий уровень защиты и соответствия требованиям.

## Архитектурные основы Object Lock

### Обзор архитектуры Cloud Storage

Cloud Storage — геораспределенная система, развернутая в нескольких центрах обработки данных (ЦОД) и работающая в режиме Active-Active. Такой подход гарантирует высокую доступность сервиса даже при отказе одного из ЦОД.

Надежность хранения данных обеспечена за счет репликации. По умолчанию используется коэффициент репликации, равный двум. Это означает хранение каждого объекта в двух экземплярах. Каждая копия размещается на отдельном физическом сервере и отдельном диске, что защищает данные от аппаратных сбоев.

### Метаданные в Cloud Storage

В Cloud Storage слой хранения метаданных отделен от слоя хранения самих объектов. Для управления метаданными используется высокопроизводительная In-Memory СУБД Tarantool. В распределенном кластере Tarantool хранятся все метаданные Cloud Storage: информация о проектах, бакетах и объектах, включая их атрибуты, такие как списки контроля доступа (ACL) и политики жизненного цикла.

Использование подхода In-Memory для метаданных обеспечивает высокую скорость выполнения операций, таких как листинг объектов, проверка прав доступа и проверка статуса блокировки.

### Реализация блокировки объекта

Параметры блокировки объекта — режим блокировки, временная метка окончания блокировки и флаг бессрочной блокировки — реализованы в виде дополнительных атомарных атрибутов в записи метаданных объекта, хранящейся в кластере Tarantool.

Когда пользователь инициирует операцию удаления или перезаписи объекта, запрос сначала обрабатывается на уровне S3-шлюзов, которые обращаются к слою метаданных Tarantool. Система проверяет атрибуты блокировки перед тем, как дать команду на изменение данных на физическом уровне хранения. Если блокировка активна и у пользователя нет прав на ее обход, операция отклоняется на уровне метаданных. Это эффективно и надежно предотвращает любые модификации защищенного объекта.

### Связь между версионированием и блокировкой объектов

Для блокировки объектов необходимо, чтобы для бакета было включено версионирование.

Блокировка применяется не к ключу объекта в целом, а к его конкретной версии. Заблокированная версия объекта остается неизменной, но при этом можно загрузить новую версию с тем же ключом. Старая, защищенная версия не перезаписывается, а сохраняется в истории версий, обеспечивая полный и аудируемый жизненный цикл данных.

## Ключевые концепции

Cloud Storage поддерживает два типа блокировки: временная (Retention Period) и бессрочная (Legal Hold). Эти типы могут применяться как по отдельности, так и совместно для одного объекта, обеспечивая гибкие сценарии защиты.

{note:warn}

Блокировка может устанавливаться только для объектов в бакетах, созданных с [явным указанием](/ru/storage/s3/instructions/buckets/create-bucket#ways_to_create_bucket) такой возможности.

{/note}

### {heading(Временная блокировка)[id=temporary_lock]}

Временная блокировка (retention period) действует фиксированный период времени. Поддерживаются два режима временной блокировки: управляемый режим (`GOVERNANCE`) и строгий режим (`COMPLIANCE`).

В обоих режимах:

- Объект не может быть удален до истечения установленного срока.
- Срок блокировки не может быть сокращен, только увеличен.

#### {heading(Управляемый режим временной блокировки)[id=governance-lock]}

Управляемый режим блокировки (`GOVERNANCE`) защищает объекты от перезаписи и удаления в течение заданного периода.

В режиме `GOVERNANCE` пользователь, обладающий [правами на запись WRITE](/ru/storage/s3/instructions/access-management/s3-acl#permissons), может обойти блокировку:

- удалить объект до истечения установленного срока;
- сократить срок блокировки;
- изменить режим на `COMPLIANCE`.

Управляемый режим подходит для реализации внутренних политик защиты данных. Он предотвращает случайное удаление критических файлов разработчиками или автоматизированными скриптами, но оставляет возможность администраторам выполнять необходимые операции по управлению данными.

#### {heading(Строгий режим временной блокировки)[id=compliance-lock]}

Строгий режим блокировки (`COMPLIANCE`) обеспечивает максимальный уровень защиты. Заблокированная в этом режиме версия объекта не может быть перезаписана или удалена ни одним пользователем, включая администратора проекта, до истечения срока хранения.

Строгий режим подходит для выполнения строгих нормативных и законодательных требований (например, 152-ФЗ), где неизменяемость данных должна быть гарантирована на техническом и процедурном уровне.

### {heading(Бессрочная блокировка)[id=legal-hold-lock]}

Бессрочная блокировка (legal hold) предоставляет такую же WORM-защиту, как и временная блокировка, но не имеет срока истечения. Она действует независимо от установленного периода временной блокировки.

Бессрочная блокировка действует, пока не будет снята явно. Такую блокировку может в любой момент применить к объекту или снять с объекта пользователь, обладающий [правами на запись WRITE](/ru/storage/s3/instructions/access-management/s3-acl#permissons).

Бессрочная блокировка применяется в ситуациях с неопределенным сроком хранения данных, таких как судебные разбирательства, внутренние аудиты или расследования. Данные остаются защищенными до завершения соответствующего процесса, после чего блокировка может быть снята.

### Сравнение типов блокировки

[cols="1,1,1,1"]
|===
.2+|**Характеристика**
2+|**Временная блокировка**
.2+|**Legal Hold**

|**Режим GOVERNANCE**
|**Режим COMPLIANCE**

|Тип защиты
|Временная (заданный период)
|Временная (заданный период)
|Бессрочная (явное снятие)

|Возможность обхода или снятия
|Да (при наличии прав)
|Нет
|Да (при наличии прав)

|Изменение срока удержания
|Можно изменить (при наличии прав)
|Можно только продлить
|Неприменимо

|Основной сценарий
|Защита от случайных удалений, внутренние политики
|Строгое нормативное соответствие (`COMPLIANCE`)
|Судебные и аудиторские требования
|===